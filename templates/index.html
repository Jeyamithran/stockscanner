<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Black Box Scanner | Pro Personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    /* Theme tokens (same structure) */
    :root {
      --bg-dark: #020617;
      --bg-elevated-dark: #0b1220;
      --bg-card-dark: #0a1020;
      --border-subtle-dark: #1f2937;
      --accent-dark: #38bdf8;
      --accent-soft-dark: rgba(56, 189, 248, 0.16);
      --accent-strong-dark: #22d3ee;
      --text-primary-dark: #f9fafb;
      --text-secondary-dark: #e5e7eb;
      --text-muted-dark: #9ca3af;
      --text-soft-dark: #94a3b8;
      --danger-dark: #f97373;
      --success-dark: #4ade80;
      --warning-dark: #fbbf24;

      --bg-light: #f6f7fb;
      --bg-elevated-light: #ffffff;
      --bg-card-light: #ffffff;
      --border-subtle-light: #e5e7eb;
      --accent-light: #2563eb;
      --accent-soft-light: rgba(37, 99, 235, 0.10);
      --accent-strong-light: #1d4ed8;
      --text-primary-light: #0b1220;
      --text-secondary-light: #0b1220;
      --text-muted-light: #475569;
      --text-soft-light: #64748b;
      --danger-light: #b91c1c;
      --success-light: #15803d;
      --warning-light: #b45309;
    }

    body.theme-dark{
      --bg: var(--bg-dark);
      --bg-elevated: var(--bg-elevated-dark);
      --bg-card: var(--bg-card-dark);
      --border-subtle: var(--border-subtle-dark);
      --accent: var(--accent-dark);
      --accent-soft: var(--accent-soft-dark);
      --accent-strong: var(--accent-strong-dark);
      --text-primary: var(--text-primary-dark);
      --text-secondary: var(--text-secondary-dark);
      --text-muted: var(--text-muted-dark);
      --text-soft: var(--text-soft-dark);
      --danger: var(--danger-dark);
      --success: var(--success-dark);
      --warning: var(--warning-dark);
      background:
        radial-gradient(circle at 10% -10%, #0f172a 0, #020617 40%, #000 100%),
        var(--bg);
      color: var(--text-primary);
    }

    body.theme-light{
      --bg: var(--bg-light);
      --bg-elevated: var(--bg-elevated-light);
      --bg-card: var(--bg-card-light);
      --border-subtle: var(--border-subtle-light);
      --accent: var(--accent-light);
      --accent-soft: var(--accent-soft-light);
      --accent-strong: var(--accent-strong-light);
      --text-primary: var(--text-primary-light);
      --text-secondary: var(--text-secondary-light);
      --text-muted: var(--text-muted-light);
      --text-soft: var(--text-soft-light);
      --danger: var(--danger-light);
      --success: var(--success-light);
      --warning: var(--warning-light);
      background: linear-gradient(180deg, #ffffff, var(--bg));
      color: var(--text-primary);
    }

    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size: 17px; /* bigger base */
      line-height: 1.55;
      min-height: 100vh;
    }
    @media (max-width: 768px){
      body{ font-size: 16px; }
    }

    .app-shell{ max-width:1280px; margin:0 auto; padding:1.25rem 1rem 2rem; }

    .bbx-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin-bottom:.75rem; }
    .bbx-title{ font-size:2.1rem; font-weight:800; letter-spacing:.02em; color:var(--text-secondary); }
    .bbx-subtitle{ font-size:.95rem; color:var(--text-soft); }
    .bbx-badge{ font-size:.85rem; letter-spacing:.08em; text-transform:uppercase; font-weight:700; border-radius:999px; padding:.4rem .85rem; background:linear-gradient(135deg,#f97316,#ef4444); color:#fff; }

    .header-right{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .time-pill{ font-size:.85rem; padding:.25rem .6rem; border-radius:999px; border:1px solid var(--border-subtle); color:var(--text-soft); background:var(--bg-elevated); }

    .theme-btn{ border:1px solid var(--border-subtle); background:var(--bg-elevated); color:var(--text-soft); border-radius:999px; padding:.35rem .8rem; font-size:.9rem; }

    .bbx-tabs{ display:inline-flex; border:1px solid var(--border-subtle); border-radius:999px; padding:.25rem; background:var(--bg-elevated); margin-bottom:1rem; }
    .bbx-tab-btn{ border:none; background:transparent; color:var(--text-soft); padding:.4rem 1rem; border-radius:999px; font-weight:600; }
    .bbx-tab-btn.active{ background:var(--accent-soft); color:var(--accent-strong); }

    .profile-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin-bottom:1rem; }
    .profile-pills{ display:inline-flex; gap:.4rem; border:1px solid var(--border-subtle); border-radius:999px; padding:.25rem; background:var(--bg-elevated); }
    .profile-pill{ border:none; background:transparent; color:var(--text-soft); border-radius:999px; padding:.45rem .95rem; font-weight:600; }
    .profile-pill.active{ background:var(--accent-soft); color:var(--accent-strong); }
    .run-btn{ border:none; border-radius:999px; padding:.6rem 1.3rem; font-weight:700; background:linear-gradient(135deg,#22c55e,#4ade80); color:#081018; }

    .scanner-card{ background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:1rem; padding:1rem; height:100%; }
    .scanner-card-title{ font-size:1rem; font-weight:700; color:var(--text-secondary); }
    .scanner-chip{ font-size:.75rem; border:1px solid var(--border-subtle); color:var(--text-soft); padding:.1rem .5rem; border-radius:999px; }
    .scanner-table{ width:100%; border-collapse:collapse; }
    .scanner-table thead th{ font-size:.78rem; letter-spacing:.1em; text-transform:uppercase; color:var(--text-soft); border-bottom:1px solid var(--border-subtle); padding-bottom:.35rem; }
    .scanner-table tbody td{ padding:.5rem .15rem; font-size:1rem; color:var(--text-secondary); }
    .scanner-empty{ color:var(--text-muted); padding:.4rem 0; }
    .scanner-ticker{ color:var(--accent-strong); font-weight:800; }
    .scanner-rt{ font-size:.8rem; color:var(--text-soft); }
    .scanner-gain{ color:var(--success); font-weight:800; }

    .analysis-shell{ background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:1rem; padding:1rem; }
    .analysis-title{ font-size:1.1rem; font-weight:800; color:var(--text-secondary); }
    .analysis-section-title{ font-size:1rem; font-weight:800; color:var(--text-secondary); }
    .analysis-bullets{ padding-left:1.1rem; }
    .analysis-value-main{ font-size:1.2rem; font-weight:800; }
    .analysis-value-gain{ font-size:1.2rem; font-weight:900; color:var(--success); }
    .analysis-value-stop{ font-size:1.1rem; font-weight:800; color:var(--danger); }
    .analysis-label{ font-size:.85rem; color:var(--text-soft); }

    .news-card{ background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:1rem; padding:1rem; }
    .news-card-title{ font-size:1rem; font-weight:800; color:var(--text-secondary); }
    .news-headline{ font-weight:700; color:var(--text-secondary); }
    .news-meta{ font-size:.85rem; color:var(--text-soft); }
    .topic-pill{ border:1px solid var(--border-subtle); background:var(--bg-elevated); color:var(--text-soft); border-radius:999px; padding:.25rem .7rem; margin:.1rem; }
    .topic-pill.active{ background:var(--accent-soft); color:var(--accent-strong); }
    .watchlist-chip{ background:var(--accent-soft); color:var(--accent-strong); border-radius:999px; padding:.2rem .6rem; font-size:.9rem; margin:.15rem .25rem .15rem 0; display:inline-flex; gap:.3rem; }
    .btn-xs{ padding:.15rem .5rem; font-size:.8rem; border-radius:999px; }
  </style>
</head>
<body class="theme-dark">
  <div class="app-shell">
    <!-- Header -->
    <div class="bbx-header">
      <div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="bbx-title">Black Box Scanner</div>
          <span class="bbx-badge">PRO PERSONAL</span>
        </div>
        <div class="bbx-subtitle">Hedge-fund style scanner + live news brain, for your own use.</div>
      </div>
      <div class="header-right">
        <span class="time-pill">Last scan: <span id="lastScanTime">Never</span></span>
        <span class="time-pill">News refresh: <span id="lastNewsTime">Never</span></span>
        <button id="themeToggle" class="theme-btn">Switch Theme</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bbx-tabs mb-3">
      <button class="bbx-tab-btn active" id="scannerTabBtn">Scanner</button>
      <button class="bbx-tab-btn" id="newsTabBtn">News &amp; AI</button>
    </div>

    <!-- Scanner tab -->
    <div id="scannerTab">
      <div class="profile-row">
        <div>
          <div class="text-muted" style="font-size:.9rem;">Profile:</div>
          <div class="profile-pills">
            <button class="profile-pill active" data-profile="hedge_fund">Hedge Fund</button>
            <button class="profile-pill" data-profile="pro_trader">Pro Trader</button>
            <button class="profile-pill" data-profile="catalyst">Catalyst Hunter</button>
          </div>
        </div>
        <button id="runScanBtn" class="run-btn">Run Scanner</button>
      </div>

      <div class="row g-3">
        <div class="col-lg-4 col-md-12">
          <div class="scanner-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="scanner-card-title">üî• SmallCap / High Beta</div>
              <span class="scanner-chip">Aggressive</span>
            </div>
            <table class="scanner-table">
              <thead><tr><th style="width:45%;">Ticker</th><th style="width:25%;">Entry</th><th style="width:30%;">Target (%)</th></tr></thead>
              <tbody id="SmallCap-table">
                <tr><td colspan="3" class="scanner-empty">No setups from scanner.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-lg-4 col-md-12">
          <div class="scanner-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="scanner-card-title">üü° MidCap / Liquidity Mix</div>
              <span class="scanner-chip">Balanced</span>
            </div>
            <table class="scanner-table">
              <thead><tr><th style="width:45%;">Ticker</th><th style="width:25%;">Entry</th><th style="width:30%;">Target (%)</th></tr></thead>
              <tbody id="MidCap-table">
                <tr><td colspan="3" class="scanner-empty">No setups from scanner.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-lg-4 col-md-12">
          <div class="scanner-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="scanner-card-title">üü¢ LargeCap / Institutional</div>
              <span class="scanner-chip">Steadier</span>
            </div>
            <table class="scanner-table">
              <thead><tr><th style="width:45%;">Ticker</th><th style="width:25%;">Entry</th><th style="width:30%;">Target (%)</th></tr></thead>
              <tbody id="LargeCap-table">
                <tr><td colspan="3" class="scanner-empty">No setups from scanner.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="analysis-shell mt-3" id="analysisShell">
        <div class="analysis-title mb-1">Selected Setup ‚Äî Trading Plan</div>
        <div class="text-muted">Run the scanner and click any row to load the full thesis.</div>
      </div>
    </div>

    <!-- News tab -->
    <div id="newsTab" style="display:none;">
      <div class="news-card mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-9">
            <label class="form-label mb-1" style="font-size:.9rem;">Watchlist (tickers or names)</label>
            <div class="d-flex gap-2">
              <input id="watchlistInput" class="form-control form-control-sm" placeholder="TSLA, Tesla, NVDA, etc"/>
              <button id="addWatchBtn" class="btn btn-sm btn-outline-info">Add</button>
            </div>
            <div id="watchlistChips" class="mt-1"></div>
          </div>
          <div class="col-md-3 text-md-end">
            <label class="form-label mb-1 d-block" style="font-size:.9rem;">News</label>
            <button id="refreshNewsBtn" class="btn btn-sm btn-outline-success">Refresh News</button>
          </div>
        </div>
      </div>

      <div class="mb-2">
        <div class="text-muted mb-1" style="font-size:.9rem;">Focus topics (optional)</div>
        <div id="topicBar">
          <button class="topic-pill" data-topic="ai">AI & Automation</button>
          <button class="topic-pill" data-topic="quantum">Quantum Computing</button>
          <button class="topic-pill" data-topic="bio">Biotech & HealthTech</button>
          <button class="topic-pill" data-topic="renewable">Renewable & Cleantech</button>
          <button class="topic-pill" data-topic="cyber">Cybersecurity & Cloud</button>
          <button class="topic-pill" data-topic="synbio">Synthetic Biology</button>
          <button class="topic-pill" data-topic="bci">BCI & Neurotech</button>
          <button class="topic-pill" data-topic="nuclear">Advanced Nuclear</button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-lg-7">
          <div class="news-card">
            <div class="news-card-title mb-1">üéØ Stock-Focused Headlines</div>
            <div class="text-muted mb-1" style="font-size:.9rem;">Watchlist + topics drive this list.</div>
            <div id="stockFocusList" class="mt-1">
              <div class="text-muted">No filtered headlines yet.</div>
            </div>
          </div>

          <div class="news-card">
            <div class="news-card-title mb-1">‚ö° Benzinga Stream</div>
            <div id="benzingaList"><div class="text-muted">Loading‚Ä¶</div></div>
          </div>

          <div class="news-card">
            <div class="news-card-title mb-1">üåç Macro & Market (Finnhub)</div>
            <div id="finnhubList"><div class="text-muted">Loading‚Ä¶</div></div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="news-card" id="newsAnalysisPanel">
            <div class="news-card-title mb-1">üß† AI Lens on News</div>
            <div class="text-muted">Click ‚ÄúAI Analysis‚Äù on any headline.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------------- Theme toggle (robust) ----------------
    const bodyEl = document.body;
    const themeBtn = document.getElementById('themeToggle');
    function getStoredTheme(){
      try { return localStorage.getItem('bbx-theme'); } catch { return null; }
    }
    function setStoredTheme(v){
      try { localStorage.setItem('bbx-theme', v); } catch {}
    }
    function applyTheme(mode){
      bodyEl.classList.toggle('theme-light', mode === 'light');
      bodyEl.classList.toggle('theme-dark', mode !== 'light');
    }
    const initial = getStoredTheme() || 'dark';
    applyTheme(initial);
    themeBtn.addEventListener('click', () => {
      const next = bodyEl.classList.contains('theme-dark') ? 'light' : 'dark';
      applyTheme(next);
      setStoredTheme(next);
    });

    // ---------------- Tabs ----------------
    const scannerTabBtn = document.getElementById("scannerTabBtn");
    const newsTabBtn = document.getElementById("newsTabBtn");
    const scannerTab = document.getElementById("scannerTab");
    const newsTab = document.getElementById("newsTab");

    scannerTabBtn.addEventListener("click", () => {
      scannerTabBtn.classList.add("active");
      newsTabBtn.classList.remove("active");
      scannerTab.style.display = "";
      newsTab.style.display = "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    newsTabBtn.addEventListener("click", () => {
      newsTabBtn.classList.add("active");
      scannerTabBtn.classList.remove("active");
      scannerTab.style.display = "none";
      newsTab.style.display = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // ---------------- Scanner ----------------
    const MARKET_CAPS = ["SmallCap","MidCap","LargeCap"];
    let currentProfile = "hedge_fund";
    let scannerData = { SmallCap:[], MidCap:[], LargeCap:[] };

    document.querySelectorAll(".profile-pill").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".profile-pill").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentProfile = btn.getAttribute("data-profile");
      });
    });

    const runScanBtn = document.getElementById("runScanBtn");
    const lastScanTimeEl = document.getElementById("lastScanTime");
    const analysisShell = document.getElementById("analysisShell");
    let currentActiveRow = null;

    async function fetchScan(){
      runScanBtn.disabled = true; runScanBtn.textContent = "Scanning‚Ä¶";
      try{
        const r = await fetch("/api/scan", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ profile: currentProfile })
        });
        const j = await r.json();
        if(!j.success){
          console.error("Scanner error:", j.error);
          alert("Scanner error: " + (j.error || "Unknown"));
          return;
        }
        scannerData = j.data || {SmallCap:[],MidCap:[],LargeCap:[]};
        displayScannerAlerts(scannerData);
        lastScanTimeEl.textContent = new Date().toLocaleTimeString();
      }catch(e){
        console.error(e);
        alert("Network or server error running scanner.");
      }finally{
        runScanBtn.disabled = false; runScanBtn.textContent = "Run Scanner";
      }
    }
    runScanBtn.addEventListener("click", fetchScan);

    function displayScannerAlerts(data){
      currentActiveRow = null;
      MARKET_CAPS.forEach(cap=>{
        const tbody = document.getElementById(cap+"-table");
        tbody.innerHTML = "";
        const alerts = data[cap] || [];
        if(!alerts.length){
          tbody.innerHTML = '<tr><td colspan="3" class="scanner-empty">No setups from scanner.</td></tr>';
          return;
        }
        alerts.forEach((alert,idx)=>{
          const tr = document.createElement("tr");
          tr.dataset.cap = cap; tr.dataset.index = idx;
          const ticker = (alert.Ticker||"").toString();
          const entry = alert.EntryPrice!=null ? Number(alert.EntryPrice) : null;
          const rt = alert.RealTimePrice!=null ? Number(alert.RealTimePrice) : null;
          const target = alert.TargetPrice!=null ? Number(alert.TargetPrice) : null;
          const gain = alert.PotentialGainPercent!=null ? Number(alert.PotentialGainPercent) : null;

          tr.innerHTML = `
            <td>
              <span class="scanner-ticker">${ticker}</span>
              ${rt!=null ? `<div class="scanner-rt">RT: $${rt.toFixed(2)}</div>` : ""}
            </td>
            <td>${entry!=null?`$${entry.toFixed(2)}`:"‚Äî"}</td>
            <td>${gain!=null?`<span class="scanner-gain">+${gain.toFixed(2)}%</span>`:"‚Äî"} ${target!=null?`<div class="scanner-rt">@ $${target.toFixed(2)}</div>`:""}</td>
          `;
          tr.addEventListener("click", ()=>{
            if(currentActiveRow) currentActiveRow.classList.remove("table-active");
            tr.classList.add("table-active");
            currentActiveRow = tr;
            showAnalysisCard(cap, idx);
          });
          tbody.appendChild(tr);
        });
      });
      // auto select first row
      for(const cap of MARKET_CAPS){
        const first = document.querySelector(`#${cap}-table tr`);
        if(first){ first.click(); break; }
      }
    }

    function showAnalysisCard(cap,index){
      const alert = (scannerData[cap]||[])[index];
      if(!alert){
        analysisShell.innerHTML = '<div class="text-muted">No analysis for this item.</div>';
        return;
      }
      const t = alert.Ticker||"";
      const entry = alert.EntryPrice!=null?Number(alert.EntryPrice):null;
      const rt = alert.RealTimePrice!=null?Number(alert.RealTimePrice):null;
      const target = alert.TargetPrice!=null?Number(alert.TargetPrice):null;
      const gain = alert.PotentialGainPercent!=null?Number(alert.PotentialGainPercent):null;
      const stop = alert.StopPrice!=null?Number(alert.StopPrice):null;

      let bullets = [];
      const raw = alert.DetailedAnalysis;
      if(Array.isArray(raw)) bullets = raw;
      else if(typeof raw === "string"){
        bullets = raw.split("\n").map(s=>s.replace(/^[-*]\s?/,"").trim()).filter(Boolean);
      }
      if(!bullets.length) bullets = ["No detailed thesis provided by AI. Treat as high-level idea only."];

      analysisShell.innerHTML = `
        <div class="analysis-title mb-2">${t} ‚Äî Trading Plan</div>
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="analysis-section-title mb-1">Trade Setup & Thesis <span class="badge bg-warning text-dark ms-1" style="font-size:.75rem;">WHY NOW?</span></div>
            <ul class="analysis-bullets">
              ${bullets.map(b=>`<li>${b}</li>`).join("")}
            </ul>
            <div class="mt-2"><span class="analysis-label">Primary Catalyst:</span> ${alert.PrimaryCatalyst || "None / purely technical"}</div>
          </div>
          <div class="col-lg-5">
            <div class="analysis-section-title mb-2">Actionable Strategy <span class="badge bg-info text-dark ms-1" style="font-size:.75rem;">THE PLAN</span></div>
            <div class="mb-2"><div class="analysis-label">Entry</div><div class="analysis-value-main">${entry!=null?`$${entry.toFixed(2)}`:"‚Äî"}</div>${rt!=null?`<div class="text-muted">(RT: $${rt.toFixed(2)})</div>`:""}</div>
            <div class="mb-2"><div class="analysis-label">Target</div><div class="analysis-value-main">${target!=null?`$${target.toFixed(2)}`:"‚Äî"}</div></div>
            <div class="mb-2"><div class="analysis-label">Potential Gain</div><div class="analysis-value-gain">${gain!=null?`${gain.toFixed(2)}%`:"‚Äî"}</div></div>
            <div class="mb-2"><div class="analysis-label">Stop Loss</div><div class="analysis-value-stop">${stop!=null?`$${stop.toFixed(2)}`:"‚Äî"}</div></div>
            <div class="text-muted" style="font-size:.9rem;">Always sanity-check liquidity, spreads, and risk. Not financial advice.</div>
          </div>
        </div>
      `;
    }

    // ---------------- News & AI ----------------
    const lastNewsTimeEl = document.getElementById("lastNewsTime");
    const refreshNewsBtn = document.getElementById("refreshNewsBtn");
    const stockFocusList = document.getElementById("stockFocusList");
    const benzingaList = document.getElementById("benzingaList");
    const finnhubList = document.getElementById("finnhubList");
    const newsAnalysisPanel = document.getElementById("newsAnalysisPanel");

    let allNews = [];
    let watchlist = [];
    const activeTopics = new Set();
    const topicKeywords = {
      ai:["ai","artificial intelligence","machine learning","llm","gen ai"],
      quantum:["quantum","qubit"],
      bio:["biotech","biotechnology","drug","fda","trial","phase 3","healthtech"],
      renewable:["solar","wind","renewable","clean energy","ev","hydrogen"],
      cyber:["cybersecurity","ransomware","cloud","breach","security"],
      synbio:["synthetic biology","crispr","gene editing"],
      bci:["brain-computer","bci","neuralink","neurotech"],
      nuclear:["nuclear","fusion","fission","reactor","uranium"]
    };
    const nameToTicker = {
      tesla:"TSLA","elon musk":"TSLA","nvidia":"NVDA","nvda":"NVDA",
      apple:"AAPL", microsoft:"MSFT", meta:"META", facebook:"META",
      google:"GOOGL", alphabet:"GOOGL", amazon:"AMZN", palantir:"PLTR",
      soundhound:"SOUN", "johnson & johnson":"JNJ", "johnson and johnson":"JNJ"
    };

    async function fetchNews(){
      try{
        const r = await fetch("/api/news/headlines?limit=80");
        const j = await r.json();
        if(!j.success){ console.error(j.errors); return; }
        allNews = j.data || [];
        lastNewsTimeEl.textContent = new Date().toLocaleTimeString();
        renderNewsLists();
      }catch(e){ console.error(e); }
    }
    refreshNewsBtn.addEventListener("click", fetchNews);

    function normalize(s){ return (s||"").toString().toLowerCase(); }

    function renderNewsLists(){
      if(!allNews.length){
        stockFocusList.innerHTML = '<div class="text-muted">No news loaded yet.</div>';
        benzingaList.innerHTML = '<div class="text-muted">No news loaded yet.</div>';
        finnhubList.innerHTML = '<div class="text-muted">No news loaded yet.</div>';
        return;
      }
      const wlUp = watchlist.map(w=>w.toUpperCase());
      const wlLow = watchlist.map(w=>w.toLowerCase());
      const stockFocus = [], benz = [], finn = [];

      allNews.forEach((article, idx)=>{
        const src = (article.source || article.provider || "").toLowerCase();
        if(src.includes("benzinga")) benz.push({article, idx});
        else finn.push({article, idx}); // everything else to 'macro' bucket

        const text = `${normalize(article.headline)} ${normalize(article.summary)}`;
        const tickers = (article.tickers||[]).map(t=>t.toUpperCase());

        let wlHit = false;
        if(wlUp.length){
          wlHit = tickers.some(t=>wlUp.includes(t));
          if(!wlHit){
            wlLow.forEach(name=>{
              if(wlHit) return;
              const map = nameToTicker[name];
              if(map && tickers.includes(map)) wlHit = true;
              else if(text.includes(name)) wlHit = true;
            });
          }
        }

        let topicHit = false;
        if(activeTopics.size){
          for(const k of activeTopics){
            const kws = topicKeywords[k]||[];
            if(kws.some(word=>text.includes(word))){ topicHit = true; break; }
          }
        }

        if((wlUp.length || activeTopics.size) && (wlHit || topicHit)){
          stockFocus.push({article, idx});
        }
      });

      stockFocusList.innerHTML = stockFocus.length ? buildNewsListHTML(stockFocus) : '<div class="text-muted">No filtered headlines for current watchlist/topics.</div>';
      benzingaList.innerHTML = benz.length ? buildNewsListHTML(benz) : '<div class="text-muted">No Benzinga items yet.</div>';
      finnhubList.innerHTML = finn.length ? buildNewsListHTML(finn) : '<div class="text-muted">No macro items yet.</div>';
    }

    function buildNewsListHTML(items){
      return items.map(({article, idx})=>{
        const time = article.published_ts ? new Date(article.published_ts*1000).toLocaleTimeString() : "";
        const tickers = (article.tickers||[]).join(", ");
        const src = article.source || article.provider || "News";
        return `
          <div class="py-2 border-bottom border-0">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <div class="news-headline">${article.headline||""}</div>
                <div class="news-meta">${src} ‚Ä¢ ${time} ${tickers?`‚Ä¢ ${tickers}`:""}</div>
              </div>
              <div class="text-end">
                <button class="btn btn-outline-info btn-xs" data-action="analyze" data-index="${idx}">AI Analysis</button>
                ${article.url?`<div class="mt-1"><a href="${article.url}" target="_blank" class="news-meta">Open</a></div>`:""}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action='analyze']");
      if(!btn) return;
      const idx = Number(btn.getAttribute("data-index"));
      if(Number.isNaN(idx) || !allNews[idx]) return;
      analyzeNewsArticle(allNews[idx]);
    });

    async function analyzeNewsArticle(article){
      newsAnalysisPanel.innerHTML = `
        <div class="news-card-title mb-1">üß† AI Lens on News</div>
        <div class="text-muted">Analyzing‚Ä¶</div>`;
      try{
        const symbol = (article.tickers||[])[0] || null;
        const r = await fetch("/api/news/analysis", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ article, symbol })
        });
        const j = await r.json();
        if(!j.success){
          newsAnalysisPanel.innerHTML = `<div class="text-danger">AI analysis failed: ${j.error||"Unknown"}.</div>`;
          return;
        }
        const d = j.data || {};
        const stance = (d.stance||"neutral").toUpperCase();
        const impact = d.impact_level || "medium";
        const bullets = (d.rationale||[]).map(x=>`<li>${x}</li>`).join("");

        const stanceColor = stance==="BULLISH" ? "var(--success)" : stance==="BEARISH" ? "var(--danger)" : "var(--warning)";

        newsAnalysisPanel.innerHTML = `
          <div class="news-card-title mb-1">${article.headline||""}</div>
          <div class="news-meta mb-2">Stance: <span style="color:${stanceColor};font-weight:800;">${stance}</span> ‚Ä¢ Impact: <span style="text-transform:capitalize;">${impact}</span></div>
          <div class="mb-2">${d.summary || article.summary || ""}</div>
          ${bullets?`<div class="mb-2"><div class="analysis-section-title" style="font-size:1rem;">Why it matters</div><ul class="analysis-bullets">${bullets}</ul></div>`:""}
          <div class="text-muted" style="font-size:.9rem;">${d.risk_notes||""}</div>
          <div class="text-muted" style="font-size:.8rem;">${d.disclaimer||""}</div>
        `;
      }catch(e){
        console.error(e);
        newsAnalysisPanel.innerHTML = `<div class="text-danger">Analysis failed due to a network or server error.</div>`;
      }
    }

    // Watchlist UI
    const watchlistInput = document.getElementById("watchlistInput");
    const addWatchBtn = document.getElementById("addWatchBtn");
    const watchlistChips = document.getElementById("watchlistChips");

    function addWatchItem(raw){
      const v = (raw||"").trim();
      if(!v) return;
      if(!watchlist.includes(v)) watchlist.push(v);
      renderWatchlistChips(); renderNewsLists();
    }
    function removeWatchItem(v){
      watchlist = watchlist.filter(x=>x!==v);
      renderWatchlistChips(); renderNewsLists();
    }
    function renderWatchlistChips(){
      if(!watchlist.length){
        watchlistChips.innerHTML = '<span class="text-muted">No watchlist yet.</span>';
        return;
      }
      watchlistChips.innerHTML = watchlist.map(w=>`
        <span class="watchlist-chip">${w}
          <button class="btn btn-link p-0 m-0 text-decoration-none" data-remove="${w}" title="Remove">&times;</button>
        </span>`).join("");
    }
    addWatchBtn.addEventListener("click", ()=>{ addWatchItem(watchlistInput.value); watchlistInput.value = ""; });
    watchlistInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addWatchItem(watchlistInput.value); watchlistInput.value=""; }});
    watchlistChips.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-remove]");
      if(!btn) return;
      removeWatchItem(btn.getAttribute("data-remove"));
    });

    // Topic pills
    const topicBar = document.getElementById("topicBar");
    topicBar.addEventListener("click", (e)=>{
      const pill = e.target.closest(".topic-pill");
      if(!pill) return;
      const key = pill.getAttribute("data-topic");
      if(activeTopics.has(key)){ activeTopics.delete(key); pill.classList.remove("active"); }
      else { activeTopics.add(key); pill.classList.add("active"); }
      renderNewsLists();
    });

    // Initial
    renderWatchlistChips();
    fetchNews();
  </script>
</body>
</html>
