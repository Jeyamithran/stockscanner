<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Box Scanner | Pro Trader Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --font-family-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

            /* Softer dark palette */
            --bs-body-bg: #020617;          /* slate-950 */
            --bs-body-color: #e5e7eb;      /* gray-200 */
            --bs-card-bg: #020617;
            --bs-card-inner-bg: #020617;
            --bs-border-color: #1f2937;    /* gray-800 */
            --text-data: #7dd3fc;          /* sky-300 */
            --text-gain: #4ade80;          /* green-400 */
            --text-muted-enhanced: #9ca3af;/* gray-400 */
        }

        body.light-mode {
            --bs-body-bg: #f3f4f6;
            --bs-body-color: #111827;
            --bs-card-bg: #ffffff;
            --bs-card-inner-bg: #f9fafb;
            --bs-border-color: #d1d5db;
            --text-data: #2563eb;
            --text-gain: #16a34a;
            --text-muted-enhanced: #6b7280;
        }

        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            font-family: var(--font-family-primary);
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
        }

        body.font-small { font-size: 12px; }
        body.font-large { font-size: 16px; }

        .dashboard-header {
            border-bottom: 1px solid var(--bs-border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .dashboard-header .lead {
            color: var(--text-muted-enhanced) !important;
            font-weight: 500;
        }

        .card {
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .card-body {
            background-color: var(--bs-card-inner-bg);
        }

        .table-dark thead th,
        .table-dark {
            border-color: var(--bs-border-color);
        }

        .table-dark tbody tr:hover {
            background-color: #0b1220;
            cursor: pointer;
        }

        .text-ticker { color: var(--text-data); font-weight: 600; }
        .text-gain-percent { color: var(--text-gain); font-weight: 600; }
        .text-muted { color: var(--text-muted-enhanced) !important; }

        .news-list-scroll {
            max-height: 350px;
            overflow-y: auto;
        }

        .badge-watchlist {
            cursor: pointer;
        }

        .news-header-watchlist {
            background: linear-gradient(135deg, #14532d, #15803d);
            color: #e5e7eb;
        }

        .news-header-stock {
            background: linear-gradient(135deg, #1f2937, #4b5563);
            color: #e5e7eb;
        }

        .news-header-benzinga {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #111827;
        }

        .news-header-finnhub {
            background: linear-gradient(135deg, #0ea5e9, #0369a1);
            color: #0f172a;
        }

        .scanner-header-small {
            background: linear-gradient(135deg, #7f1d1d, #b91c1c);
            color: #fee2e2;
        }

        .scanner-header-mid {
            background: linear-gradient(135deg, #92400e, #b45309);
            color: #fef3c7;
        }

        .scanner-header-large {
            background: linear-gradient(135deg, #064e3b, #059669);
            color: #d1fae5;
        }

        .ai-header {
            background: linear-gradient(135deg, #0f172a, #1f2937);
            color: #e5e7eb;
        }

        .analysis-focus {
            box-shadow: 0 0 0 1px #38bdf8, 0 0 16px rgba(56, 189, 248, 0.8);
            transition: box-shadow 0.3s ease-in-out;
        }

        @media (max-width: 992px) {
            .dashboard-header { text-align: left !important; }
            .dashboard-header h1 { font-size: 1.8rem; }
            .col-lg-3, .col-lg-4 { padding-bottom: 20px; }
        }
    </style>
</head>
<body class="dark-mode">

<div class="container-fluid p-3 p-md-4">
    <div class="dashboard-header d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="mb-0" style="color:#7dd3fc;">
                Black Box Scanner <span class="badge bg-danger">PRO LIVE</span>
            </h1>
            <p class="lead small mt-1 mb-0 d-none d-md-block">
                High-Velocity Breakout Scanner with AI-Enhanced News & Multi-Profile Modes.
            </p>
        </div>

        <div class="d-flex gap-3 align-items-center mt-2 mt-md-0">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeSwitch" checked>
                <label class="form-check-label" for="themeSwitch">Dark Mode</label>
            </div>
            <select id="fontSizeSelect"
                    class="form-select form-select-sm bg-dark text-white"
                    style="width: 120px;">
                <option value="font-small">Small Font</option>
                <option value="" selected>Medium Font</option>
                <option value="font-large">Large Font</option>
            </select>
            <button id="runScanBtn" class="btn btn-primary btn-sm px-4">
                Run Scanner
            </button>
        </div>
    </div>

    <p class="small text-muted mb-2" id="lastUpdated">Last Scan: Never</p>

    <!-- MAIN TABS -->
    <ul class="nav nav-tabs mt-2" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="news-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#news-tab"
                    type="button"
                    role="tab">
                News Feed
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="scanner-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#scanner-tab"
                    type="button"
                    role="tab">
                Black Box Scanner
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- NEWS TAB -->
        <div class="tab-pane fade show active"
             id="news-tab"
             role="tabpanel"
             aria-labelledby="news-tab-btn">

            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div class="small text-muted">
                    <strong>Watchlist mode:</strong> add/remove tickers; headlines auto-filter.
                </div>
                <button id="newsRefreshBtn" class="btn btn-sm btn-outline-light">
                    Refresh All News
                </button>
            </div>

            <div class="d-flex flex-wrap align-items-center mb-3 gap-2">
                <span class="small text-muted">Topic filter:</span>
                <div class="btn-group btn-group-sm" role="group" id="topicFilterGroup">
                    <button type="button" class="btn btn-outline-secondary active" data-topic="all">All</button>
                    <button type="button" class="btn btn-outline-secondary" data-topic="ai">AI</button>
                    <button type="button" class="btn btn-outline-secondary" data-topic="tech">Tech</button>
                    <button type="button" class="btn btn-outline-secondary" data-topic="health">Health</button>
                    <button type="button" class="btn btn-outline-secondary" data-topic="finance">Finance</button>
                    <button type="button" class="btn btn-outline-secondary" data-topic="quantum">Quantum</button>
                </div>
            </div>

            <div class="row">
                <!-- Watchlist card -->
                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card">
                        <div class="card-header news-header-watchlist">
                            <h5 class="mb-0">Watchlist Headlines</h5>
                        </div>
                        <div class="card-body p-2">
                            <form id="watchlistForm" class="d-flex gap-2 mb-2">
                                <input type="text"
                                       id="watchlistInput"
                                       class="form-control form-control-sm"
                                       placeholder="Add ticker (e.g. NVDA)" />
                                <button class="btn btn-sm btn-outline-light" type="submit">
                                    Add
                                </button>
                            </form>
                            <div id="watchlistBadges" class="mb-2"></div>
                            <p class="small text-muted mb-1" id="newsStatusWatchlist">
                                Headlines that mention your watchlist tickers.
                            </p>
                            <div class="news-list-scroll">
                                <ul class="list-group list-group-flush" id="newsListWatchlist"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock-specific card -->
                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card">
                        <div class="card-header news-header-stock">
                            <h5 class="mb-0">Stock-Specific Headlines</h5>
                        </div>
                        <div class="card-body p-0">
                            <p class="small text-muted px-3 pt-2 mb-1" id="newsStatusStock">
                                Headlines that mention any tickers (filtered by topic).
                            </p>
                            <div class="news-list-scroll">
                                <ul class="list-group list-group-flush" id="newsListStock"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Benzinga card -->
                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card">
                        <div class="card-header news-header-benzinga">
                            <h5 class="mb-0">Benzinga â€“ News Feed</h5>
                        </div>
                        <div class="card-body p-0">
                            <p class="small text-muted px-3 pt-2 mb-1" id="newsStatusBenzinga">
                                Waiting for headlines...
                            </p>
                            <div class="news-list-scroll">
                                <ul class="list-group list-group-flush" id="newsListBenzinga"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finnhub card -->
                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card">
                        <div class="card-header news-header-finnhub">
                            <h5 class="mb-0">Finnhub â€“ General News</h5>
                        </div>
                        <div class="card-body p-0">
                            <p class="small text-muted px-3 pt-2 mb-1" id="newsStatusFinnhub">
                                Loading news...
                            </p>
                            <div class="news-list-scroll">
                                <ul class="list-group list-group-flush" id="newsListFinnhub"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI View -->
            <div class="row mt-2">
                <div class="col-12">
                    <div class="card" id="aiAnalysisCard">
                        <div class="card-header ai-header">
                            <h5 class="mb-0">AI View / Analyst Lens</h5>
                        </div>
                        <div class="card-body" id="newsAnalysisPanel">
                            <p class="text-muted mb-0">
                                Select any headline above and click <strong>AI Detail</strong> to see:
                                stance (bullish / bearish / mixed / neutral),
                                <strong>impact level</strong> (low / medium / high),
                                rationale, and risks. This is not investment advice.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /news-tab -->

        <!-- SCANNER TAB -->
        <div class="tab-pane fade"
             id="scanner-tab"
             role="tabpanel"
             aria-labelledby="scanner-tab-btn">

            <div class="card mb-3">
                <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                    <div>
                        <h5 class="mb-1">Scan Profile</h5>
                        <p class="small text-muted mb-0" id="scanProfileDescription">
                            Hedge Fund â€“ strict asymmetric R/R â‰¥ 2.5:1 with technical + catalyst filters.
                        </p>
                    </div>
                    <div class="btn-group btn-group-sm" id="scanProfileGroup" role="group">
                        <button type="button" class="btn btn-outline-light active" data-profile="hedge_fund">
                            Hedge Fund
                        </button>
                        <button type="button" class="btn btn-outline-light" data-profile="pro_trader">
                            Pro Trader
                        </button>
                        <button type="button" class="btn btn-outline-light" data-profile="catalyst">
                            News Catalyst
                        </button>
                    </div>
                </div>
            </div>

            <div id="scanner-alerts" class="row">
                <div class="col-lg-4 col-sm-12">
                    <div class="card">
                        <div class="card-header scanner-header-small">
                            <h5 class="mb-0">ðŸ”¥ Small Cap / High Beta</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="SmallCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            Awaiting Scan Data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-sm-12">
                    <div class="card">
                        <div class="card-header scanner-header-mid">
                            <h5 class="mb-0">ðŸŸ¡ Mid Cap / Liquidity Mix</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="MidCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            Awaiting Scan Data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-sm-12">
                    <div class="card">
                        <div class="card-header scanner-header-large">
                            <h5 class="mb-0">ðŸŸ¢ Large Cap / Institutional</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="LargeCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            Awaiting Scan Data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed analysis card -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div id="detailedAnalysisCard" class="p-4">
                            <p class="text-center text-muted mb-0">
                                Click any alert in the tables above to view the detailed analysis card and trading plan.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /scanner-tab -->
    </div> <!-- /tab-content -->
</div> <!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const MARKET_CAPS = ['SmallCap', 'MidCap', 'LargeCap'];
    const runScanBtn = document.getElementById('runScanBtn');
    const lastUpdated = document.getElementById('lastUpdated');
    const fontSizeSelect = document.getElementById('fontSizeSelect');
    const themeSwitch = document.getElementById('themeSwitch');

    const TOPIC_FILTERS = {
        all: [],
        ai: [' ai ', 'artificial intelligence', 'machine learning', 'ml', 'genai', 'chatgpt'],
        tech: [' tech', 'software', 'semiconductor', 'chip ', 'chips ', 'cloud', 'saas', 'database', 'datacenter', 'nvidia', 'microsoft'],
        health: ['health', 'healthcare', 'fda', 'drug', 'vaccine', 'biotech', 'pharma', 'clinical', 'trial'],
        finance: ['bank', 'financial', 'lender', 'broker', 'loan', 'credit', 'fed', 'interest rate', 'treasury'],
        quantum: ['quantum', 'qubit', 'qpu', 'quantum computing']
    };
    let currentTopic = 'all';

    const PROFILE_DESCRIPTIONS = {
        hedge_fund: "Hedge Fund â€“ strict asymmetric R/R â‰¥ 2.5:1 with technical + news/SEC catalysts.",
        pro_trader: "Pro Trader â€“ momentum & liquidity focus, R/R â‰¥ 2:1, more opportunistic swing setups.",
        catalyst: "News Catalyst â€“ strongest near-term catalysts: FDA approvals, SEC 8-K, major earnings shocks, M&A."
    };
    let currentScanProfile = 'hedge_fund';

    const scanProfileGroup = document.getElementById('scanProfileGroup');
    const scanProfileDescription = document.getElementById('scanProfileDescription');

    if (scanProfileGroup && scanProfileDescription) {
        scanProfileGroup.querySelectorAll('button[data-profile]').forEach(btn => {
            btn.addEventListener('click', () => {
                const profile = btn.getAttribute('data-profile') || 'hedge_fund';
                currentScanProfile = profile;
                scanProfileGroup.querySelectorAll('button[data-profile]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                scanProfileDescription.textContent =
                    PROFILE_DESCRIPTIONS[profile] || PROFILE_DESCRIPTIONS['hedge_fund'];
            });
        });
    }

    const WATCHLIST_STORAGE_KEY = 'bbx_watchlist';
    let watchlist = [];

    function loadWatchlist() {
        try {
            const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
            if (!raw) {
                watchlist = ['AAPL', 'NVDA', 'TSLA', 'JNJ'];
                return;
            }
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
                watchlist = parsed.map(x => String(x || '').toUpperCase()).filter(Boolean);
            } else {
                watchlist = ['AAPL', 'NVDA', 'TSLA', 'JNJ'];
            }
        } catch {
            watchlist = ['AAPL', 'NVDA', 'TSLA', 'JNJ'];
        }
    }

    function saveWatchlist() {
        localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify(watchlist));
    }

    function renderWatchlistBadges() {
        const container = document.getElementById('watchlistBadges');
        if (!container) return;

        container.innerHTML = '';
        if (!watchlist.length) {
            container.innerHTML = '<span class="small text-muted">Watchlist empty. Add tickers above.</span>';
            return;
        }

        watchlist.forEach(ticker => {
            const span = document.createElement('span');
            span.className = 'badge bg-transparent border border-success text-success badge-watchlist me-1 mb-1';
            span.innerHTML = `
                ${ticker}
                <span class="ms-1 text-danger fw-bold" data-remove="${ticker}">&times;</span>
            `;
            container.appendChild(span);

            const removeSpan = span.querySelector('[data-remove]');
            removeSpan.addEventListener('click', () => {
                removeFromWatchlist(ticker);
            });
        });
    }

    function addToWatchlist(symbol) {
        const sym = (symbol || '').toUpperCase().trim();
        if (!sym) return;
        if (!/^[A-Z0-9.\-]{1,10}$/.test(sym)) return;
        if (watchlist.includes(sym)) return;
        watchlist.push(sym);
        saveWatchlist();
        renderWatchlistBadges();
        renderAllNewsCards();
    }

    function removeFromWatchlist(symbol) {
        const sym = (symbol || '').toUpperCase().trim();
        watchlist = watchlist.filter(x => x !== sym);
        saveWatchlist();
        renderWatchlistBadges();
        renderAllNewsCards();
    }

    const watchlistForm = document.getElementById('watchlistForm');
    const watchlistInput = document.getElementById('watchlistInput');

    if (watchlistForm && watchlistInput) {
        watchlistForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const val = watchlistInput.value;
            addToWatchlist(val);
            watchlistInput.value = '';
        });
    }

    function applyTheme(isDark) {
        document.body.classList.toggle('light-mode', !isDark);
        document.body.classList.toggle('dark-mode', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        const element = fontSizeSelect;
        const darkClasses = 'bg-dark text-white';
        const lightClasses = 'bg-light text-dark';
        const allThemeClasses = (darkClasses + ' ' + lightClasses).split(' ');
        element.classList.remove(...allThemeClasses);
        if (isDark) {
            element.classList.add(...darkClasses.split(' '));
        } else {
            element.classList.add(...lightClasses.split(' '));
        }
    }

    function applyFontSize(sizeClass) {
        document.body.className = document.body.className.replace(/\bfont-(small|large)\b/g, '');
        if (sizeClass) {
            document.body.classList.add(sizeClass);
        }
        localStorage.setItem('fontSize', sizeClass);
    }

    const savedTheme = localStorage.getItem('theme') || 'dark';
    const savedFontSize = localStorage.getItem('fontSize') || '';

    if (savedTheme === 'light') {
        themeSwitch.checked = false;
        applyTheme(false);
    } else {
        themeSwitch.checked = true;
        applyTheme(true);
    }

    applyFontSize(savedFontSize);
    fontSizeSelect.value = savedFontSize;

    themeSwitch.addEventListener('change', () => applyTheme(themeSwitch.checked));
    fontSizeSelect.addEventListener('change', (e) => applyFontSize(e.target.value));

    const topicFilterGroup = document.getElementById('topicFilterGroup');
    if (topicFilterGroup) {
        topicFilterGroup.querySelectorAll('button[data-topic]').forEach(btn => {
            btn.addEventListener('click', () => {
                const topic = btn.getAttribute('data-topic');
                currentTopic = topic || 'all';
                topicFilterGroup.querySelectorAll('button[data-topic]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderAllNewsCards();
            });
        });
    }

    function passesTopicFilter(item) {
        if (!item) return false;
        if (currentTopic === 'all') return true;
        const keywords = TOPIC_FILTERS[currentTopic] || [];
        if (!keywords.length) return true;

        const text = (
            ' ' +
            (item.headline || '') + ' ' +
            (item.summary || '') + ' ' +
            (item.provider || '') + ' ' +
            (item.source || '') + ' ' +
            (Array.isArray(item.tickers) ? item.tickers.join(' ') : '')
        ).toLowerCase();

        return keywords.some(k => text.includes(k.toLowerCase()));
    }

    let allAlertData = {};
    let currentActiveRow = null;

    let latestNews = [];
    let newsById = {};

    const newsListFinnhub = document.getElementById('newsListFinnhub');
    const newsListBenzinga = document.getElementById('newsListBenzinga');
    const newsListStock = document.getElementById('newsListStock');
    const newsListWatchlist = document.getElementById('newsListWatchlist');

    const newsStatusFinnhub = document.getElementById('newsStatusFinnhub');
    const newsStatusBenzinga = document.getElementById('newsStatusBenzinga');
    const newsStatusStock = document.getElementById('newsStatusStock');
    const newsStatusWatchlist = document.getElementById('newsStatusWatchlist');
    const newsAnalysisPanel = document.getElementById('newsAnalysisPanel');
    const aiAnalysisCard = document.getElementById('aiAnalysisCard');
    const newsRefreshBtn = document.getElementById('newsRefreshBtn');

    function focusAnalysisPanel() {
        if (!aiAnalysisCard) return;
        aiAnalysisCard.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        aiAnalysisCard.classList.add('analysis-focus');
        setTimeout(() => {
            aiAnalysisCard.classList.remove('analysis-focus');
        }, 1500);
    }

    function classifySource(item) {
        const src = (item.source || '').toLowerCase();
        const provider = (item.provider || '').toLowerCase();
        const url = (item.url || '').toLowerCase();

        if (src.includes('benzinga') || provider.includes('benzinga') || url.includes('benzinga.com')) {
            return 'benzinga';
        }
        if (src.includes('finnhub')) {
            return 'finnhub';
        }
        if (provider) return 'finnhub';
        return 'unknown';
    }

    function normalizeTickers(t) {
        if (!Array.isArray(t)) return [];
        return t.map(x => (x || '').toUpperCase());
    }

    async function fetchNewsHeadlines() {
        if (newsStatusWatchlist) newsStatusWatchlist.textContent = 'Loading watchlist headlines...';
        if (newsStatusStock) newsStatusStock.textContent = 'Loading stock-specific headlines...';
        if (newsStatusBenzinga) newsStatusBenzinga.textContent = 'Loading Benzinga headlines...';
        if (newsStatusFinnhub) newsStatusFinnhub.textContent = 'Loading Finnhub headlines...';

        try {
            const res = await fetch('/api/news/headlines?limit=50');
            const json = await res.json();
            console.log('NEWS JSON:', json);

            if (!json.success) {
                throw new Error(json.error || 'News API error');
            }

            latestNews = json.data || [];
            newsById = {};
            latestNews.forEach(item => {
                if (item.id) {
                    newsById[item.id] = item;
                }
            });

            renderAllNewsCards();
        } catch (err) {
            console.error('News fetch error', err);
            if (newsStatusWatchlist) {
                newsStatusWatchlist.textContent = 'Failed to load news. Try again later.';
            }
        }
    }

    function renderAllNewsCards() {
        let finnhubItems  = latestNews.filter(n => classifySource(n) === 'finnhub');
        let benzingaItems = latestNews.filter(n => classifySource(n) === 'benzinga');
        let stockItems    = latestNews.filter(
            n => Array.isArray(n.tickers) && n.tickers.length > 0
        );

        let watchlistItems = latestNews.filter(n => {
            const t = normalizeTickers(n.tickers || []);
            if (!watchlist.length) return false;
            return t.some(x => watchlist.includes(x));
        });

        finnhubItems   = finnhubItems.filter(passesTopicFilter);
        benzingaItems  = benzingaItems.filter(passesTopicFilter);
        stockItems     = stockItems.filter(passesTopicFilter);
        watchlistItems = watchlistItems.filter(passesTopicFilter);

        renderNewsListToElement(
            watchlistItems,
            newsListWatchlist,
            newsStatusWatchlist,
            watchlist.length
                ? 'No watchlist headlines for this topic yet.'
                : 'Watchlist empty. Add tickers above.'
        );

        renderNewsListToElement(
            stockItems,
            newsListStock,
            newsStatusStock,
            'No stock-specific headlines detected for this topic.'
        );

        renderNewsListToElement(
            benzingaItems,
            newsListBenzinga,
            newsStatusBenzinga,
            'No Benzinga headlines for this topic.'
        );

        renderNewsListToElement(
            finnhubItems,
            newsListFinnhub,
            newsStatusFinnhub,
            'No Finnhub headlines for this topic.'
        );
    }

    function renderNewsListToElement(items, ulEl, statusEl, emptyText) {
        if (!ulEl) return;
        ulEl.innerHTML = '';
        if (!items.length) {
            if (statusEl) statusEl.textContent = emptyText;
            return;
        }
        if (statusEl) statusEl.textContent = '';

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 bg-transparent';

            const dt = new Date((item.published_ts || 0) * 1000);
            const timeStr = isNaN(dt.getTime()) ? '' : dt.toLocaleString();

            const tickerText = (item.tickers && item.tickers.length)
                ? item.tickers.slice(0, 4).join(', ')
                : '';

            const classified = classifySource(item);
            const isBenzinga = classified === 'benzinga';

            li.innerHTML = `
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge ${isBenzinga ? 'bg-warning text-dark' : 'bg-secondary'} me-2">
                            ${item.source || item.provider || 'News'}
                        </span>
                        ${tickerText ? `<span class="badge border border-light text-muted">${tickerText}</span>` : ''}
                    </div>
                    <a href="${item.url || '#'}" target="_blank" class="fw-semibold text-decoration-none">
                        ${item.headline}
                    </a>
                    <div class="small text-muted mt-1">${timeStr}</div>
                </div>
                <div class="d-flex flex-column align-items-end">
                    <button class="btn btn-sm btn-outline-info mb-1" data-id="${item.id}">
                        AI Detail
                    </button>
                </div>
            `;

            const btn = li.querySelector('button');
            btn.addEventListener('click', () => {
                handleNewsDetailClick(item.id);
            });

            ulEl.appendChild(li);
        });
    }

    async function handleNewsDetailClick(articleId) {
        const article = newsById[articleId];
        if (!article || !newsAnalysisPanel) return;

        newsAnalysisPanel.innerHTML = `
            <p class="text-muted mb-2">Thinking like a pro analystâ€¦</p>
            <div class="spinner-border spinner-border-sm" role="status"></div>
        `;

        focusAnalysisPanel();

        try {
            const res = await fetch('/api/news/analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: (article.tickers && article.tickers[0]) || null,
                    article: article
                })
            });
            const json = await res.json();
            if (!json.success) {
                throw new Error(json.error || 'AI analysis failed');
            }
            const data = json.data;
            renderNewsAnalysis(article, data);
            focusAnalysisPanel();
        } catch (err) {
            console.error('AI analysis error', err);
            newsAnalysisPanel.innerHTML = `
                <p class="text-danger mb-0">AI analysis failed. Please try again later.</p>
            `;
            focusAnalysisPanel();
        }
    }

    function renderNewsAnalysis(article, analysis) {
        if (!newsAnalysisPanel) return;
        const stance = (analysis.stance || 'neutral').toLowerCase();
        let stanceClass = 'bg-secondary';
        if (stance === 'bullish') stanceClass = 'bg-success';
        else if (stance === 'bearish') stanceClass = 'bg-danger';
        else if (stance === 'mixed') stanceClass = 'bg-warning text-dark';

        const impact = (analysis.impact_level || '').toLowerCase();
        let impactBadge = '';
        if (impact) {
            let impactClass = 'bg-secondary';
            if (impact === 'high') impactClass = 'bg-danger';
            else if (impact === 'medium') impactClass = 'bg-warning text-dark';
            else if (impact === 'low') impactClass = 'bg-success';
            impactBadge = `<span class="badge ${impactClass} ms-2 text-uppercase">Impact: ${impact}</span>`;
        }

        const rationaleList = (analysis.rationale || [])
            .map(p => `<li>${p}</li>`)
            .join('');

        newsAnalysisPanel.innerHTML = `
            <h6 class="text-info mb-1">${article.headline}</h6>
            <p class="small text-muted mb-2">
                Source: ${article.source || article.provider || 'News'}
                ${article.tickers && article.tickers.length ? ` | Tickers: ${article.tickers.join(', ')}` : ''}
            </p>
            <div class="mb-2">
                <span class="badge ${stanceClass} text-uppercase">${stance}</span>
                ${impactBadge}
            </div>
            <p class="mb-2">${analysis.summary || ''}</p>
            <h6 class="mt-3">Why this matters</h6>
            <ul class="mb-2">${rationaleList}</ul>
            <p class="small text-muted mb-0">${analysis.risk_notes || ''}</p>
            <p class="small text-muted mt-1">${analysis.disclaimer || ''}</p>
        `;
    }

    if (newsRefreshBtn) {
        newsRefreshBtn.addEventListener('click', fetchNewsHeadlines);
    }

    async function fetchData() {
        runScanBtn.textContent = 'Scanning...';
        runScanBtn.disabled = true;

        try {
            const response = await fetch('/api/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: currentScanProfile })
            });
            const result = await response.json();

            if (result.success) {
                allAlertData = result;
                displayAlerts(result);
                lastUpdated.textContent = `Last Scan: ${new Date().toLocaleTimeString()}`;
                if (result.warning) {
                    console.warn('Scanner warning:', result.warning);
                }
            } else {
                console.error("API Error:", result.error);
                alert(`Scanner Failed: ${result.error}`);
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            alert('A network or server error occurred. Check connection.');
        } finally {
            runScanBtn.textContent = 'Run Scanner';
            runScanBtn.disabled = false;
        }
    }

    function displayAlerts(fullResult) {
        const data = fullResult.data;
        MARKET_CAPS.forEach(cap => {
            const tableBody = document.getElementById(`${cap}-table`);
            tableBody.innerHTML = '';
            let alerts = data[cap] || [];

            if (!Array.isArray(alerts) || alerts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No high-probability setups detected.
                        </td>
                    </tr>`;
                return;
            }

            // Sort by PotentialGainPercent DESC (strongest on top) and cap at top 10
            alerts = alerts
                .slice()
                .sort((a, b) => {
                    const ga = parseFloat(a.PotentialGainPercent || 0);
                    const gb = parseFloat(b.PotentialGainPercent || 0);
                    return gb - ga;
                })
                .slice(0, 10);

            alerts.forEach(alert => {
                const row = document.createElement('tr');
                row.className = 'alert-row';
                row.setAttribute('data-cap', cap);
                row.setAttribute('data-ticker', alert.Ticker);

                row.onclick = function() {
                    if (currentActiveRow) {
                        currentActiveRow.classList.remove('active');
                    }
                    this.classList.add('active');
                    currentActiveRow = this;
                    showAnalysisCard(cap, alert.Ticker);
                };

                row.innerHTML = `
                    <td>
                        <strong class="text-ticker">${alert.Ticker}</strong>
                        <span class="badge ${
                            alert.PrimaryCatalyst &&
                            (alert.PrimaryCatalyst.toLowerCase().includes('sec filing') ||
                             alert.PrimaryCatalyst.toLowerCase().includes('news') ||
                             alert.PrimaryCatalyst.toLowerCase().includes('fda'))
                            ? 'bg-danger'
                            : 'bg-info'
                        }">
                            ${alert.PrimaryCatalyst ? 'CATALYST' : 'TECH'}
                        </span>
                    </td>
                    <td>$${parseFloat(alert.EntryPrice).toFixed(2)}</td>
                    <td>
                        <strong class="text-gain-percent">
                            +${parseFloat(alert.PotentialGainPercent).toFixed(2)}%
                        </strong>
                        <span class="text-muted small">
                            @$${parseFloat(alert.TargetPrice).toFixed(2)}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        });

        const firstCap = MARKET_CAPS.find(cap => data[cap] && data[cap].length > 0);
        if (firstCap) {
            const firstRow = document.querySelector(`#${firstCap}-table tr`);
            if (firstRow) firstRow.click();
        }
    }

    function showAnalysisCard(cap, ticker) {
        const analysisDiv = document.getElementById('detailedAnalysisCard');
        const alertData = allAlertData.data[cap];
        if (!alertData) return;

        const alert = alertData.find(a => a.Ticker === ticker);
        if (!alert) {
            analysisDiv.innerHTML = `
                <p class="text-center p-4 text-muted mb-0">
                    Analysis data not found.
                </p>`;
            return;
        }

        // Normalize DetailedAnalysis to a single string
        let detailRaw = alert.DetailedAnalysis;
        let detailString = "";

        if (typeof detailRaw === "string") {
            detailString = detailRaw;
        } else if (Array.isArray(detailRaw)) {
            detailString = detailRaw.join("\n");
        } else if (detailRaw && typeof detailRaw === "object") {
            if (Array.isArray(detailRaw.points)) {
                detailString = detailRaw.points.join("\n");
            } else {
                detailString = JSON.stringify(detailRaw, null, 2);
            }
        } else {
            detailString = "";
        }

        const analysisPoints = detailString
            .split("\n")
            .map(item => item.trim())
            .filter(item => item.length > 0)
            .map(item => {
                if (item.startsWith("*")) {
                    return `<li>${item.substring(1).trim()}</li>`;
                }
                return `<li>${item}</li>`;
            })
            .join("");

        analysisDiv.innerHTML = `
            <div class="card-header ai-header p-3">
                <h4 class="mb-0" style="color:#7dd3fc;">
                    ${alert.Ticker} - Trading Thesis & Action Plan
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 border-end border-secondary">
                        <h5>
                            Trade Setup & Thesis
                            <span class="badge bg-warning text-dark">WHY NOW?</span>
                        </h5>
                        <ul class="list-unstyled">
                            ${analysisPoints || '<li class="text-muted">No detailed bullets returned by the model.</li>'}
                        </ul>
                        <p class="mt-3">
                            <strong>Primary Catalyst:</strong>
                            <span class="text-light">${alert.PrimaryCatalyst}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h5>
                            Actionable Strategy
                            <span class="badge bg-primary">THE PLAN</span>
                        </h5>
                        <p class="mb-1">
                            <strong>Entry Trigger:</strong>
                            <span class="text-success fs-5">
                                $${parseFloat(alert.EntryPrice).toFixed(2)}
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Target Profit (Exit):</strong>
                            <span class="text-info fs-5">
                                $${parseFloat(alert.TargetPrice).toFixed(2)}
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Potential Gain:</strong>
                            <span class="text-gain-percent fs-4">
                                ${parseFloat(alert.PotentialGainPercent).toFixed(2)}%
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Maximum Stop Loss:</strong>
                            <span class="text-danger fs-5">
                                $${parseFloat(alert.StopPrice).toFixed(2)}
                            </span>
                        </p>
                        <small class="text-muted">
                            Tier: ${cap}. Calculated Risk/Reward is implicitly based on these levels.
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    loadWatchlist();
    renderWatchlistBadges();
    runScanBtn.addEventListener('click', fetchData);
    fetchNewsHeadlines();
</script>
</body>
</html>
