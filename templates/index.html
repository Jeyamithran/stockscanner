<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>Black Box Scanner | Pro Trader Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet">

  <style>
    :root {
      --font-family-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                             Helvetica, Arial, sans-serif, "Apple Color Emoji",
                             "Segoe UI Emoji", "Segoe UI Symbol";

      --bs-body-bg: #0b1020;
      --bs-body-color: #f4f6fb;
      --bs-card-bg: #14192a;
      --bs-border-color: #272c3f;

      --primary-accent: #5ba8ff;
      --secondary-accent: #60e5b0;

      --text-data: #7fc7ff;
      --text-gain: #4fd36a;
      --text-muted-enhanced: #8e95a5;
    }

    body.light-mode {
      --bs-body-bg: #f5f6fb;
      --bs-body-color: #23263a;
      --bs-card-bg: #ffffff;
      --bs-border-color: #ccd1e4;

      --primary-accent: #2f6edc;
      --secondary-accent: #1ba87e;

      --text-data: #0056c7;
      --text-gain: #148b3b;
      --text-muted-enhanced: #60657a;
    }

    body {
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
      font-family: var(--font-family-primary);
      transition: background-color 0.25s, color 0.25s;
      font-size: 14px;
    }

    body.font-small { font-size: 12px; }
    body.font-large { font-size: 16px; }

    .dashboard-header {
      border-bottom: 1px solid var(--bs-border-color);
      padding-bottom: 10px;
      margin-bottom: 12px;
    }

    .dashboard-header .lead {
      color: var(--text-muted-enhanced) !important;
      font-weight: 500;
    }

    .card {
      background-color: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
    }

    .table-dark,
    .table-dark thead th {
      border-color: var(--bs-border-color);
      background-color: #14192a;
    }

    .table-dark tbody tr:hover {
      background-color: #1b2134;
      cursor: pointer;
    }

    .text-ticker {
      color: var(--text-data);
      font-weight: 600;
    }

    .text-gain-percent {
      color: var(--text-gain);
      font-weight: 600;
    }

    .text-muted {
      color: var(--text-muted-enhanced) !important;
    }

    .nav-tabs .nav-link {
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted-enhanced);
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-accent);
      border-color: var(--primary-accent);
      background-color: transparent;
    }

    .nav-tabs {
      border-bottom-color: var(--bs-border-color);
    }

    .news-scroll {
      max-height: 420px;
      overflow-y: auto;
    }

    .news-scroll .list-group-item {
      border-left: none;
      border-right: none;
      border-radius: 0;
      background-color: transparent;
      color: inherit;
    }

    .news-scroll .list-group-item:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }

    .news-ticker-badge {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin-right: 4px;
    }

    .btn-xs {
      padding: 0.125rem 0.45rem;
      font-size: 0.7rem;
      border-radius: 0.25rem;
    }

    @media (max-width: 992px) {
      .dashboard-header {
        text-align: left !important;
      }

      .dashboard-header h1 {
        font-size: 1.7rem;
      }
    }
  </style>
</head>

<body class="dark-mode">

<div class="container-fluid p-3 p-md-4">
  <!-- HEADER -->
  <div class="dashboard-header d-flex justify-content-between align-items-center flex-wrap">
    <div>
      <h1 class="text-info mb-0">
        Black Box Scanner
        <span class="badge bg-danger">PRO LIVE</span>
      </h1>
      <p class="lead small mt-1 mb-0">
        High-Velocity Breakout Scanner & Catalyst Tape.
      </p>
      <p class="small text-muted mb-0" id="lastUpdated">Last Scan: Never</p>
    </div>

    <div class="d-flex gap-3 align-items-center mt-2 mt-md-0 flex-wrap">
      <!-- Theme switch -->
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="themeSwitch" checked>
        <label class="form-check-label small" for="themeSwitch">Dark Mode</label>
      </div>

      <!-- Font size -->
      <select id="fontSizeSelect"
              class="form-select form-select-sm bg-dark text-white"
              style="width: 120px;">
        <option value="font-small">Small Font</option>
        <option value="" selected>Medium Font</option>
        <option value="font-large">Large Font</option>
      </select>

      <!-- Run scanner -->
      <button id="runScanBtn" class="btn btn-primary btn-sm px-4">
        ‚ö° Run Scanner
      </button>
    </div>
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active"
              id="scanner-tab-button"
              data-bs-toggle="tab"
              data-bs-target="#scanner-tab"
              type="button"
              role="tab"
              aria-controls="scanner-tab"
              aria-selected="true">
        üìà Scanner
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="news-tab-button"
              data-bs-toggle="tab"
              data-bs-target="#news-tab"
              type="button"
              role="tab"
              aria-controls="news-tab"
              aria-selected="false">
        üì∞ News & AI Tape
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabContent">

    <!-- ===== SCANNER TAB (LANDING) ===== -->
    <div class="tab-pane fade show active"
         id="scanner-tab"
         role="tabpanel"
         aria-labelledby="scanner-tab-button">

      <div id="scanner-alerts" class="row g-3">
        <!-- SmallCap -->
        <div class="col-lg-4 col-sm-12">
          <div class="card h-100">
            <div class="card-header bg-danger text-white py-2">
              <h5 class="mb-0">üî• Small Cap / High Beta</h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Entry</th>
                  <th>Target (%)</th>
                </tr>
                </thead>
                <tbody id="SmallCap-table">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    Awaiting Scan Data...
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- MidCap -->
        <div class="col-lg-4 col-sm-12">
          <div class="card h-100">
            <div class="card-header bg-warning text-dark py-2">
              <h5 class="mb-0">üü° Mid Cap / Liquidity Mix</h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Entry</th>
                  <th>Target (%)</th>
                </tr>
                </thead>
                <tbody id="MidCap-table">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    Awaiting Scan Data...
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- LargeCap -->
        <div class="col-lg-4 col-sm-12">
          <div class="card h-100">
            <div class="card-header bg-success text-white py-2">
              <h5 class="mb-0">üü¢ Large Cap / Institutional</h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Entry</th>
                  <th>Target (%)</th>
                </tr>
                </thead>
                <tbody id="LargeCap-table">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    Awaiting Scan Data...
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Analysis Card -->
      <div class="row mt-3">
        <div class="col-12">
          <div class="card">
            <div id="detailedAnalysisCard" class="p-4">
              <p class="text-center text-muted mb-0">
                Click on any alert in the tables above to view the detailed analysis card and trading plan.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ===== NEWS TAB ===== -->
    <div class="tab-pane fade"
         id="news-tab"
         role="tabpanel"
         aria-labelledby="news-tab-button">

      <div class="container-fluid mt-3">

        <!-- Controls row: Watchlist + Topic Filter + Refresh -->
        <div class="card mb-3">
          <div class="card-body py-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <!-- Watchlist form -->
              <form id="watchlistForm" class="d-flex flex-wrap gap-2 align-items-center">
                <div class="input-group input-group-sm" style="max-width: 260px;">
                  <input id="watchlistInput"
                         type="text"
                         class="form-control"
                         placeholder="Add ticker (e.g. NVDA)">
                  <button class="btn btn-outline-primary" type="submit">Add</button>
                </div>
                <small class="text-muted">Watchlist: click ‚ùå to remove a ticker.</small>
              </form>

              <!-- Watchlist badges -->
              <div id="watchlistBadges" class="d-flex flex-wrap gap-1"></div>

              <!-- Topic dropdown & refresh -->
              <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
                <label for="topicFilterSelect"
                       class="form-label mb-0 small text-muted">Topic filter</label>
                <select id="topicFilterSelect"
                        class="form-select form-select-sm"
                        style="max-width: 260px;">
                  <option value="all">All topics</option>
                  <option value="ai">AI & Automation</option>
                  <option value="quantum">Quantum Computing (Emerging Tech)</option>
                  <option value="bio">Biotech & HealthTech</option>
                  <option value="renewable">Renewables & Cleantech</option>
                  <option value="cyber">Cybersecurity & Cloud</option>
                  <option value="synthetic_bio">Synthetic Biology</option>
                  <option value="neuro">BCI & Neurotechnology</option>
                  <option value="nuclear">Advanced Nuclear (Fission/Fusion)</option>
                </select>

                <button id="refreshNewsBtn"
                        class="btn btn-sm btn-outline-info">
                  üîÑ Refresh Headlines
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- News cards row -->
        <div class="row gy-3">
          <!-- Watchlist headlines -->
          <div class="col-xl-3 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">üéØ Watchlist Headlines</h6>
              </div>
              <div class="card-body p-0">
                <div id="watchlistNewsList"
                     class="list-group list-group-flush small news-scroll"></div>
              </div>
            </div>
          </div>

          <!-- Stock-specific catalysts -->
          <div class="col-xl-3 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-success text-white py-2">
                <h6 class="mb-0">üí• Stock-Specific Catalysts</h6>
              </div>
              <div class="card-body p-0">
                <div id="stockSpecificNewsList"
                     class="list-group list-group-flush small news-scroll"></div>
              </div>
            </div>
          </div>

          <!-- Benzinga -->
          <div class="col-xl-3 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark py-2">
                <h6 class="mb-0">üì∞ Benzinga Pro Feed</h6>
              </div>
              <div class="card-body p-0">
                <div id="benzingaNewsList"
                     class="list-group list-group-flush small news-scroll"></div>
              </div>
            </div>
          </div>

          <!-- Finnhub -->
          <div class="col-xl-3 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-secondary text-white py-2">
                <h6 class="mb-0">üåê Finnhub General & Macro</h6>
              </div>
              <div class="card-body p-0">
                <div id="finnhubNewsList"
                     class="list-group list-group-flush small news-scroll"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI News Analysis panel -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div id="newsAnalysisCard" class="p-3 small text-muted">
                Select a headline and click <strong>AI View</strong> to see analysis here.
              </div>
            </div>
          </div>
        </div>

      </div> <!-- container-fluid -->
    </div> <!-- news-tab -->

  </div> <!-- tab-content -->

</div> <!-- container-fluid -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // =================== THEME & FONT ===================
  const themeSwitch = document.getElementById('themeSwitch');
  const fontSizeSelect = document.getElementById('fontSizeSelect');

  function applyTheme(isDark) {
    document.body.classList.toggle('light-mode', !isDark);
    document.body.classList.toggle('dark-mode', isDark);
    localStorage.setItem('theme', isDark ? 'dark' : 'light');

    const element = fontSizeSelect;
    const darkClasses = 'bg-dark text-white';
    const lightClasses = 'bg-light text-dark';
    const allThemeClasses = (darkClasses + ' ' + lightClasses).split(' ');
    element.classList.remove(...allThemeClasses);
    if (isDark) {
      element.classList.add(...darkClasses.split(' '));
    } else {
      element.classList.add(...lightClasses.split(' '));
    }
  }

  function applyFontSize(sizeClass) {
    document.body.className = document.body.className.replace(/\bfont-(small|large)\b/g, '');
    if (sizeClass) {
      document.body.classList.add(sizeClass);
    }
    localStorage.setItem('fontSize', sizeClass);
  }

  const savedTheme = localStorage.getItem('theme') || 'dark';
  const savedFontSize = localStorage.getItem('fontSize') || '';

  if (savedTheme === 'light') {
    themeSwitch.checked = false;
    applyTheme(false);
  } else {
    themeSwitch.checked = true;
    applyTheme(true);
  }
  applyFontSize(savedFontSize);
  fontSizeSelect.value = savedFontSize;

  themeSwitch.addEventListener('change', () => applyTheme(themeSwitch.checked));
  fontSizeSelect.addEventListener('change', (e) => applyFontSize(e.target.value));


  // =================== SCANNER LOGIC ===================
  const MARKET_CAPS = ['SmallCap', 'MidCap', 'LargeCap'];
  const runScanBtn = document.getElementById('runScanBtn');
  const lastUpdated = document.getElementById('lastUpdated');

  let allAlertData = {};
  let currentActiveRow = null;

  async function fetchScanner(profile) {
    try {
      runScanBtn.textContent = 'Scanning...';
      runScanBtn.disabled = true;

      const resp = await fetch('/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profile })
      });

      const result = await resp.json();

      if (!result.success) {
        console.error('Scanner error:', result.error);
        alert(`Scanner Failed: ${result.error}`);
        return;
      }

      allAlertData = result;
      displayAlerts(result);
      lastUpdated.textContent = `Last Scan: ${new Date().toLocaleTimeString()}`;
    } catch (err) {
      console.error('Scanner fetch error:', err);
      alert('A network or server error occurred. Check connection.');
    } finally {
      runScanBtn.textContent = '‚ö° Run Scanner';
      runScanBtn.disabled = false;
    }
  }

  function displayAlerts(fullResult) {
    const data = fullResult.data;
    MARKET_CAPS.forEach(cap => {
      const tableBody = document.getElementById(`${cap}-table`);
      tableBody.innerHTML = '';
      const alerts = data[cap] || [];

      if (!alerts.length) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="3" class="text-center text-muted">
              No setups detected for this profile.
            </td>
          </tr>`;
        return;
      }

      alerts.forEach((alert) => {
        const row = document.createElement('tr');
        row.className = 'alert-row';
        row.setAttribute('data-cap', cap);
        row.setAttribute('data-ticker', alert.Ticker);

        row.onclick = function () {
          if (currentActiveRow) {
            currentActiveRow.classList.remove('table-active');
          }
          this.classList.add('table-active');
          currentActiveRow = this;
          showAnalysisCard(cap, alert.Ticker);
        };

        const entry = parseFloat(alert.EntryPrice);
        const target = parseFloat(alert.TargetPrice);
        const gainPct = parseFloat(alert.PotentialGainPercent);

        row.innerHTML = `
          <td>
            <strong class="text-ticker">${alert.Ticker}</strong>
            <span class="badge ${
              (alert.PrimaryCatalyst || '').toLowerCase().includes('sec') ||
              (alert.PrimaryCatalyst || '').toLowerCase().includes('fda') ||
              (alert.PrimaryCatalyst || '').toLowerCase().includes('earnings') ||
              (alert.PrimaryCatalyst || '').toLowerCase().includes('news')
                ? 'bg-danger'
                : 'bg-info'
            }">
              ${alert.PrimaryCatalyst ? 'CATALYST' : 'TECH'}
            </span>
          </td>
          <td>
            $${isNaN(entry) ? '‚Äî' : entry.toFixed(2)}
          </td>
          <td>
            <strong class="text-gain-percent">
              ${isNaN(gainPct) ? '‚Äî' : `+${gainPct.toFixed(2)}%`}
            </strong>
            <span class="text-muted small">
              @${isNaN(target) ? '‚Äî' : `$${target.toFixed(2)}`}
            </span>
          </td>
        `;
        tableBody.appendChild(row);
      });
    });

    // auto-select first alert if any
    const firstCap = MARKET_CAPS.find(cap => data[cap] && data[cap].length > 0);
    if (firstCap && data[firstCap].length > 0) {
      const firstRow = document.querySelector(`#${firstCap}-table tr`);
      if (firstRow) firstRow.click();
    }
  }

  function showAnalysisCard(cap, ticker) {
    const analysisDiv = document.getElementById('detailedAnalysisCard');
    const alertData = allAlertData.data[cap];
    if (!alertData) {
      analysisDiv.innerHTML = '<p class="text-center p-4 text-muted mb-0">No analysis available.</p>';
      return;
    }
    const alert = alertData.find(a => a.Ticker === ticker);
    if (!alert) {
      analysisDiv.innerHTML = '<p class="text-center p-4 text-muted mb-0">Analysis data not found.</p>';
      return;
    }

    const detailed = (alert.DetailedAnalysis || '').toString();
    const points = detailed
      .split('\n')
      .filter(line => line.trim())
      .map(line => line.replace(/^[\-\*\d\.\s]+/, '').trim());

    const bulletHTML = points.map(p => `<li>${p}</li>`).join('');

    const entry = parseFloat(alert.EntryPrice);
    const target = parseFloat(alert.TargetPrice);
    const stop = parseFloat(alert.StopPrice);
    const gainPct = parseFloat(alert.PotentialGainPercent);

    analysisDiv.innerHTML = `
      <div class="card-header bg-dark text-white p-3">
        <h4 class="mb-0 text-info">${alert.Ticker} - Trading Thesis & Action Plan</h4>
      </div>
      <div class="card-body p-4">
        <div class="row">
          <div class="col-md-6 border-end border-secondary">
            <h5>Trade Setup & Thesis <span class="badge bg-warning text-dark">WHY NOW?</span></h5>
            <ul class="list-unstyled">
              ${bulletHTML || '<li>No detailed thesis text provided.</li>'}
            </ul>
            <p class="mt-3">
              <strong>Primary Catalyst:</strong>
              <span class="text-light">${alert.PrimaryCatalyst || 'None / purely technical'}</span>
            </p>
          </div>
          <div class="col-md-6">
            <h5>Actionable Strategy <span class="badge bg-primary">THE PLAN</span></h5>
            <p class="mb-1">
              <strong>Entry Trigger:</strong>
              <span class="text-success fs-5">
                ${isNaN(entry) ? '‚Äî' : `$${entry.toFixed(2)}`}
              </span>
            </p>
            <p class="mb-1">
              <strong>Target Profit (Exit):</strong>
              <span class="text-info fs-5">
                ${isNaN(target) ? '‚Äî' : `$${target.toFixed(2)}`}
              </span>
            </p>
            <p class="mb-1">
              <strong>Potential Gain:</strong>
              <span class="text-gain-percent fs-4">
                ${isNaN(gainPct) ? '‚Äî' : `${gainPct.toFixed(2)}%`}
              </span>
            </p>
            <p class="mb-1">
              <strong>Maximum Stop Loss:</strong>
              <span class="text-danger fs-5">
                ${isNaN(stop) ? '‚Äî' : `$${stop.toFixed(2)}`}
              </span>
            </p>
            <small class="text-muted">
              Tier: ${cap}. AI-generated levels; always confirm with your own charts.
            </small>
          </div>
        </div>
      </div>
    `;
  }

  if (runScanBtn) {
    runScanBtn.addEventListener('click', () => fetchScanner('hedge_fund'));
  }

  // =================== NEWS / WATCHLIST / TOPIC FILTER ===================
  let latestNewsData = [];
  let watchlist = [];
  let currentTopicFilter = 'all';

  const WATCHLIST_STORAGE_KEY = 'bb_watchlist';
  const TOPIC_FILTER_STORAGE_KEY = 'bb_topic_filter';

  const watchlistForm = document.getElementById('watchlistForm');
  const watchlistInput = document.getElementById('watchlistInput');
  const watchlistBadges = document.getElementById('watchlistBadges');

  const topicFilterSelect = document.getElementById('topicFilterSelect');
  const refreshNewsBtn = document.getElementById('refreshNewsBtn');

  const watchlistNewsList = document.getElementById('watchlistNewsList');
  const stockSpecificNewsList = document.getElementById('stockSpecificNewsList');
  const benzingaNewsList = document.getElementById('benzingaNewsList');
  const finnhubNewsList = document.getElementById('finnhubNewsList');
  const newsAnalysisCard = document.getElementById('newsAnalysisCard');

  const TOPIC_FILTERS = {
    all: { label: 'All topics', keywords: [] },

    ai: {
      label: 'AI & Automation',
      keywords: [
        'artificial intelligence', 'machine learning', 'deep learning',
        'neural network', 'ai chip', 'ai chips', 'generative ai',
        'large language model', 'llm', 'robotics', 'robot', 'automation',
        'autonomous vehicle', 'self-driving', 'computer vision',
        'data center', 'palantir', 'pltr', 'nvidia', 'nvda'
      ]
    },

    quantum: {
      label: 'Quantum Computing',
      keywords: [
        'quantum computing', 'quantum computer', 'qubit', 'qubits',
        'ionq', 'rigetti', 'rig', 'd-wave', 'quantum advantage'
      ]
    },

    bio: {
      label: 'Biotech & HealthTech',
      keywords: [
        'biotech', 'biotechnology', 'clinical trial', 'phase 1', 'phase 2', 'phase 3',
        'fda approval', 'fda clears', 'fda grants', 'drug candidate', 'oncology',
        'gene therapy', 'crispr', 'mrna', 'vaccine', 'medical device',
        'healthtech', 'digital health'
      ]
    },

    renewable: {
      label: 'Renewables & Cleantech',
      keywords: [
        'renewable energy', 'clean energy', 'cleantech', 'solar', 'wind',
        'photovoltaic', 'battery storage', 'energy storage',
        'ev charging', 'electric vehicle', 'hydrogen', 'green hydrogen',
        'energy transition'
      ]
    },

    cyber: {
      label: 'Cybersecurity & Cloud',
      keywords: [
        'cybersecurity', 'ransomware', 'data breach', 'network security',
        'endpoint security', 'zero trust', 'cloud security', 'cloud computing',
        'crowdstrike', 'zscaler', 'okta', 'palo alto networks'
      ]
    },

    synthetic_bio: {
      label: 'Synthetic Biology',
      keywords: [
        'synthetic biology', 'synbio', 'engineered organism', 'metabolic engineering',
        'ginkgo bioworks', 'cell programming', 'dna synthesis'
      ]
    },

    neuro: {
      label: 'BCI & Neurotechnology',
      keywords: [
        'brain-computer interface', 'bci', 'neural implant', 'brain implant',
        'neurotechnology', 'neuralink', 'deep brain stimulation', 'neural interface'
      ]
    },

    nuclear: {
      label: 'Advanced Nuclear',
      keywords: [
        'small modular reactor', 'smr', 'nuclear reactor', 'advanced reactor',
        'fusion reactor', 'nuclear fusion', 'nuclear fission',
        'uranium', 'nuclear plant'
      ]
    }
  };

  function loadWatchlistFromStorage() {
    try {
      const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          watchlist = arr.map(t => String(t).toUpperCase());
        }
      }
    } catch (e) {
      console.error('Failed to load watchlist from storage', e);
    }
  }

  function saveWatchlistToStorage() {
    try {
      localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify(watchlist));
    } catch (e) {
      console.error('Failed to save watchlist to storage', e);
    }
  }

  function loadTopicFilterFromStorage() {
    try {
      const val = localStorage.getItem(TOPIC_FILTER_STORAGE_KEY);
      if (val && TOPIC_FILTERS[val]) {
        currentTopicFilter = val;
        if (topicFilterSelect) topicFilterSelect.value = val;
      }
    } catch (e) {
      console.error('Failed to load topic filter', e);
    }
  }

  function saveTopicFilterToStorage() {
    try {
      localStorage.setItem(TOPIC_FILTER_STORAGE_KEY, currentTopicFilter);
    } catch (e) {
      console.error('Failed to save topic filter', e);
    }
  }

  function renderWatchlistBadges() {
    if (!watchlistBadges) return;
    watchlistBadges.innerHTML = '';

    if (!watchlist.length) {
      const span = document.createElement('span');
      span.className = 'text-muted small';
      span.textContent = 'No tickers yet. Add one above to start.';
      watchlistBadges.appendChild(span);
      return;
    }

    watchlist.forEach(ticker => {
      const badge = document.createElement('span');
      badge.className = 'badge rounded-pill bg-dark text-light d-flex align-items-center gap-1';
      badge.style.cursor = 'default';
      badge.innerHTML = `
        <span>${ticker}</span>
        <button type="button"
                class="btn-close btn-close-white btn-close-sm"
                aria-label="Remove"
                style="font-size: 0.55rem;"></button>
      `;
      badge.querySelector('button').addEventListener('click', () => {
        watchlist = watchlist.filter(t => t !== ticker);
        saveWatchlistToStorage();
        renderWatchlistBadges();
        renderAllNewsCards();
      });
      watchlistBadges.appendChild(badge);
    });
  }

  function matchesTopic(article, topicKey) {
    if (topicKey === 'all') return true;
    const config = TOPIC_FILTERS[topicKey];
    if (!config) return true;
    const text = ((article.headline || '') + ' ' + (article.summary || '')).toLowerCase();
    return config.keywords.some(kw => text.includes(kw.toLowerCase()));
  }

  function articleMatchesWatchlist(article) {
    if (!watchlist.length) return false;
    const articleTickers = (article.tickers || []).map(t => String(t).toUpperCase());
    return articleTickers.some(t => watchlist.includes(t));
  }

  function buildNewsItem(article) {
    const li = document.createElement('button');
    li.type = 'button';
    li.className = 'list-group-item list-group-item-action';

    const dt = article.published_ts ? new Date(article.published_ts * 1000) : null;
    const timeStr = dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

    const tickers = article.tickers || [];

    li.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div class="me-2 text-start">
          <div class="fw-semibold">${article.headline || 'No headline'}</div>
          <div class="small text-muted mt-1">${article.summary || ''}</div>
          <div class="small mt-1">
            ${tickers.map(t => `<span class="badge bg-outline-secondary news-ticker-badge">${t}</span>`).join('')}
            ${article.provider ? `<span class="badge bg-secondary ms-1">${article.provider}</span>` : ''}
            ${timeStr ? `<span class="text-muted ms-2">${timeStr}</span>` : ''}
          </div>
        </div>
        <div class="d-flex flex-column align-items-end gap-1">
          ${article.url ? `<a href="${article.url}" target="_blank" class="btn btn-xs btn-outline-light btn-sm">Open</a>` : ''}
          <button class="btn btn-xs btn-outline-info btn-sm analyze-news-btn">AI View</button>
        </div>
      </div>
    `;

    const analyzeBtn = li.querySelector('.analyze-news-btn');
    analyzeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      analyzeNewsArticle(article);
    });

    return li;
  }

  function renderNewsList(container, articles, emptyText) {
    if (!container) return;
    container.innerHTML = '';
    if (!articles.length) {
      const empty = document.createElement('div');
      empty.className = 'list-group-item text-muted small text-center';
      empty.textContent = emptyText;
      container.appendChild(empty);
      return;
    }
    articles.forEach(a => {
      container.appendChild(buildNewsItem(a));
    });
  }

  function applyTopicFilter(articles) {
    return articles.filter(a => matchesTopic(a, currentTopicFilter));
  }

  function renderAllNewsCards() {
    if (!latestNewsData || !Array.isArray(latestNewsData)) return;

    const all = latestNewsData.slice();
    const topicFiltered = applyTopicFilter(all);

    const watchlistArticles = topicFiltered.filter(articleMatchesWatchlist);
    const stockSpecificArticles = topicFiltered.filter(a => (a.tickers || []).length > 0);
    const benzingaArticles = topicFiltered.filter(a => a.source === 'Benzinga');
    const finnhubArticles = topicFiltered.filter(a => a.source === 'Finnhub');

    renderNewsList(
      watchlistNewsList,
      watchlistArticles,
      watchlist.length ? 'No recent headlines for your watchlist yet.' : 'Add tickers above to start watchlist filtering.'
    );
    renderNewsList(
      stockSpecificNewsList,
      stockSpecificArticles,
      'No stock-specific headlines found for this topic filter.'
    );
    renderNewsList(
      benzingaNewsList,
      benzingaArticles,
      'No Benzinga headlines for this topic filter.'
    );
    renderNewsList(
      finnhubNewsList,
      finnhubArticles,
      'No Finnhub headlines for this topic filter.'
    );
  }

  async function fetchNews() {
    try {
      if (refreshNewsBtn) {
        refreshNewsBtn.disabled = true;
        refreshNewsBtn.textContent = 'Loading...';
      }

      const resp = await fetch('/api/news/headlines?limit=80', { method: 'GET' });
      const result = await resp.json();

      if (!result.success) {
        console.error('News API error:', result.error);
        return;
      }

      latestNewsData = result.data || [];
      renderAllNewsCards();
    } catch (err) {
      console.error('News fetch error:', err);
    } finally {
      if (refreshNewsBtn) {
        refreshNewsBtn.disabled = false;
        refreshNewsBtn.textContent = 'üîÑ Refresh Headlines';
      }
    }
  }

  // AI analysis for a single news article
  async function analyzeNewsArticle(article) {
    if (!newsAnalysisCard) return;

    newsAnalysisCard.innerHTML = `
      <div class="small text-muted">Analyzing with AI...</div>
    `;
    newsAnalysisCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

    try {
      const resp = await fetch('/api/news/analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          article,
          symbol: (article.tickers && article.tickers[0]) || null
        })
      });
      const result = await resp.json();

      if (!result.success) {
        newsAnalysisCard.innerHTML = `
          <div class="text-danger small">
            AI analysis failed: ${result.error || 'Unknown error'}
          </div>
        `;
        return;
      }

      const data = result.data || {};
      const stance = (data.stance || 'neutral').toUpperCase();
      const impact = (data.impact_level || 'medium').toUpperCase();
      const summary = data.summary || article.summary || article.headline || '';
      const rationale = Array.isArray(data.rationale) ? data.rationale : [];
      const riskNotes = data.risk_notes || '';
      const disclaimer = data.disclaimer || 'This is not personalized financial advice.';

      newsAnalysisCard.innerHTML = `
        <div class="card-header bg-dark text-white p-2">
          <strong>AI News View</strong>
          <span class="badge bg-info ms-2">${stance}</span>
          <span class="badge bg-warning text-dark ms-1">Impact: ${impact}</span>
        </div>
        <div class="card-body p-3">
          <p class="mb-2"><strong>Headline:</strong> ${article.headline || ''}</p>
          <p class="mb-2"><strong>Summary:</strong> ${summary}</p>

          <p class="mb-1"><strong>Why this matters:</strong></p>
          <ul class="mb-2">
            ${
              rationale.length
                ? rationale.map(r => `<li>${r}</li>`).join('')
                : '<li>No detailed rationale provided.</li>'
            }
          </ul>

          <p class="mb-1"><strong>Key risks:</strong></p>
          <p class="small mb-2">${riskNotes}</p>

          <p class="small text-muted mb-0">
            ${disclaimer}
          </p>
        </div>
      `;
    } catch (err) {
      console.error('News analysis error:', err);
      newsAnalysisCard.innerHTML = `
        <div class="text-danger small">
          AI analysis request failed due to a network/server error.
        </div>
      `;
    }
  }

  // ---- event wiring for news controls ----
  if (watchlistForm) {
    watchlistForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const raw = (watchlistInput.value || '').trim().toUpperCase();
      if (!raw) return;
      if (!watchlist.includes(raw)) {
        watchlist.push(raw);
        saveWatchlistToStorage();
        renderWatchlistBadges();
        renderAllNewsCards();
      }
      watchlistInput.value = '';
    });
  }

  if (topicFilterSelect) {
    topicFilterSelect.addEventListener('change', (e) => {
      currentTopicFilter = e.target.value || 'all';
      saveTopicFilterToStorage();
      renderAllNewsCards();
    });
  }

  if (refreshNewsBtn) {
    refreshNewsBtn.addEventListener('click', (e) => {
      e.preventDefault();
      fetchNews();
    });
  }

  // ---- initial load ----
  loadWatchlistFromStorage();
  loadTopicFilterFromStorage();
  renderWatchlistBadges();
  fetchNews();   // only fetch once at load; refresh button can refetch

</script>
</body>
</html>
