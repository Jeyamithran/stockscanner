<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Black Box Scanner | Pro Trader Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Black Box Scanner">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/app-icon.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/app-icon.png') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='icons/app-icon.png') }}" color="#0af5ff">

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <style>
        :root {
            --bg-main: #050816;
            --bg-card: #101827;
            --bg-card-soft: #121826;
            --border-subtle: #253244;
            --text-main: #f9fafb;
            --text-muted-soft: #9ca3af;
            --accent-primary: #38bdf8;
            --accent-secondary: #a855f7;
            --accent-danger: #f97373;
            --accent-success: #4ade80;
        }

        body {
            background: radial-gradient(circle at top, #0b1220, #020617 55%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 1.05rem;
            line-height: 1.6;
        }

        body.light-mode {
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-card-soft: #f9fafb;
            --border-subtle: #e5e7eb;
            --text-main: #111827;
            --text-muted-soft: #6b7280;
            --accent-primary: #2563eb;
            --accent-secondary: #8b5cf6;
            --accent-danger: #dc2626;
            --accent-success: #16a34a;
            background: linear-gradient(180deg, #f9fafb 0%, #e5e7eb 60%, #d1d5db 100%);
        }

        .text-muted {
            color: var(--text-muted-soft) !important;
        }

        .app-shell {
            max-width: 1240px;
            margin: 0 auto;
            padding: 1rem 1rem 2rem;
        }

        .card {
            background-color: var(--bg-card);
            border-color: var(--border-subtle);
            border-radius: 0.9rem;
            color: var(--text-main);
            box-shadow: 0 15px 35px rgba(2, 6, 23, 0.45);
        }

        .card-header {
            background-color: rgba(15, 23, 42, 0.9);
            border-bottom-color: var(--border-subtle);
            color: var(--text-main);
        }

        body.light-mode .card-header {
            background-color: #f3f4f6;
            color: #0f172a;
        }

        .card-body {
            background-color: var(--bg-card);
            color: var(--text-main);
        }

        body.light-mode .card,
        body.light-mode .card-body {
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            color: #0f172a;
        }

        .pill {
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.72rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .pill-hedge {
            background: rgba(248, 250, 252, 0.06);
            border: 1px solid rgba(148, 163, 184, 0.6);
        }

        .pill-pro {
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.7);
        }

        .pill-cat {
            background: rgba(245, 158, 11, 0.12);
            border: 1px solid rgba(245, 158, 11, 0.7);
        }

        .pill-bio {
            background: rgba(16, 185, 129, 0.12);
            border: 1px solid rgba(16, 185, 129, 0.7);
        }

        .pill-growth {
            background: rgba(248, 113, 113, 0.12);
            border: 1px solid rgba(248, 113, 113, 0.6);
        }

        .econ-filters .form-label {
            font-size: 0.85rem;
            color: var(--text-muted-soft);
        }

        .econ-impact-pill {
            font-size: 0.72rem;
            border-radius: 999px;
            padding: 0.1rem 0.55rem;
            letter-spacing: 0.04em;
        }

        .econ-status-text {
            color: var(--text-muted-soft);
        }

        .econ-table td {
            vertical-align: top;
        }

        .econ-table .event-title {
            font-weight: 600;
        }

        .scanner-tier-header {
            border-radius: 0.9rem 0.9rem 0 0;
        }

        .table-dark {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(15, 23, 42, 0.75);
            --bs-table-hover-bg: rgba(15, 23, 42, 0.95);
            color: var(--text-main);
        }

        .table-dark td, .table-dark th {
            border-color: var(--border-subtle);
        }

        body.light-mode .table-dark {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: #f9fafb;
            --bs-table-hover-bg: #e5e7eb;
            color: #111827;
        }

        .ticker-chip {
            font-weight: 600;
            color: var(--accent-primary);
        }

        body.light-mode .ticker-chip {
            color: #2563eb;
        }

        .gain-chip {
            color: var(--accent-success);
            font-weight: 600;
        }

        body.light-mode .gain-chip {
            color: #16a34a;
        }

        .scanner-table td,
        .scanner-table th {
            color: var(--text-main);
        }

        body.light-mode .scanner-table td,
        body.light-mode .scanner-table th {
            color: #0f172a;
        }

        .history-table td,
        .history-table th {
            color: var(--text-main);
        }

        body.light-mode .history-table td,
        body.light-mode .history-table th {
            color: #0f172a;
        }

        .nav-tabs {
            border-bottom-color: var(--border-subtle);
        }

        .nav-tabs .nav-link {
            border-radius: 999px;
            border: none;
            margin-right: 0.5rem;
            padding: 0.4rem 0.9rem;
            color: var(--text-muted-soft);
            background: transparent;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .news-filters-card {
            background: var(--bg-card-soft);
        }

        .watch-pill {
            background: rgba(56, 189, 248, 0.15);
            color: var(--text-main);
            border-radius: 999px;
            padding: 0.15rem 0.65rem;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        body.light-mode .watch-pill {
            background: rgba(37, 99, 235, 0.12);
            color: #111827;
        }

        .watch-pill-remove {
            border: none;
            background: transparent;
            color: inherit;
            cursor: pointer;
            font-size: 0.85rem;
            line-height: 1;
        }

        .topic-chip {
            border: 1px solid var(--border-subtle);
            border-radius: 999px;
            padding: 0.25rem 0.85rem;
            font-size: 0.8rem;
            color: var(--text-muted-soft);
            cursor: pointer;
            background: transparent;
            transition: all 0.2s ease;
        }

        .topic-chip.active {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        .btn-refresh {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 0.35rem 1.1rem;
            font-size: 0.85rem;
            color: var(--text-main);
            background: transparent;
            transition: all 0.2s ease;
        }

        .btn-refresh:hover {
            background: rgba(56, 189, 248, 0.15);
            color: var(--accent-primary);
        }

        body.light-mode .btn-refresh {
            color: #111827;
        }

        .btn-ai-analysis {
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            background: transparent;
            transition: all 0.2s ease;
        }

        .btn-ai-analysis:hover,
        .btn-ai-analysis:focus {
            background: var(--accent-primary);
            color: #0f172a;
        }

        body.light-mode .btn-ai-analysis {
            border-color: #2563eb;
            color: #2563eb;
        }

        body.light-mode .btn-ai-analysis:hover,
        body.light-mode .btn-ai-analysis:focus {
            background: #2563eb;
            color: #fff;
        }

        .history-controls {
            background: rgba(15, 23, 42, 0.4);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .history-controls .form-control,
        .history-controls .form-select {
            background-color: rgba(15, 23, 42, 0.65);
            border-color: var(--border-subtle);
            color: var(--text-main);
        }

        .history-controls .form-control::placeholder {
            color: var(--text-muted-soft);
        }

        .history-controls .input-group-text {
            background: transparent;
            border-color: var(--border-subtle);
            color: var(--text-muted-soft);
        }

        .history-results-count {
            white-space: nowrap;
        }

        .table-sortable th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .history-sortable .sort-indicator {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-left: 0.2rem;
        }

        .history-sortable .sort-indicator::before {
            content: '‚Üï';
        }

        .history-sortable.sorted-asc .sort-indicator::before {
            content: '‚Üë';
        }

        .history-sortable.sorted-desc .sort-indicator::before {
            content: '‚Üì';
        }

        .history-table-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .history-table-row.active {
            background: rgba(56, 189, 248, 0.08) !important;
        }

        body.light-mode .history-controls {
            background: rgba(255, 255, 255, 0.8);
        }

        body.light-mode .history-controls .form-control,
        body.light-mode .history-controls .form-select {
            background-color: #fff;
            color: #111827;
        }

        body.light-mode .history-controls .btn-outline-light {
            color: #111827;
            border-color: var(--border-subtle);
        }

        body.light-mode .btn-outline-light {
            color: #111827;
            border-color: var(--border-subtle);
        }

        body.light-mode .btn-outline-light:hover,
        body.light-mode .btn-outline-light:focus,
        body.light-mode .btn-outline-light.active,
        body.light-mode .btn-outline-light:active {
            background-color: rgba(37, 99, 235, 0.12);
            color: #111827;
        }

        .news-card .card-header,
        .news-card .card-body {
            background-color: transparent;
        }

        .news-card .list-group-item {
            background: transparent;
            border-color: var(--border-subtle);
            color: var(--text-main) !important;
        }

        body.light-mode .news-card .list-group-item {
            color: #111827 !important;
        }

        .news-card .list-group-item:hover {
            background: rgba(56, 189, 248, 0.08);
        }

        .news-card .list-group-item .text-muted {
            color: var(--text-muted-soft) !important;
        }

        .news-card .headline-title {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .news-card .headline-summary {
            font-size: 0.92rem;
            color: var(--text-muted-soft);
        }

        body.light-mode .news-card .list-group-item:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .badge-stance-bullish {
            background: rgba(22, 163, 74, 0.14);
            color: #4ade80;
        }

        .badge-stance-bearish {
            background: rgba(220, 38, 38, 0.14);
            color: #fb7185;
        }

        .badge-stance-mixed {
            background: rgba(234, 179, 8, 0.14);
            color: #facc15;
        }

        .badge-stance-neutral {
            background: rgba(148, 163, 184, 0.14);
            color: #e5e7eb;
        }

        .badge-impact-low {
            background: rgba(148, 163, 184, 0.16);
            color: #e5e7eb;
        }

        .badge-impact-medium {
            background: rgba(234, 179, 8, 0.16);
            color: #facc15;
        }

        .badge-impact-high {
            background: rgba(220, 38, 38, 0.16);
            color: #fb7185;
        }

        .theme-toggle-label {
            font-size: 0.8rem;
            color: var(--text-muted-soft);
        }

        @media (max-width: 991.98px) {
            .app-shell {
                padding-inline: 0.75rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
<div class="app-shell">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <div class="mb-2">
            <h1 class="h3 mb-1">
                Black Box Scanner
                <span class="badge rounded-pill bg-danger ms-1">PRO LIVE</span>
            </h1>
            <p class="text-muted mb-0 small">
                High-velocity breakout & catalyst radar. For your eyes only.
            </p>
        </div>
        <div class="d-flex align-items-center gap-3 mb-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeSwitch">
                <label class="form-check-label theme-toggle-label" for="themeSwitch">
                    Dark mode
                </label>
            </div>
            <div class="text-end">
                <button id="runScanBtn" class="btn btn-sm btn-primary">
                    Run Scanner
                </button>
                <p id="lastUpdated" class="text-muted small mb-0 mt-1">Last scan: never</p>
                <p id="modelStatus" class="text-muted small mb-0">Model: Reasoning (Deep Search)</p>
                <div class="form-check form-switch small text-start mt-2">
                    <input class="form-check-input" type="checkbox" id="fallbackToggle">
                    <label class="form-check-label" for="fallbackToggle">
                        Allow fallback (extra AI call)
                    </label>
                </div>
                <div id="scannerError" class="alert alert-danger small py-1 px-2 mt-2 mb-0 d-none text-start">
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="scanner-tab" data-bs-toggle="tab" data-bs-target="#scanner-pane"
                    type="button" role="tab">
                Scanner
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-pane"
                    type="button" role="tab">
                News & AI Lens
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane"
                    type="button" role="tab">
                History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tv-tab" data-bs-toggle="tab" data-bs-target="#tv-pane"
                    type="button" role="tab">
                TradingView Signals
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-signals-tab" data-bs-toggle="tab" data-bs-target="#ai-signals"
                    type="button" role="tab">
                üß† AI Signals
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ===================== SCANNER TAB ===================== -->
        <div class="tab-pane fade show active" id="scanner-pane" role="tabpanel" aria-labelledby="scanner-tab">
            <!-- Profile selector row -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="text-muted small me-1">Profile:</span>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Profile selector">
                                <button class="btn btn-outline-light active" data-profile="hedge_fund" id="btnProfileHedge">
                                    <span class="pill pill-hedge">Hedge Fund PM</span>
                                </button>
                                <button class="btn btn-outline-light" data-profile="pro_trader" id="btnProfilePro">
                                    <span class="pill pill-pro">Pro Momentum</span>
                                </button>
                                <button class="btn btn-outline-light" data-profile="catalyst" id="btnProfileCat">
                                    <span class="pill pill-cat">News / SEC</span>
                                </button>
                                <button class="btn btn-outline-light" data-profile="bio_analyst" id="btnProfileBio">
                                    <span class="pill pill-bio">Biotech</span>
                                </button>
                                <button class="btn btn-outline-light" data-profile="high_growth" id="btnProfileGrowth">
                                    <span class="pill pill-growth">High Growth</span>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="text-muted small me-1">Model:</span>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Model selector">
                                <button class="btn btn-outline-light active" data-model="reasoning" id="btnModelReasoning">
                                    Reasoning
                                </button>
                                <button class="btn btn-outline-light" data-model="pro" id="btnModelPro">
                                    Classic
                                </button>
                            </div>
                        </div>
                        <div class="text-end small text-muted">
                            Click any name below to open its trading plan & history.
                        </div>
                    </div>
                    <div id="scanner-info" class="text-warning small mt-2 d-none"></div>
                </div>
            </div>

            <div id="scanner-buckets-wrapper">
                <!-- 3 tiers row -->
                <div class="row g-3 mb-3">
                    <!-- SmallCap -->
                    <div class="col-12 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header scanner-tier-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-danger-subtle text-danger">üî• SmallCap / High Beta</span>
                                    </div>
                                    <small class="text-muted">Aggressive</small>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-dark table-striped table-hover mb-0 scanner-table">
                                    <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="SmallCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            No data yet. Run scanner.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- MidCap -->
                    <div class="col-12 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header scanner-tier-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-warning-subtle text-warning">üü° MidCap / Liquidity Mix</span>
                                    </div>
                                    <small class="text-muted">Balanced</small>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-dark table-striped table-hover mb-0 scanner-table">
                                    <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="MidCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            No data yet. Run scanner.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- LargeCap -->
                    <div class="col-12 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header scanner-tier-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-success-subtle text-success">üü¢ LargeCap / Institutional</span>
                                    </div>
                                    <small class="text-muted">Stable</small>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-dark table-striped table-hover mb-0 scanner-table">
                                    <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry</th>
                                        <th>Target (%)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="LargeCap-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            No data yet. Run scanner.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Plan / Details card + History -->
                <div class="card" id="scanner-analysis-card">
                    <div class="card-body">
                        <p class="text-center text-muted mb-0">
                            Click any ticker in the tables above to load its trading thesis, plan, and alert history here.
                        </p>
                    </div>
                </div>
            </div>

            <div class="card d-none" id="growth-results-card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                    <h5 class="mb-0">High-Growth Innovators</h5>
                    <small class="text-muted" id="growth-timestamp">Timestamp: ‚Äî</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover mb-0">
                            <thead class="text-nowrap">
                            <tr>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>Sector</th>
                                <th>Market Cap</th>
                                <th>Growth Metric</th>
                                <th>Period</th>
                                <th>Catalyst</th>
                                <th>Source</th>
                                <th>Inst. Own</th>
                                <th>Risk/Reward</th>
                                <th>Technical Indicators</th>
                                <th>Notes</th>
                            </tr>
                            </thead>
                            <tbody id="growth-table-body">
                            <tr>
                                <td colspan="12" class="text-center text-muted py-3">
                                    Run the scanner with the High Growth profile to populate this table.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3 d-none" id="growth-analysis-card">
                <div class="card-body">
                    <p class="text-center text-muted mb-0">Select a candidate above to load the full AI playbook.</p>
                </div>
            </div>
        </div>

        <!-- ===================== NEWS TAB ===================== -->
        <div class="tab-pane fade" id="news-pane" role="tabpanel" aria-labelledby="news-tab">
            <div class="card mb-3 news-filters-card">
                <div class="card-body py-3">
                    <div class="row g-3 align-items-center">
                        <div class="col-lg-5 col-md-6">
                            <div class="small text-muted mb-1">Watchlist (tickers or names):</div>
                            <div class="d-flex gap-2">
                                <input type="text" id="watchInput" class="form-control form-control-sm"
                                       placeholder="TSLA, NVDA, JNJ or Tesla">
                                <button id="watchAddBtn" class="btn btn-outline-info btn-sm" type="button">
                                    Add
                                </button>
                            </div>
                            <div class="mt-2 d-flex flex-wrap gap-2" id="watchlistPills">
                                <span class="text-muted small">No watchlist yet.</span>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-6">
                            <div class="small text-muted mb-1">Topic filters:</div>
                            <div class="d-flex flex-wrap gap-2" id="topicChips">
                                <button type="button" class="topic-chip active" data-topic="all">All</button>
                                <button type="button" class="topic-chip" data-topic="ai">AI &amp; Automation</button>
                                <button type="button" class="topic-chip" data-topic="quantum">Quantum Computing</button>
                                <button type="button" class="topic-chip" data-topic="bio">Biotech &amp; HealthTech</button>
                                <button type="button" class="topic-chip" data-topic="renewable">Renewable &amp; Cleantech</button>
                                <button type="button" class="topic-chip" data-topic="cyber">Cybersecurity &amp; Cloud</button>
                                <button type="button" class="topic-chip" data-topic="synbio">Synthetic Biology</button>
                                <button type="button" class="topic-chip" data-topic="bci">BCI &amp; Neurotech</button>
                                <button type="button" class="topic-chip" data-topic="nuclear">Advanced Nuclear</button>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-12 text-lg-end">
                            <button id="refreshNewsBtn" class="btn-refresh w-100" type="button">
                                Refresh News
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <!-- Left: Headline stream -->
                <div class="col-12 col-lg-7">
                    <div class="card mb-3 news-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-info-subtle text-info">Live Headlines</span>
                                <span class="text-muted small ms-2">Finnhub + Benzinga</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="news-list">
                                <div class="text-center text-muted py-3 small">
                                    Click ‚ÄúRefresh‚Äù to load headlines.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: AI News Analysis -->
                <div class="col-12 col-lg-5">
                    <div class="card h-100" id="news-analysis-card">
                        <div class="card-body">
                            <h5 class="mb-2">AI News Lens</h5>
                            <p class="text-muted small mb-3">
                                Click <strong>‚ÄúAI Analysis‚Äù</strong> on any headline to see how a trading desk might interpret it.
                                When loaded, this panel will auto-focus for you.
                            </p>
                            <p class="text-center text-muted mb-0">
                                No headline selected yet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3" id="econ-calendar-card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <span class="badge bg-warning-subtle text-warning">Economic Calendar</span>
                        <span class="econ-status-text small ms-2" id="econStatus">Adjust filters and refresh to load macro events.</span>
                    </div>
                    <button id="econRefreshBtn" class="btn btn-outline-light btn-sm" type="button">
                        Refresh Calendar
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3 econ-filters align-items-end">
                        <div class="col-12 col-lg-3 col-md-6">
                            <label class="form-label small" for="econRangeSelect">Window</label>
                            <select class="form-select form-select-sm" id="econRangeSelect">
                                <option value="today">Today</option>
                                <option value="48h">Next 48 Hours</option>
                                <option value="week" selected>This Week</option>
                                <option value="custom">Next 10 Days</option>
                            </select>
                        </div>
                        <div class="col-12 col-lg-3 col-md-6">
                            <label class="form-label small d-block">Impact</label>
                            <div class="d-flex flex-wrap gap-2 econ-impact-filters">
                                <div class="form-check form-check-inline small">
                                    <input class="form-check-input" type="checkbox" id="econImpactHigh" data-econ-impact="high" checked>
                                    <label class="form-check-label" for="econImpactHigh">High</label>
                                </div>
                                <div class="form-check form-check-inline small">
                                    <input class="form-check-input" type="checkbox" id="econImpactMed" data-econ-impact="medium" checked>
                                    <label class="form-check-label" for="econImpactMed">Medium</label>
                                </div>
                                <div class="form-check form-check-inline small">
                                    <input class="form-check-input" type="checkbox" id="econImpactLow" data-econ-impact="low">
                                    <label class="form-check-label" for="econImpactLow">Low</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3 col-md-6">
                            <label class="form-label small" for="econCurrencyInput">Currencies (comma separated)</label>
                            <input type="text" class="form-control form-control-sm" id="econCurrencyInput" placeholder="USD, EUR, GBP">
                        </div>
                        <div class="col-12 col-lg-3 col-md-6">
                            <label class="form-label small" for="econTzSelect">Display timezone</label>
                            <select class="form-select form-select-sm" id="econTzSelect">
                                <option value="0">UTC / GMT</option>
                                <option value="-300">New York (ET)</option>
                                <option value="-360">Chicago (CT)</option>
                                <option value="-480">Los Angeles (PT)</option>
                                <option value="60">Frankfurt (CET)</option>
                                <option value="330">Mumbai (IST)</option>
                                <option value="480">Singapore</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-dark table-striped table-hover align-middle mb-0 econ-table">
                            <thead>
                            <tr>
                                <th style="min-width: 140px;">Local Time</th>
                                <th style="min-width: 120px;">Impact / FX</th>
                                <th>Event</th>
                                <th style="min-width: 220px;">Actual / Forecast / Previous</th>
                                <th style="min-width: 130px;">Status</th>
                            </tr>
                            </thead>
                            <tbody id="econ-table-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    Adjust filters then press Refresh to load the macro calendar.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3" id="supertrend-card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <span class="badge bg-success-subtle text-success">Supertrend Catalyst Radar</span>
                        <span class="text-muted small ms-2">Universe: SPY ¬∑ QQQ ¬∑ NVDA ¬∑ TSLA ¬∑ MSFT</span>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted" id="supertrendLastRun">Last run: ‚Äî</small>
                        <button class="btn btn-outline-light btn-sm" id="runSupertrendBtn" type="button">
                            Run Supertrend Radar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3" id="supertrendStatus">
                        Combines Supertrend (ATR 10 x3) with fresh catalysts in the last 72h. Click run to fetch live insights.
                    </p>
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-8">
                            <label class="form-label small" for="supertrendTickersInput">Tickers (comma separated)</label>
                            <input type="text" class="form-control form-control-sm" id="supertrendTickersInput"
                                   value="SPY, QQQ, NVDA, TSLA, MSFT"
                                   placeholder="SPY, QQQ, ‚Ä¶">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small" for="supertrendAtrPeriod">ATR Period</label>
                            <input type="number" min="4" max="50" step="1" value="10" class="form-control form-control-sm" id="supertrendAtrPeriod">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small" for="supertrendAtrMult">ATR Mult</label>
                            <input type="number" min="1" max="6" step="0.1" value="3.0" class="form-control form-control-sm" id="supertrendAtrMult">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Trend</th>
                                <th>Price</th>
                                <th>Anchored VWAP</th>
                                <th>Entry</th>
                                <th>Stop</th>
                                <th>Target</th>
                                <th>Catalyst / Notes</th>
                                <th>Conf.</th>
                            </tr>
                            </thead>
                            <tbody id="supertrend-table-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">
                                    Press ‚ÄúRun Supertrend Radar‚Äù to populate ideas.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3" id="zigzag-card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <span class="badge bg-primary-subtle text-primary">ZigZag Swing Radar</span>
                        <span class="text-muted small ms-2">Parameters: Deviation 5%, Backstep 5 bars</span>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted" id="zigzagLastRun">Last run: ‚Äî</small>
                        <button class="btn btn-outline-light btn-sm" id="runZigzagBtn" type="button">
                            Run ZigZag Radar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3" id="zigzagStatus">
                        Tracks fresh swing highs/lows (ZigZag) and overlays catalysts. Use alongside Supertrend for confirmation.
                    </p>
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-8">
                            <label class="form-label small" for="zigzagTickersInput">Tickers (comma separated)</label>
                            <input type="text" class="form-control form-control-sm" id="zigzagTickersInput"
                                   value="SPY, QQQ, NVDA, TSLA, MSFT"
                                   placeholder="SPY, QQQ, ‚Ä¶">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small" for="zigzagDeviation">Deviation %</label>
                            <input type="number" min="1" max="15" step="0.5" value="5" class="form-control form-control-sm" id="zigzagDeviation">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small" for="zigzagBackstep">Backstep</label>
                            <input type="number" min="2" max="20" step="1" value="5" class="form-control form-control-sm" id="zigzagBackstep">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Direction</th>
                                <th>Pivot Price</th>
                                <th>Anchored VWAP</th>
                                <th>Entry</th>
                                <th>Stop</th>
                                <th>Target</th>
                                <th>Catalyst / Notes</th>
                                <th>Conf.</th>
                            </tr>
                            </thead>
                            <tbody id="zigzag-table-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">
                                    Press ‚ÄúRun ZigZag Radar‚Äù to see swing signals.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3" id="daytrade-card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        <span class="badge bg-danger-subtle text-danger">Day-Trade Radar</span>
                        <span class="text-muted small ms-2">Intraday Supertrend + ZigZag (default 15m)</span>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted" id="daytradeLastRun">Last run: ‚Äî</small>
                        <button class="btn btn-outline-light btn-sm" id="runDaytradeBtn" type="button">Run Day-Trade Radar</button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3" id="daytradeStatus">
                        Uses intraday yahoo! finance data (1m/5m/15m) with tighter Supertrend (ATR 7 x2) and ZigZag (2.5% / 4 bars). Adjust inputs below to fit your style.
                    </p>
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-lg-4">
                            <label class="form-label small" for="daytradeTickersInput">Tickers</label>
                            <input type="text" class="form-control form-control-sm" id="daytradeTickersInput"
                                   value="SPY, QQQ, NVDA, TSLA, MSFT">
                        </div>
                        <div class="col-6 col-lg-2">
                            <label class="form-label small" for="daytradeInterval">Interval</label>
                            <select class="form-select form-select-sm" id="daytradeInterval">
                                <option value="1m">1m</option>
                                <option value="5m">5m</option>
                                <option value="15m" selected>15m</option>
                            </select>
                        </div>
                        <div class="col-3 col-lg-1">
                            <label class="form-label small" for="daytradeAtrPeriod">ATR</label>
                            <input type="number" min="4" max="30" step="1" value="7" class="form-control form-control-sm" id="daytradeAtrPeriod">
                        </div>
                        <div class="col-3 col-lg-1">
                            <label class="form-label small" for="daytradeAtrMult">Mult</label>
                            <input type="number" min="1" max="4" step="0.1" value="2.0" class="form-control form-control-sm" id="daytradeAtrMult">
                        </div>
                        <div class="col-3 col-lg-1">
                            <label class="form-label small" for="daytradeDeviation">Dev%</label>
                            <input type="number" min="1" max="10" step="0.5" value="2.5" class="form-control form-control-sm" id="daytradeDeviation">
                        </div>
                        <div class="col-3 col-lg-1">
                            <label class="form-label small" for="daytradeBackstep">Backstep</label>
                            <input type="number" min="2" max="15" step="1" value="4" class="form-control form-control-sm" id="daytradeBackstep">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Price</th>
                                <th>Supertrend</th>
                                <th>ZigZag</th>
                                <th>Session VWAP</th>
                                <th>Notes</th>
                            </tr>
                            </thead>
                            <tbody id="daytrade-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">Press ‚ÄúRun Day-Trade Radar‚Äù to load intraday signals.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== HISTORY TAB ===================== -->
        <div class="tab-pane fade" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
            <ul class="nav nav-pills mb-3" id="historySubTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="history-scanner-tab" data-bs-toggle="tab" data-bs-target="#history-scanner" type="button" role="tab">Scanner History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-breakout-tab" data-bs-toggle="tab" data-bs-target="#history-breakout" type="button" role="tab">Breakout History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-ai-tab" data-bs-toggle="tab" data-bs-target="#history-ai" type="button" role="tab">AI Signal History</button>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="history-scanner" role="tabpanel" aria-labelledby="history-scanner-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Alert Performance History</h5>
                                <small class="text-muted">
                                    Aggregated from all past scans, ranked by performance from last entry. Includes the AI‚Äôs
                                    original target & potential gain so you can audit each setup later.
                                </small>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="history-controls p-3">
                                <div class="input-group input-group-sm flex-grow-1 flex-lg-grow-0">
                                    <span class="input-group-text">Search</span>
                                    <input type="search" class="form-control" id="historySearch"
                                           placeholder="Ticker, profile, tier...">
                                </div>
                                <select class="form-select form-select-sm w-auto" id="historyProfileFilter">
                                    <option value="">Profile: All</option>
                                    <option value="hedge_fund">Hedge Fund PM</option>
                                    <option value="pro_trader">Pro Momentum</option>
                                    <option value="catalyst">News / SEC</option>
                                </select>
                                <select class="form-select form-select-sm w-auto" id="historyTierFilter">
                                    <option value="">Tier: All</option>
                                    <option value="SmallCap">SmallCap / High Beta</option>
                                    <option value="MidCap">MidCap / Balanced</option>
                                    <option value="LargeCap">LargeCap / Institutional</option>
                                </select>
                                <button class="btn btn-sm btn-outline-light ms-auto" id="historyResetFilters">
                                    Reset
                                </button>
                                <div class="form-check form-switch ms-3 text-nowrap">
                                    <input class="form-check-input" type="checkbox" id="historyLiveQuotes">
                                    <label class="form-check-label small" for="historyLiveQuotes">
                                        Live quotes
                                    </label>
                                </div>
                                <small class="text-muted history-results-count" id="historyResultsCount">
                                    Showing 0 / 0
                                </small>
                            </div>
                            <div class="table-responsive history-table-wrapper" id="historyTableWrapper">
                                <table class="table table-dark table-striped table-hover mb-0 table-sortable history-table">
                                    <thead>
                                    <tr>
                                        <th class="history-sortable" data-history-sort="ticker">
                                            Ticker <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="alerts">
                                            Alerts <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_profile">
                                            Last Profile <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_tier">
                                            Last Tier <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_entry">
                                            Last Entry <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_ai_target_price">
                                            AI Target <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_ai_potential_gain_pct">
                                            AI Gain % <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="current_price">
                                            Current <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="current_change_pct">
                                            % from Entry <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="first_date">
                                            First Seen <span class="sort-indicator"></span>
                                        </th>
                                        <th class="history-sortable" data-history-sort="last_date">
                                            Last Seen <span class="sort-indicator"></span>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                    <tr>
                                        <td colspan="11" class="text-center text-muted py-3">
                                            History will appear here after you run scans.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="historyScrollSentinel" class="history-scroll-sentinel text-center text-muted small py-2">
                                Scroll to load more history
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3" id="history-analysis-card">
                        <div class="card-body" id="history-analysis-body">
                            <p class="text-muted mb-0">Select any ticker in the history table to load a full AI breakdown.</p>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="history-breakout" role="tabpanel" aria-labelledby="history-breakout-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Breakout History</h5>
                                <small class="text-muted">Live breakout events from TradingView, including AI verdicts when available.</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted" id="breakoutStatus">Idle</small>
                                <button class="btn btn-sm btn-outline-light" id="breakoutRefreshBtn">Refresh</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-hover mb-0 align-middle">
                                    <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>TF</th>
                                        <th>Event</th>
                                        <th>Trigger</th>
                                        <th>Close</th>
                                        <th>RVOL</th>
                                        <th>Structure</th>
                                        <th>Signal</th>
                                        <th>Entry</th>
                                        <th>Stop</th>
                                        <th>Target</th>
                                    </tr>
                                    </thead>
                                    <tbody id="breakoutEventsBody">
                                    <tr>
                                        <td colspan="12" class="text-center text-muted py-3">No breakout events yet.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="history-ai" role="tabpanel" aria-labelledby="history-ai-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">AI Signal History</h5>
                                    <small class="text-muted">Latest AI signals across symbols.</small>
                                </div>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" id="aiHistoryRefreshBtn">Refresh</button>
                                </div>
                            </div>
                            <div class="mt-3 row g-2 align-items-center">
                                <div class="col-md-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">Search</span>
                                        <input type="search" class="form-control" id="aiHistorySearch" placeholder="Symbol, mode, analysis, signal">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="aiHistoryMode">
                                        <option value="">Mode: All</option>
                                        <option value="day">Day</option>
                                        <option value="swing">Swing</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="aiHistoryAnalysis">
                                        <option value="">Analysis: All</option>
                                        <option value="technical">Technical</option>
                                        <option value="news_tech">News + Tech</option>
                                    </select>
                                </div>
                                <div class="col-md-2 text-end">
                                    <small class="text-muted" id="aiHistoryStatus">‚Äî</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0 align-middle">
                                    <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>TF</th>
                                        <th>Mode</th>
                                        <th>Analysis</th>
                                        <th>Signal</th>
                                        <th>Entry</th>
                                        <th>Stop</th>
                                        <th>Target</th>
                                        <th>RR</th>
                                        <th>Conf%</th>
                                        <th>Model</th>
                                    </tr>
                                    </thead>
                                    <tbody id="aiHistoryBody">
                                    <tr>
                                        <td colspan="11" class="text-center text-muted py-3">No signals yet.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-2">
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" id="aiHistoryPrev">Prev</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="aiHistoryNext">Next</button>
                                    <small class="text-muted" id="aiHistoryPage">Page 1</small>
                                </div>
                                <div class="d-flex gap-2 align-items-center">
                                    <small class="text-muted">Rows:</small>
                                    <select class="form-select form-select-sm" id="aiHistoryPageSize" style="width: auto;">
                                        <option value="10">10</option>
                                        <option value="20" selected>20</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== TRADINGVIEW TAB ===================== -->
        <div class="tab-pane fade" id="tv-pane" role="tabpanel" aria-labelledby="tv-tab">
            <div class="card mb-3">
                <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div>
                        <h5 class="mb-1">TradingView Relay</h5>
                        <p class="text-muted small mb-0">
                            Live OHLCV bars forwarded from your TradingView alerts. Pick a stream to see the AI signal generated from those exact candles.
                        </p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-light btn-sm" type="button" id="tvRefreshBtn">
                            Refresh Streams
                        </button>
                        <button class="btn btn-outline-light btn-sm" type="button" id="tvDetailRefreshBtn" disabled>
                            Refresh Selected
                        </button>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-12 col-lg-5">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Active Streams</h6>
                                <small class="text-muted" id="tvStreamsStatus">No webhook data yet.</small>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Last Price</th>
                                        <th>Bars</th>
                                        <th>Signal</th>
                                        <th>RR</th>
                                        <th>Conf</th>
                                        <th>Updated</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tvStreamsBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-3">
                                            Waiting for TradingView webhook data.
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-7">
                    <div class="card h-100 mb-3" id="tvSignalCard">
                        <div class="card-body">
                            <p class="text-center text-muted mb-0">
                                Select a stream on the left to load its latest AI decision packet.
                            </p>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Chart</h6>
                                <small class="text-muted">Candles + volume with AI overlays.</small>
                            </div>
                            <button class="btn btn-sm btn-outline-light" id="tvRefreshChartBtn">Refresh</button>
                        </div>
                        <div class="card-body" style="height: 360px;">
                            <div id="tvChartContainer" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Live Breakouts</h6>
                                <small class="text-muted">Today by default; toggle 3d for context.</small>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-light active" id="liveBreakoutsToday" type="button">Today</button>
                                <button class="btn btn-outline-light" id="liveBreakouts3d" type="button">3 days</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-hover mb-0 small align-middle">
                                    <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>TF</th>
                                        <th>Event</th>
                                        <th>Trigger</th>
                                        <th>RVOL</th>
                                        <th>AI</th>
                                        <th>Conf</th>
                                    </tr>
                                    </thead>
                                    <tbody id="liveBreakoutsBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-3">No live breakouts yet.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== AI SIGNALS TAB ===================== -->
        <div class="tab-pane fade" id="ai-signals" role="tabpanel" aria-labelledby="ai-signals-tab">
            <div class="container-fluid py-3">
                <div class="row g-3">
                    <div class="col-lg-4">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header">
                                <strong>Signal Request</strong>
                            </div>
                            <div class="card-body">
                                <form id="aiSignalForm">
                                    <div class="mb-3">
                                        <label for="symbolInput" class="form-label">Symbol</label>
                                        <input type="text" class="form-control" id="symbolInput" value="SPY" required>
                                        <div class="form-text">Examples: SPY, AAPL, NVDA, TSLA</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="timeframeInput" class="form-label">Timeframe</label>
                                        <select class="form-select" id="timeframeInput">
                                            <option value="5m" selected>5m (Day)</option>
                                            <option value="15m">15m</option>
                                            <option value="1h">1h</option>
                                            <option value="1D">1D (Swing)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Trading Mode</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="modeRadio" id="modeDay" value="day" checked>
                                            <label class="btn btn-outline-primary" for="modeDay">Day Trade</label>
                                            <input type="radio" class="btn-check" name="modeRadio" id="modeSwing" value="swing">
                                            <label class="btn btn-outline-primary" for="modeSwing">Swing Trade</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Analysis Type</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="analysisRadio" id="analysisTech" value="technical" checked>
                                            <label class="btn btn-outline-secondary" for="analysisTech">Technical Only</label>
                                            <input type="radio" class="btn-check" name="analysisRadio" id="analysisNewsTech" value="news_tech">
                                            <label class="btn btn-outline-secondary" for="analysisNewsTech">News + Technical</label>
                                        </div>
                                        <div class="form-text">News+Tech uses an online model.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="runSignalBtn">
                                        Run AI Signal
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="card shadow-sm mb-3" id="latestSignalCard" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><strong>Latest Signal</strong></span>
                                <span class="badge bg-info text-dark" id="latestSignalModeBadge"></span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title" id="latestSignalTitle"></h5>
                                <p class="mb-1">
                                    <span class="badge" id="latestSignalStrengthBadge"></span>
                                    <span class="badge bg-secondary" id="latestSignalConfidence"></span>
                                </p>
                                <div class="row mt-3">
                                    <div class="col-4">
                                        <div class="small text-muted">Entry</div>
                                        <div id="latestSignalEntry" class="fw-semibold"></div>
                                    </div>
                                    <div class="col-4">
                                        <div class="small text-muted">Stop</div>
                                        <div id="latestSignalStop" class="fw-semibold text-danger"></div>
                                    </div>
                                    <div class="col-4">
                                        <div class="small text-muted">Target</div>
                                        <div id="latestSignalTarget" class="fw-semibold text-success"></div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="small text-muted">Risk:Reward</div>
                                    <div id="latestSignalRR" class="fw-semibold"></div>
                                </div>
                                <div class="mt-3">
                                    <div class="small text-muted">Time Horizon</div>
                                    <div id="latestSignalHorizon"></div>
                                </div>
                                <hr>
                                <p class="small" id="latestSignalReason"></p>
                                <div class="small text-muted mt-2">
                                    Last updated: <span id="latestSignalUpdatedAt"></span>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm" id="noSignalCard">
                            <div class="card-body">
                                <p class="mb-0 small text-muted">
                                    No AI signals yet. Run a signal above or wait for a TradingView breakout alert to reach <code>/tv-webhook</code>.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><strong>Recent Signals</strong></span>
                                <button class="btn btn-sm btn-outline-secondary" id="refreshSignalsBtn">Refresh</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="signalsTable">
                                        <thead class="table-light">
                                        <tr>
                                            <th>Time</th>
                                            <th>Symbol</th>
                                            <th>Mode</th>
                                            <th>Analysis</th>
                                            <th>Signal</th>
                                            <th>Entry</th>
                                            <th>Stop</th>
                                            <th>Target</th>
                                            <th>RR</th>
                                            <th>Conf%</th>
                                        </tr>
                                        </thead>
                                        <tbody id="signalsTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center text-muted small py-3">No signals yet.</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><strong>Live Breakout Feed</strong></span>
                                <small class="text-muted">From TradingView /tv-webhook</small>
                            </div>
                            <div class="card-body" style="max-height: 260px; overflow-y: auto;" id="breakoutFeed">
                                <p class="small text-muted mb-0">Waiting for breakout alerts...</p>
                            </div>
                        </div>

                        <div class="card shadow-sm mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><strong>Technical Snapshot (no AI)</strong></span>
                                <button class="btn btn-sm btn-outline-secondary" id="technicalSnapshotBtn">Load</button>
                            </div>
                            <div class="card-body" id="technicalSnapshotBody">
                                <p class="small text-muted mb-0">Latest persisted TradingView payload (trend/momentum/vol/structure) without AI inference.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- end tab-content -->
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.27.0/plotly.min.js"></script>
<script>
    // ------------- Theme handling -------------
    const themeSwitch = document.getElementById('themeSwitch');

    function applyTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-mode');
        } else {
            document.body.classList.remove('light-mode');
        }
        localStorage.setItem('theme', theme);
        themeSwitch.checked = theme !== 'light';
    }

    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);

    themeSwitch.addEventListener('change', () => {
        const newTheme = themeSwitch.checked ? 'dark' : 'light';
        applyTheme(newTheme);
    });

    // ------------- Scanner logic -------------
    const MARKET_CAPS = ['SmallCap', 'MidCap', 'LargeCap'];
    let allScanData = { SmallCap: [], MidCap: [], LargeCap: [] };
    let currentProfile = 'hedge_fund';
    let currentModel = 'reasoning';
    const PROFILE_LABELS = {
        hedge_fund: 'Hedge Fund PM',
        pro_trader: 'Pro Momentum',
        catalyst: 'News / SEC',
        bio_analyst: 'Biotech Catalyst',
        high_growth: 'High Growth'
    };
    const MODEL_LABELS = {
        reasoning: 'Reasoning (Deep Search)',
        pro: 'Classic (Fast)'
    };

    const runScanBtn = document.getElementById('runScanBtn');
    const lastUpdated = document.getElementById('lastUpdated');
    const scannerError = document.getElementById('scannerError');
    const modelStatus = document.getElementById('modelStatus');
    const fallbackToggle = document.getElementById('fallbackToggle');

    function clearScannerError() {
        if (!scannerError) return;
        scannerError.textContent = '';
        scannerError.classList.add('d-none');
    }

    function showScannerError(message) {
        if (!scannerError) return;
        scannerError.textContent = message;
        scannerError.classList.remove('d-none');
    }

    function stripHtml(text) {
        if (!text) return '';
        return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function setGrowthAnalysisMessage(message) {
        if (!growthAnalysisCard) return;
        growthAnalysisCard.innerHTML = `
            <div class="card-body">
                <p class="text-center text-muted mb-0">${message}</p>
            </div>
        `;
    }

    function toggleGrowthLayout(showGrowth) {
        if (scannerBucketsWrapper) scannerBucketsWrapper.classList.toggle('d-none', showGrowth);
        if (scannerAnalysisCardEl) scannerAnalysisCardEl.classList.toggle('d-none', showGrowth);
        if (growthResultsCard) growthResultsCard.classList.toggle('d-none', !showGrowth);
        if (growthAnalysisCard) {
            if (showGrowth) {
                growthAnalysisCard.classList.remove('d-none');
                setGrowthAnalysisMessage('Select a candidate above to load the full AI playbook.');
            } else {
                growthAnalysisCard.classList.add('d-none');
            }
        }
    }

    function renderGrowthTable() {
        toggleGrowthLayout(true);
        if (!growthTableBody) return;

        const list = Array.isArray(allScanData && allScanData.candidates)
            ? allScanData.candidates
            : [];
        const timestamp = allScanData && allScanData.timestamp;
        if (growthTimestamp) {
            const label = timestamp ? new Date(timestamp).toLocaleString() : '‚Äî';
            growthTimestamp.textContent = `Timestamp: ${label}`;
        }

        const formatField = (value) => {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') return String(value);
            const cleaned = stripHtml(String(value));
            return cleaned.length ? cleaned : '-';
        };

        if (!list.length) {
            growthTableBody.innerHTML = `
                <tr>
                    <td colspan="12" class="text-center text-muted py-3">
                        No high-growth candidates returned. Run the scan again.
                    </td>
                </tr>
            `;
            setGrowthAnalysisMessage('No candidates available yet. Run a scan to view details.');
            return;
        }

        growthTableBody.innerHTML = '';
        setGrowthAnalysisMessage('Select a candidate above to load the full AI playbook.');
        list.forEach(candidate => {
            const row = document.createElement('tr');
            const ticker = formatField(candidate.ticker).toUpperCase();
            row.innerHTML = `
                <td><span class="ticker-chip">${ticker || '-'}</span></td>
                <td>${formatField(candidate.company_name)}</td>
                <td>${formatField(candidate.sector)}</td>
                <td>${formatField(candidate.market_cap)}</td>
                <td>${formatField(candidate.growth_metric)}</td>
                <td>${formatField(candidate.growth_period)}</td>
                <td>${formatField(candidate.catalyst)}</td>
                <td>${formatField(candidate.data_source)}</td>
                <td>${formatField(candidate.institutional_ownership)}</td>
                <td>${formatField(candidate.risk_reward)}</td>
                <td>${formatField(candidate.technical_indicators)}</td>
                <td>${formatField(candidate.notes)}</td>
            `;
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => showGrowthAnalysis(candidate));
            growthTableBody.appendChild(row);
        });
    }

    async function showGrowthAnalysis(candidate) {
        if (!growthAnalysisCard) return;
        const title = stripHtml(String(candidate.company_name || candidate.ticker || 'Candidate'));
        growthAnalysisCard.innerHTML = `
            <div class="card-body">
                <p class="text-muted mb-0">Loading analysis for <strong>${title}</strong>‚Ä¶</p>
            </div>
        `;
        try {
            const resp = await fetch('/api/high-growth/analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ candidate })
            });
            const result = await resp.json();
            if (!resp.ok || !result.success) {
                throw new Error(result?.error || `Server error (${resp.status})`);
            }
            renderGrowthAnalysisCard(candidate, result.data || {});
        } catch (err) {
            console.error('High growth analysis error', err);
            setGrowthAnalysisMessage('Unable to load AI analysis. Please try again.');
        }
    }

    function renderGrowthAnalysisCard(candidate, analysis) {
        if (!growthAnalysisCard) return;
        const ticker = stripHtml(String(analysis.ticker || candidate.ticker || ''));
        const company = stripHtml(String(candidate.company_name || ''));
        const signal = String(analysis.signal || 'Hold');
        const badgeClass = signalClass(signal);
        const confidence = Number(analysis.confidence) || 0;
        const summary = stripHtml(String(analysis.summary || 'No summary provided.'));
        const thesisList = renderList(analysis.thesis);
        const catalystsList = renderList(analysis.catalysts);
        const risksList = renderList(analysis.risks);
        const levels = analysis.levels || {};
        const action = analysis.action_plan || {};
        const positioning = stripHtml(String(analysis.positioning || 'No positioning guidance.'));
        const disclaimer = stripHtml(String(analysis.disclaimer || 'This is not personalized financial advice.'));

        growthAnalysisCard.innerHTML = `
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">${ticker || '‚Äî'} ${company ? '‚Äì ' + company : ''}</h5>
                    <small class="text-muted">Signal confidence: ${confidence ? confidence.toFixed(1) + '/5' : 'N/A'}</small>
                </div>
                <span class="badge ${badgeClass}">${signal}</span>
            </div>
            <div class="card-body">
                <p class="mb-3">${summary}</p>
                <div class="row g-3">
                    <div class="col-12 col-lg-4">
                        <h6>Thesis</h6>
                        ${thesisList}
                        <h6 class="mt-3">Positioning</h6>
                        <p class="small mb-0">${positioning}</p>
                    </div>
                    <div class="col-12 col-lg-4">
                        <h6>Catalysts</h6>
                        ${catalystsList}
                        <h6 class="mt-3">Risks</h6>
                        ${risksList}
                    </div>
                    <div class="col-12 col-lg-4">
                        <h6>Levels</h6>
                        <ul class="small mb-3">
                            <li><strong>Support:</strong> ${stripHtml(String(levels.support || 'N/A'))}</li>
                            <li><strong>Resistance:</strong> ${stripHtml(String(levels.resistance || 'N/A'))}</li>
                            <li><strong>Invalidation:</strong> ${stripHtml(String(levels.invalidations || 'N/A'))}</li>
                        </ul>
                        <h6>Action Plan</h6>
                        <ul class="small mb-0">
                            <li><strong>Entry:</strong> ${stripHtml(String(action.entry || 'N/A'))}</li>
                            <li><strong>Target:</strong> ${stripHtml(String(action.target || 'N/A'))}</li>
                            <li><strong>Stop:</strong> ${stripHtml(String(action.stop || 'N/A'))}</li>
                        </ul>
                    </div>
                </div>
                <p class="text-muted small mt-3 mb-0">${disclaimer}</p>
            </div>
        `;
    }

    function renderList(items) {
        if (!Array.isArray(items) || !items.length) {
            return '<p class="small text-muted mb-0">No data provided.</p>';
        }
        const list = items
            .map(entry => `<li>${stripHtml(String(entry || ''))}</li>`)
            .join('');
        return `<ul class="small mb-0">${list}</ul>`;
    }

    function signalClass(signal) {
        const key = String(signal || '').toLowerCase();
        if (key.includes('strong buy')) return 'bg-success';
        if (key.includes('buy') || key.includes('accumulate')) return 'bg-primary';
        if (key.includes('hold')) return 'bg-warning text-dark';
        if (key.includes('reduce') || key.includes('avoid') || key.includes('sell')) return 'bg-danger';
        return 'bg-secondary';
    }

    const btnProfileHedge = document.getElementById('btnProfileHedge');
    const btnProfilePro = document.getElementById('btnProfilePro');
    const btnProfileCat = document.getElementById('btnProfileCat');
    const btnProfileBio = document.getElementById('btnProfileBio');
    const btnProfileGrowth = document.getElementById('btnProfileGrowth');
    const btnModelReasoning = document.getElementById('btnModelReasoning');
    const btnModelPro = document.getElementById('btnModelPro');
    const scannerBucketsWrapper = document.getElementById('scanner-buckets-wrapper');
    const scannerAnalysisCardEl = document.getElementById('scanner-analysis-card');
    const growthResultsCard = document.getElementById('growth-results-card');
    const growthTableBody = document.getElementById('growth-table-body');
    const growthTimestamp = document.getElementById('growth-timestamp');
    const growthAnalysisCard = document.getElementById('growth-analysis-card');

    function setProfile(profile) {
        currentProfile = profile;
        [btnProfileHedge, btnProfilePro, btnProfileCat, btnProfileBio, btnProfileGrowth].forEach(btn => btn && btn.classList.remove('active'));
        if (profile === 'hedge_fund') btnProfileHedge.classList.add('active');
        if (profile === 'pro_trader') btnProfilePro.classList.add('active');
        if (profile === 'catalyst') btnProfileCat.classList.add('active');
        if (profile === 'bio_analyst') btnProfileBio.classList.add('active');
        if (profile === 'high_growth') btnProfileGrowth.classList.add('active');
        toggleGrowthLayout(profile === 'high_growth');
    }

    btnProfileHedge.addEventListener('click', () => setProfile('hedge_fund'));
    btnProfilePro.addEventListener('click', () => setProfile('pro_trader'));
    btnProfileCat.addEventListener('click', () => setProfile('catalyst'));
    btnProfileBio.addEventListener('click', () => setProfile('bio_analyst'));
    btnProfileGrowth.addEventListener('click', () => setProfile('high_growth'));

    function setModel(model) {
        currentModel = model;
        [btnModelReasoning, btnModelPro].forEach(btn => btn.classList.remove('active'));
        if (model === 'reasoning') btnModelReasoning.classList.add('active');
        if (model === 'pro') btnModelPro.classList.add('active');
        if (modelStatus) {
            const label = MODEL_LABELS[model] || model;
            modelStatus.textContent = `Model: ${label}`;
        }
    }

    btnModelReasoning.addEventListener('click', () => setModel('reasoning'));
    btnModelPro.addEventListener('click', () => setModel('pro'));
    setModel(currentModel);

    async function fetchScan() {
        runScanBtn.disabled = true;
        runScanBtn.textContent = 'Scanning...';
        clearScannerError();

        try {
            const resp = await fetch('/api/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    profile: currentProfile,
                    model_variant: currentModel,
                    allow_fallback: Boolean(fallbackToggle?.checked)
                })
            });

            const raw = await resp.text();
            let result = null;
            try {
                result = JSON.parse(raw);
            } catch (parseErr) {
                result = null;
            }

            if (!resp.ok) {
                const message = result?.error || stripHtml(raw) || `Server error (${resp.status}).`;
                throw new Error(message);
            }

            if (!result || typeof result !== 'object') {
                throw new Error('Scanner returned an unreadable response. Please retry.');
            }

            if (!result.success) {
                console.error('Scanner error:', result.error);
                showScannerError('Scanner error: ' + (result.error || 'Unknown error'));
                return;
            }

            allScanData = result.data || { SmallCap: [], MidCap: [], LargeCap: [] };
            renderScannerTables();
            const meta = result.meta || {};
            if (lastUpdated) {
                lastUpdated.textContent = 'Last scan: ' + new Date().toLocaleTimeString();
            }
            if (meta.model) {
                setModel(meta.model === 'sonar-pro' ? 'pro' : 'reasoning');
            }
            const info = document.getElementById('scanner-info');
            if (info) {
                const lines = [];
                if (meta.model) {
                    lines.push(`Model in use: ${meta.model}`);
                }
                if (typeof meta.fallback_allowed === 'boolean') {
                    lines.push(`Fallback: ${meta.fallback_allowed ? 'enabled' : 'disabled'}`);
                }
                if (meta.fallback_used) {
                    lines.push('Fallback scan ran to add more names.');
                }
                if (meta.notes) {
                    lines.push(meta.notes);
                }
                if (lines.length) {
                    info.textContent = lines.join(' ‚Ä¢ ');
                    info.classList.remove('d-none');
                } else {
                    info.textContent = '';
                    info.classList.add('d-none');
                }
            }
        } catch (err) {
            console.error('Scanner fetch error', err);
            showScannerError('Scanner error: ' + (err?.message || 'Scanner failed due to server error.'));
        } finally {
            runScanBtn.disabled = false;
            runScanBtn.textContent = 'Run Scanner';
        }
    }

    runScanBtn.addEventListener('click', fetchScan);

    function renderScannerTables() {
        if (currentProfile === 'high_growth') {
            renderGrowthTable();
            return;
        }

        toggleGrowthLayout(false);
        MARKET_CAPS.forEach(cap => {
            const tbody = document.getElementById(cap + '-table');
            tbody.innerHTML = '';

            const alerts = allScanData[cap] || [];
            const valid = alerts.filter(a => a && typeof a === 'object' && a.Ticker);

            if (valid.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-3">No candidates returned for this tier.</td>
                    </tr>
                `;
                return;
            }

            valid.forEach(alert => {
                const tr = document.createElement('tr');
                const ticker = (alert.Ticker || '').toUpperCase();
                const entry = (typeof alert.EntryPrice === 'number')
                    ? alert.EntryPrice.toFixed(2)
                    : String(alert.EntryPrice || '-');
                const tgt = (typeof alert.TargetPrice === 'number')
                    ? alert.TargetPrice.toFixed(2)
                    : String(alert.TargetPrice || '-');
                const gain = (typeof alert.PotentialGainPercent === 'number')
                    ? alert.PotentialGainPercent.toFixed(2)
                    : '-';

                const catalyst = (alert.PrimaryCatalyst || '').toLowerCase();
                const hasCat = catalyst.includes('sec') ||
                    catalyst.includes('fda') ||
                    catalyst.includes('earnings') ||
                    catalyst.includes('news') ||
                    catalyst.includes('partnership') ||
                    catalyst.includes('merger');

                const badgeText = hasCat ? 'CATALYST' : 'TECH';
                const badgeClass = hasCat ? 'bg-danger' : 'bg-info';

                tr.innerHTML = `
                    <td>
                        <span class="ticker-chip">${ticker}</span>
                        <span class="badge ${badgeClass} ms-1">${badgeText}</span>
                    </td>
                    <td>$${entry}</td>
                    <td>
                        <span class="gain-chip">+${gain}%</span>
                        <span class="text-muted small ms-1">@${tgt === '-' ? '-' : '$' + tgt}</span>
                    </td>
                `;

                tr.addEventListener('click', () => {
                    showScannerAnalysisCard(cap, ticker);
                });

                tbody.appendChild(tr);
            });
        });
    }

    async function loadScannerHistory(ticker) {
        const container = document.getElementById('scanner-history-inner');
        if (!container) return;

        container.innerHTML = `<p class="text-muted small mb-0">Loading history‚Ä¶</p>`;

        try {
            const resp = await fetch('/api/history?ticker=' + encodeURIComponent(ticker));
            const result = await resp.json();
            if (!result.success) {
                container.innerHTML = `<p class="text-muted small mb-0">No history data available.</p>`;
                return;
            }

            const rows = result.data || [];
            if (!rows.length) {
                container.innerHTML = `<p class="text-muted small mb-0">No prior alerts recorded for this ticker yet.</p>`;
                return;
            }

            let html = `
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-sm mb-0 history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Profile</th>
                        <th>Tier</th>
                        <th>Entry</th>
                        <th>Scan Px</th>
                        <th>Now</th>
                        <th>% from Entry</th>
                      </tr>
                    </thead>
                    <tbody>
            `;

            rows.forEach(r => {
                const date = r.date || '';
                const time = r.time || '';
                const profile = r.profile_label || r.profile || '';
                const tier = r.tier || '';
                const entry = (typeof r.entry === 'number') ? r.entry.toFixed(2) : (r.entry || '-');
                const scanPx = (typeof r.scan_price === 'number') ? r.scan_price.toFixed(2) : (r.scan_price || '-');
                const nowPx = (typeof r.current_price === 'number') ? r.current_price.toFixed(2) : (r.current_price || '-');
                const pct = (typeof r.current_change_pct === 'number') ? (r.current_change_pct.toFixed(2) + '%') : '-';

                html += `
                    <tr>
                      <td>${date} <span class="text-muted small">${time}</span></td>
                      <td>${profile}</td>
                      <td>${tier}</td>
                      <td>$${entry}</td>
                      <td>${scanPx === '-' ? '-' : '$' + scanPx}</td>
                      <td>${nowPx === '-' ? '-' : '$' + nowPx}</td>
                      <td>${pct}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                  </table>
                </div>
            `;
            container.innerHTML = html;
        } catch (err) {
            console.error('History fetch error', err);
            container.innerHTML = `<p class="text-muted small mb-0">Error loading history.</p>`;
        }
    }

    function showScannerAnalysisCard(cap, ticker) {
        if (currentProfile === 'high_growth') return;
        const card = document.getElementById('scanner-analysis-card');
        const bucket = allScanData[cap] || [];
        const alert = bucket.find(a => (a.Ticker || '').toUpperCase() === ticker.toUpperCase());

        if (!alert) {
            card.innerHTML = `
                <div class="card-body">
                    <p class="text-center text-muted mb-0">No analysis found for ${ticker}.</p>
                </div>
            `;
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }

        const entry = (typeof alert.EntryPrice === 'number')
            ? alert.EntryPrice.toFixed(2)
            : String(alert.EntryPrice || '-');
        const target = (typeof alert.TargetPrice === 'number')
            ? alert.TargetPrice.toFixed(2)
            : String(alert.TargetPrice || '-');
        const stop = (typeof alert.StopPrice === 'number')
            ? alert.StopPrice.toFixed(2)
            : String(alert.StopPrice || '-');
        const gain = (typeof alert.PotentialGainPercent === 'number')
            ? alert.PotentialGainPercent.toFixed(2)
            : String(alert.PotentialGainPercent || '-');

        const rawAnalysis = alert.DetailedAnalysis || '';
        const bullets = String(rawAnalysis)
            .split('\n')
            .map(x => x.trim())
            .filter(x => x.length > 0);

        const listItems = bullets.map(b => `<li>${b.replace(/^[*-]\s*/, '')}</li>`).join('');

        card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">${ticker} ‚Äì Trading Plan</h5>
                    <small class="text-muted">Tier: ${cap}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary">Profile: ${PROFILE_LABELS[currentProfile] || currentProfile}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6 border-end border-secondary-subtle">
                        <h6 class="mb-2">Trade Setup & Thesis</h6>
                        ${listItems ? `<ul class="small mb-2">${listItems}</ul>` : `
                            <p class="text-muted small mb-2">No detailed thesis text returned by AI.</p>
                        `}
                        <p class="small mb-0">
                            <strong>Primary catalyst:</strong>
                            <span class="text-muted">${alert.PrimaryCatalyst || 'None / purely technical'}</span>
                        </p>
                    </div>
                    <div class="col-12 col-md-6">
                        <h6 class="mb-2">Levels & Risk</h6>
                        <p class="mb-1"><strong>Entry:</strong> $${entry}</p>
                        <p class="mb-1"><strong>Target:</strong> $${target}</p>
                        <p class="mb-1"><strong>Stop:</strong> $${stop}</p>
                        <p class="mb-1">
                            <strong>Potential Gain:</strong>
                            <span class="gain-chip">${gain}%</span>
                        </p>
                        ${
                            alert.RealTimePrice
                                ? `<p class="mb-1 small text-muted">
                                       Real-time price (Finnhub): $${alert.RealTimePrice.toFixed(2)}
                                       ${alert.AIEntryPrice ? `(AI originally suggested ~$${Number(alert.AIEntryPrice).toFixed(2)})` : ''}
                                   </p>`
                                : ''
                        }
                        <p class="small text-muted mt-2 mb-0">
                            This is an idea-generation tool, not investment advice. Always size risk appropriately.
                        </p>
                    </div>
                </div>

                <hr class="my-3 border-secondary-subtle">

                <h6 class="mb-2">Alert History for ${ticker}</h6>
                <div id="scanner-history-inner" class="small text-muted">
                    Loading history‚Ä¶
                </div>
            </div>
        `;

        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        loadScannerHistory(ticker);
    }

    // ------------- News logic -------------
    const newsListEl = document.getElementById('news-list');
    const refreshNewsBtn = document.getElementById('refreshNewsBtn');
    const watchInput = document.getElementById('watchInput');
    const watchAddBtn = document.getElementById('watchAddBtn');
    const watchlistPills = document.getElementById('watchlistPills');
    const topicChipBar = document.getElementById('topicChips');
    let allNews = [];
    let watchlist = [];
    const activeTopics = new Set();

    const topicKeywords = {
        ai: ['ai', 'artificial intelligence', 'automation', 'machine learning', 'gen ai'],
        quantum: ['quantum', 'qubit', 'photonic', 'quantum computing'],
        bio: ['biotech', 'biotechnology', 'drug', 'trial', 'fda', 'healthtech', 'lifescience', 'life science'],
        renewable: ['renewable', 'solar', 'wind', 'cleantech', 'clean tech', 'ev', 'battery', 'hydrogen', 'geothermal'],
        cyber: ['cybersecurity', 'ransomware', 'cloud', 'data breach', 'zero trust', 'security'],
        synbio: ['synthetic biology', 'synbio', 'crispr', 'gene editing'],
        bci: ['bci', 'brain computer', 'brain-computer', 'neurotech', 'neuralink'],
        nuclear: ['nuclear', 'fusion', 'fission', 'uranium', 'reactor']
    };

    const topicSynonyms = {
        'ai': 'ai',
        'ai & automation': 'ai',
        'automation': 'ai',
        'artificial intelligence': 'ai',
        'machine learning': 'ai',
        'quantum': 'quantum',
        'quantum computing': 'quantum',
        'quantum tech': 'quantum',
        'biotech': 'bio',
        'biotech & healthtech': 'bio',
        'healthtech': 'bio',
        'renewable': 'renewable',
        'renewable & cleantech': 'renewable',
        'cleantech': 'renewable',
        'green energy': 'renewable',
        'cybersecurity': 'cyber',
        'cybersecurity & cloud': 'cyber',
        'cloud': 'cyber',
        'synthetic biology': 'synbio',
        'synbio': 'synbio',
        'bci': 'bci',
        'bci & neurotech': 'bci',
        'neurotech': 'bci',
        'advanced nuclear': 'nuclear',
        'nuclear': 'nuclear'
    };

    const nameToTicker = {
        tesla: 'TSLA',
        'elon musk': 'TSLA',
        nvidia: 'NVDA',
        nvda: 'NVDA',
        apple: 'AAPL',
        microsoft: 'MSFT',
        meta: 'META',
        facebook: 'META',
        google: 'GOOGL',
        alphabet: 'GOOGL',
        amazon: 'AMZN',
        palantir: 'PLTR',
        soundhound: 'SOUN',
        'johnson & johnson': 'JNJ',
        'johnson and johnson': 'JNJ',
        broadcom: 'AVGO',
        supermicro: 'SMCI',
        amd: 'AMD',
        rivian: 'RIVN'
    };

    const tickerSmartKeywords = {
        TSLA: ['tesla', 'elon musk', 'electric vehicle', 'ev ', 'evs', 'electric car', 'cybertruck', 'gigafactory', 'model 3', 'model y'],
        NVDA: ['nvidia', 'ai chip', 'gpu', 'graphics card', 'cuda', 'h100', 'blackwell'],
        AMD: ['amd', 'advanced micro devices', 'ryzen', 'radeon', 'gpu', 'chipmaker'],
        AAPL: ['apple', 'iphone', 'ipad', 'macbook', 'vision pro'],
        MSFT: ['microsoft', 'windows', 'azure', 'copilot'],
        AMZN: ['amazon', 'aws', 'prime video', 'prime day'],
        META: ['meta', 'facebook', 'instagram', 'threads', 'oculus'],
        GOOG: ['google', 'alphabet', 'search', 'android'],
        GOOGL: ['google', 'alphabet', 'search', 'android'],
        RIVN: ['rivian', 'ev truck', 'electric truck']
    };

    function loadPersistedFilters() {
        try {
            const savedWatch = JSON.parse(localStorage.getItem('newsWatchlist') || '[]');
            if (Array.isArray(savedWatch)) {
                watchlist = savedWatch.slice(0, 25).filter(Boolean);
            }
            const savedTopics = JSON.parse(localStorage.getItem('newsTopics') || '[]');
            if (Array.isArray(savedTopics)) {
                savedTopics.forEach(topic => {
                    if (topic && topicKeywords[topic]) {
                        activeTopics.add(topic);
                    }
                });
            }
        } catch (err) {
            console.warn('Failed to load saved filters', err);
        }
    }

    function persistWatchlist() {
        try {
            localStorage.setItem('newsWatchlist', JSON.stringify(watchlist));
        } catch (err) {
            console.warn('Unable to persist watchlist', err);
        }
    }

    function persistTopics() {
        try {
            localStorage.setItem('newsTopics', JSON.stringify(Array.from(activeTopics)));
        } catch (err) {
            console.warn('Unable to persist topics', err);
        }
    }

    function normalizeText(value) {
        return (value || '').toString().toLowerCase();
    }

    function normalizeWatchValue(value) {
        if (!value) return '';
        const trimmed = value.trim();
        if (!trimmed) return '';
        const isTicker = /^[A-Za-z]{1,6}$/.test(trimmed);
        if (isTicker) return trimmed.toUpperCase();
        return trimmed.replace(/\s+/g, ' ');
    }

    function matchesWatchlist(article) {
        if (!watchlist.length) return true;
        const tickers = (article.tickers || []).map(t => t.toUpperCase());
        const text = normalizeText(`${article.headline || ''} ${article.summary || ''}`);
        return watchlist.some(item => {
            const lowered = normalizeText(item);
            const mapped = nameToTicker[lowered];
            const isTicker = /^[A-Z]{1,6}$/.test(item);
            if (isTicker && tickers.includes(item)) return true;
            if (mapped && tickers.includes(mapped)) return true;
            if (isTicker) {
                const keywords = tickerSmartKeywords[item] || [];
                if (keywords.some(keyword => text.includes(keyword))) return true;
            }
            if (mapped) {
                const mappedKeywords = tickerSmartKeywords[mapped] || [];
                if (mappedKeywords.some(keyword => text.includes(keyword))) return true;
            }
            const topicKey = topicSynonyms[lowered];
            if (topicKey && topicKeywords[topicKey]) {
                const topicWords = topicKeywords[topicKey];
                if (topicWords.some(word => text.includes(word))) return true;
            }
            return lowered && text.includes(lowered);
        });
    }

    function matchesTopics(article) {
        if (!activeTopics.size) return true;
        const text = normalizeText(`${article.headline || ''} ${article.summary || ''}`);
        for (const topic of activeTopics) {
            const keywords = topicKeywords[topic] || [];
            if (keywords.some(word => text.includes(word))) {
                return true;
            }
        }
        return false;
    }

    function applyNewsFilters(items) {
        if (!watchlist.length && !activeTopics.size) return items;
        return items.filter(article => matchesWatchlist(article) && matchesTopics(article));
    }

    function renderWatchlistPills() {
        if (!watchlistPills) return;
        watchlistPills.innerHTML = '';
        if (!watchlist.length) {
            watchlistPills.innerHTML = '<span class="text-muted small">No watchlist yet.</span>';
            return;
        }
        watchlist.forEach(item => {
            const pill = document.createElement('span');
            pill.className = 'watch-pill';

            const label = document.createElement('span');
            label.textContent = item;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'watch-pill-remove';
            removeBtn.dataset.remove = item;
            removeBtn.textContent = '√ó';

            pill.appendChild(label);
            pill.appendChild(removeBtn);
            watchlistPills.appendChild(pill);
        });
    }

    function syncTopicChips() {
        if (!topicChipBar) return;
        const chips = topicChipBar.querySelectorAll('.topic-chip');
        chips.forEach(chip => {
            const topic = chip.dataset.topic;
            if (topic === 'all') {
                chip.classList.toggle('active', !activeTopics.size);
            } else {
                chip.classList.toggle('active', activeTopics.has(topic));
            }
        });
    }

    function rerenderNewsIfReady() {
        if (allNews.length) {
            renderNews(allNews);
        }
    }

    function addWatchItem(value) {
        const normalized = normalizeWatchValue(value);
        if (!normalized) return;
        if (watchlist.length >= 25) return;
        if (watchlist.some(item => item.toLowerCase() === normalized.toLowerCase())) return;
        watchlist.push(normalized);
        persistWatchlist();
        renderWatchlistPills();
        rerenderNewsIfReady();
    }

    function removeWatchItem(value) {
        watchlist = watchlist.filter(item => item !== value);
        persistWatchlist();
        renderWatchlistPills();
        rerenderNewsIfReady();
    }

    async function fetchNews() {
        newsListEl.innerHTML = `
            <div class="text-center text-muted py-3 small">
                Loading headlines...
            </div>
        `;
        try {
            const resp = await fetch('/api/news/headlines?limit=80');
            const result = await resp.json();
            if (!result.success) {
                newsListEl.innerHTML = `
                    <div class="text-center text-muted py-3 small">
                        Failed to load news.
                    </div>
                `;
                return;
            }
            allNews = Array.isArray(result.data) ? result.data : [];
            renderNews(allNews);
        } catch (err) {
            console.error('News fetch error', err);
            newsListEl.innerHTML = `
                <div class="text-center text-muted py-3 small">
                    Error loading news.
                </div>
            `;
        }
    }

    refreshNewsBtn?.addEventListener('click', fetchNews);

    watchAddBtn?.addEventListener('click', () => {
        addWatchItem(watchInput.value);
        watchInput.value = '';
    });

    watchInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            addWatchItem(watchInput.value);
            watchInput.value = '';
        }
    });

    watchlistPills?.addEventListener('click', (event) => {
        const btn = event.target.closest('.watch-pill-remove');
        if (!btn) return;
        removeWatchItem(btn.dataset.remove || '');
    });

    topicChipBar?.addEventListener('click', (event) => {
        const chip = event.target.closest('.topic-chip');
        if (!chip) return;
        const topic = chip.dataset.topic;
        if (!topic) return;

        if (topic === 'all') {
            activeTopics.clear();
        } else {
            if (activeTopics.has(topic)) {
                activeTopics.delete(topic);
            } else {
                activeTopics.add(topic);
            }
        }
        persistTopics();
        syncTopicChips();
        rerenderNewsIfReady();
    });

    loadPersistedFilters();
    renderWatchlistPills();
    syncTopicChips();

    function renderNews(items) {
        const filteringActive = Boolean(watchlist.length || activeTopics.size);
        const list = filteringActive ? applyNewsFilters(items) : items;

        if (!list.length) {
            newsListEl.innerHTML = `
                <div class="text-center text-muted py-3 small">
                    ${filteringActive ? 'No headlines match the current watchlist/topic filters.' : 'No headlines returned.'}
                </div>
            `;
            return;
        }

        newsListEl.innerHTML = '';
        list.forEach(article => {
            const div = document.createElement('div');
            div.className = 'list-group-item list-group-item-action bg-transparent text-reset';

            const ts = article.published_ts ? new Date(article.published_ts * 1000) : null;
            const timeStr = ts ? ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

            const tickers = (article.tickers || []).slice(0, 4).join(', ');

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="small text-muted mb-1">
                            ${article.source || article.provider || 'Source'} ‚Ä¢ ${timeStr}
                        </div>
                        <div class="headline-title mb-1">${article.headline || ''}</div>
                        <div class="headline-summary mb-2">
                            ${article.summary ? article.summary.slice(0, 180) + (article.summary.length > 180 ? '‚Ä¶' : '') : ''}
                        </div>
                        ${
                            tickers
                                ? `<div class="small text-muted">Tickers: <span class="ticker-chip">${tickers}</span></div>`
                                : ''
                        }
                    </div>
                    <div class="ms-2 text-end">
                        <button class="btn btn-sm btn-ai-analysis mb-2">AI Analysis</button>
                        <div>
                            <a href="${article.url || '#'}" target="_blank" class="small text-muted">Open</a>
                        </div>
                    </div>
                </div>
            `;

            const btn = div.querySelector('button');
            btn.addEventListener('click', () => analyzeHeadline(article));

            newsListEl.appendChild(div);
        });
    }

    async function analyzeHeadline(article) {
        const card = document.getElementById('news-analysis-card');
        card.innerHTML = `
            <div class="card-body">
                <h5 class="mb-2">AI News Lens</h5>
                <p class="text-muted small mb-2">Analyzing headline with trading focus‚Ä¶</p>
                <div class="text-center py-3">
                    <div class="spinner-border text-info" role="status" style="width: 1.8rem; height: 1.8rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        `;

        try {
            const resp = await fetch('/api/news/analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article })
            });
            const result = await resp.json();
            if (!result.success) {
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="mb-2">AI News Lens</h5>
                        <p class="text-danger small mb-2">
                            Analysis failed: ${result.error || 'Unknown error.'}
                        </p>
                        <p class="text-muted small mb-0">
                            Click ‚ÄúAI Analysis‚Äù again or choose another headline.
                        </p>
                    </div>
                `;
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            renderNewsAnalysis(article, result.data);
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (err) {
            console.error('News analysis error', err);
            card.innerHTML = `
                <div class="card-body">
                    <h5 class="mb-2">AI News Lens</h5>
                    <p class="text-danger small mb-2">
                        Analysis failed due to server error.
                    </p>
                    <p class="text-muted small mb-0">
                        Try again in a moment.
                    </p>
                </div>
            `;
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function renderNewsAnalysis(article, analysis) {
        const card = document.getElementById('news-analysis-card');

        const stance = (analysis.stance || 'neutral').toLowerCase();
        const impact = (analysis.impact_level || 'medium').toLowerCase();

        let stanceBadgeClass = 'badge-stance-neutral';
        if (stance === 'bullish') stanceBadgeClass = 'badge-stance-bullish';
        else if (stance === 'bearish') stanceBadgeClass = 'badge-stance-bearish';
        else if (stance === 'mixed') stanceBadgeClass = 'badge-stance-mixed';

        let impactBadgeClass = 'badge-impact-medium';
        if (impact === 'low') impactBadgeClass = 'badge-impact-low';
        else if (impact === 'high') impactBadgeClass = 'badge-impact-high';

        const factors = Array.isArray(analysis.rationale) ? analysis.rationale : [];
        const factorList = factors.length
            ? factors.map(f => `<li>${f}</li>`).join('')
            : '<li>No specific key factors returned.</li>';

        const tickers = (article.tickers || []).slice(0, 4).join(', ');

        card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">AI View: ${article.headline || ''}</h5>
                    ${
                        tickers
                            ? `<small class="text-muted">Tickers: ${tickers}</small>`
                            : ''
                    }
                </div>
                <div class="text-end">
                    <span class="badge ${stanceBadgeClass} me-1 text-uppercase small">${stance}</span>
                    <span class="badge ${impactBadgeClass} text-uppercase small">${impact} impact</span>
                </div>
            </div>
            <div class="card-body">
                <p class="small mb-2">${analysis.summary || ''}</p>

                <h6 class="mt-3 mb-2">Key Factors (trader lens)</h6>
                <ul class="small mb-3">
                    ${factorList}
                </ul>

                <p class="small text-muted mb-1">${analysis.risk_notes || ''}</p>
                <p class="small text-muted mb-0">${analysis.disclaimer || ''}</p>
            </div>
        `;
    }

    // ------------- Economic calendar logic -------------
    const econRangeSelect = document.getElementById('econRangeSelect');
    const econCurrencyInput = document.getElementById('econCurrencyInput');
    const econTzSelect = document.getElementById('econTzSelect');
    const econImpactChecks = document.querySelectorAll('input[data-econ-impact]');
    const econRefreshBtn = document.getElementById('econRefreshBtn');
    const econStatus = document.getElementById('econStatus');
    const econTableBody = document.getElementById('econ-table-body');
    const econImpactClassMap = {
        high: 'badge bg-danger-subtle text-danger',
        medium: 'badge bg-warning-subtle text-warning',
        low: 'badge bg-success-subtle text-success'
    };
    let econCurrencyDebounce = null;

    function getSelectedImpacts() {
        if (!econImpactChecks || !econImpactChecks.length) return [];
        return Array.from(econImpactChecks)
            .filter(check => check.checked && check.dataset.econImpact)
            .map(check => check.dataset.econImpact.toLowerCase());
    }

    function getSelectedCurrencies() {
        if (!econCurrencyInput) return [];
        return (econCurrencyInput.value || '')
            .split(/[, ]+/)
            .map(token => token.trim().toUpperCase())
            .filter(Boolean)
            .slice(0, 10);
    }

    function setEconStatus(message, isError = false) {
        if (!econStatus) return;
        econStatus.textContent = message;
        econStatus.classList.toggle('text-danger', isError);
        econStatus.classList.toggle('text-muted', !isError);
    }

    function buildEconQueryParams() {
        const params = new URLSearchParams();
        const rangeValue = econRangeSelect?.value || 'week';
        if (rangeValue === 'custom') {
            params.set('range', 'custom');
            params.set('days', '10');
        } else {
            params.set('range', rangeValue);
        }
        const impacts = getSelectedImpacts();
        if (impacts.length) params.set('impacts', impacts.join(','));
        const currencies = getSelectedCurrencies();
        if (currencies.length) params.set('currencies', currencies.join(','));
        if (econTzSelect) {
            params.set('tz_offset', econTzSelect.value || '0');
        }
        params.set('limit', '120');
        return params;
    }

    function formatEconValue(value, unit) {
        if (value === null || value === undefined || value === '') return '‚Äî';
        const text = typeof value === 'number' ? value.toString() : String(value);
        if (unit && !text.includes(unit)) {
            return `${text} ${unit}`;
        }
        return text;
    }

    function formatRelativeTime(epochMs) {
        if (!epochMs) return '';
        const diffMs = epochMs - Date.now();
        const absMinutes = Math.max(1, Math.round(Math.abs(diffMs) / 60000));
        let label;
        if (absMinutes < 60) {
            label = `${absMinutes}m`;
        } else if (absMinutes < 60 * 24) {
            label = `${Math.round(absMinutes / 60)}h`;
        } else {
            label = `${Math.round(absMinutes / (60 * 24))}d`;
        }
        return diffMs >= 0 ? `in ${label}` : `${label} ago`;
    }

    function formatDateDisplay(value, options = {}) {
        if (!value) return '';
        try {
            const date = new Date(value);
            const formatterOptions = Object.assign({
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }, options);
            return date.toLocaleString([], formatterOptions);
        } catch (err) {
            return value;
        }
    }

    function renderEconTable(events) {
        if (!econTableBody) return;
        if (!events.length) {
            econTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        No events match the current filters.
                    </td>
                </tr>
            `;
            return;
        }
        econTableBody.innerHTML = '';
        events.forEach(event => {
            const fallbackLocal = formatDateDisplay(event.time_local);
            const fallbackUtc = formatDateDisplay(event.time_utc, { timeZone: 'UTC' });
            const localLabel = event.time_local_label || fallbackLocal || '‚Äî';
            const utcLabel = event.time_utc_label || (fallbackUtc ? `${fallbackUtc} UTC` : '');
            const impactKey = (event.impact || '').toLowerCase();
            const impactClass = econImpactClassMap[impactKey] || 'badge bg-secondary-subtle text-secondary';
            const impactLabel = impactKey ? impactKey.toUpperCase() : 'N/A';
            const actualText = formatEconValue(event.actual, event.unit);
            const forecastText = formatEconValue(event.forecast, event.unit);
            const previousText = formatEconValue(event.previous, event.unit);
            const status = event.status || 'unknown';
            const statusBadgeClass = status === 'future'
                ? 'badge bg-info-subtle text-info'
                : status === 'past'
                    ? 'badge bg-secondary-subtle text-secondary'
                    : 'badge bg-light text-dark';
            const statusLabel = status === 'future'
                ? 'Upcoming'
                : status === 'past'
                    ? 'Released'
                    : 'TBD';
            const relative = formatRelativeTime(event.time_epoch_ms);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="fw-semibold">${localLabel}</div>
                    <div class="small text-muted">${utcLabel || ''}</div>
                </td>
                <td>
                    <span class="${impactClass} econ-impact-pill">${impactLabel}</span>
                    <div class="small text-muted mt-1">${event.currency || '‚Äî'}</div>
                </td>
                <td>
                    <div class="event-title mb-1">${event.event || '‚Äî'}</div>
                    <div class="small text-muted">${event.country || ''}</div>
                </td>
                <td>
                    <div><strong>Actual:</strong> ${actualText}</div>
                    <div class="small text-muted">Forecast: ${forecastText} ‚Ä¢ Previous: ${previousText}</div>
                </td>
                <td>
                    <span class="${statusBadgeClass}">${statusLabel}</span>
                    ${relative ? `<div class="small text-muted mt-1">${relative}</div>` : ''}
                </td>
            `;
            econTableBody.appendChild(row);
        });
    }

    async function fetchEconCalendar() {
        if (!econTableBody) return;
        const params = buildEconQueryParams();
        econTableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    Loading macro events‚Ä¶
                </td>
            </tr>
        `;
        setEconStatus('Loading macro events‚Ä¶');
        try {
            const resp = await fetch(`/api/econ/calendar?${params.toString()}`);
            const result = await resp.json();
            if (!result.success) {
                setEconStatus(result.error || 'Unable to load the economic calendar.', true);
                econTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">
                            ${result.error || 'Unable to load the economic calendar.'}
                        </td>
                    </tr>
                `;
                return;
            }
            const events = Array.isArray(result.data) ? result.data : [];
            renderEconTable(events);
            const meta = result.meta || {};
            const metaRange = meta.range || (econRangeSelect?.value || 'week');
            const sourceLabel = (meta.source || '').toString().toUpperCase();
            const warningsList = Array.isArray(meta.warnings) ? meta.warnings.filter(Boolean) : [];
            const warningText = warningsList.length ? ` ‚Ä¢ ${warningsList.join(' | ')}` : '';
            const sourceText = sourceLabel ? ` ‚Ä¢ Source: ${sourceLabel}` : '';
            setEconStatus(`Showing ${events.length} event(s) ‚Ä¢ ${metaRange}${sourceText}${warningText}`);
        } catch (err) {
            console.error('Economic calendar error', err);
            setEconStatus('Failed to load the economic calendar.', true);
            econTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        Failed to load macro events. Retry in a moment.
                    </td>
                </tr>
            `;
        }
    }

    econRefreshBtn?.addEventListener('click', fetchEconCalendar);
    econRangeSelect?.addEventListener('change', fetchEconCalendar);
    econTzSelect?.addEventListener('change', fetchEconCalendar);
    econImpactChecks.forEach(check => {
        check.addEventListener('change', fetchEconCalendar);
    });
    econCurrencyInput?.addEventListener('input', () => {
        clearTimeout(econCurrencyDebounce);
        econCurrencyDebounce = setTimeout(fetchEconCalendar, 600);
    });

    if (econTableBody) {
        fetchEconCalendar();
    }

    const runSupertrendBtn = document.getElementById('runSupertrendBtn');
    const supertrendStatus = document.getElementById('supertrendStatus');
    const supertrendTableBody = document.getElementById('supertrend-table-body');
    const supertrendLastRun = document.getElementById('supertrendLastRun');
    const supertrendTickersInput = document.getElementById('supertrendTickersInput');
    const supertrendAtrPeriodInput = document.getElementById('supertrendAtrPeriod');
    const supertrendAtrMultInput = document.getElementById('supertrendAtrMult');

    function renderSupertrendRows(rows) {
        if (!supertrendTableBody) return;
        if (!rows.length) {
            supertrendTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-3">
                        No qualifying Supertrend ideas right now.
                    </td>
                </tr>
            `;
            return;
        }
        supertrendTableBody.innerHTML = '';
        rows.forEach(row => {
            const trendUp = row.trend_value === 1 || row.trend === 'Uptrend';
            const trendBadge = trendUp
                ? '<span class="badge bg-success-subtle text-success">Uptrend</span>'
                : '<span class="badge bg-danger-subtle text-danger">Downtrend</span>';
            const price = typeof row.close === 'number' ? `$${row.close.toFixed(2)}` : '‚Äî';
            const vwapVal = typeof row.anchored_vwap === 'number'
                ? `$${row.anchored_vwap.toFixed(2)}`
                : '‚Äî';
            const vwapDelta = typeof row.distance_from_vwap_pct === 'number'
                ? `${row.distance_from_vwap_pct >= 0 ? '+' : ''}${row.distance_from_vwap_pct.toFixed(2)}%`
                : '';
            const vwapCell = vwapDelta ? `${vwapVal}<div class="small text-muted">${vwapDelta}</div>` : vwapVal;
            const entry = typeof row.ai_entry === 'number'
                ? `$${row.ai_entry.toFixed(2)}`
                : price;
            const stop = typeof row.ai_stop === 'number'
                ? `$${row.ai_stop.toFixed(2)}`
                : (row.supertrend_support ? `$${Number(row.supertrend_support).toFixed(2)}` : '‚Äî');
            const target = typeof row.ai_target === 'number'
                ? `$${row.ai_target.toFixed(2)}`
                : '‚Äî';
            const catalyst = row.ai_catalyst || row.ai_notes || 'No AI context available.';
            const confidence = row.ai_confidence ? `${row.ai_confidence}/5` : '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="ticker-chip">${row.ticker || ''}</span></td>
                <td>${trendBadge}${row.buy_signal ? '<div class="small text-success">Fresh flip</div>' : ''}</td>
                <td>${price}</td>
                <td>${vwapCell}</td>
                <td>${entry}</td>
                <td>${stop}</td>
                <td>${target}</td>
                <td>
                    <div class="small">${catalyst}</div>
                </td>
                <td>${confidence}</td>
            `;
            supertrendTableBody.appendChild(tr);
        });
    }

    async function fetchSupertrendRadar() {
        if (!runSupertrendBtn) return;
        runSupertrendBtn.disabled = true;
        if (supertrendStatus) {
            supertrendStatus.textContent = 'Running Supertrend radar‚Ä¶';
        }
        try {
            const resp = await fetch('/api/supertrend/radar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tickers: supertrendTickersInput?.value || '',
                    atr_period: supertrendAtrPeriodInput?.value || undefined,
                    atr_multiplier: supertrendAtrMultInput?.value || undefined
                })
            });
            const result = await resp.json();
            if (!result.success) {
                if (supertrendStatus) {
                    supertrendStatus.textContent = result.error || 'Supertrend radar failed.';
                }
                return;
            }
            const signals = (result.data && result.data.signals) || [];
            renderSupertrendRows(signals);
            const meta = (result.data && result.data.meta) || {};
            if (supertrendLastRun) {
                supertrendLastRun.textContent = 'Last run: ' + new Date().toLocaleTimeString();
            }
            if (supertrendStatus) {
                let text = meta.generated_at ? `Generated at ${meta.generated_at}` : 'Supertrend radar complete.';
                if (Array.isArray(meta.tickers)) {
                    text += ` ‚Ä¢ Tickers: ${meta.tickers.join(', ')}`;
                }
                if (meta.settings) {
                    text += ` ‚Ä¢ ATR ${meta.settings.atr_period}/${meta.settings.atr_multiplier}`;
                }
                if (meta.warnings && meta.warnings.length) {
                    text += ' ‚Ä¢ ' + meta.warnings.join(' | ');
                }
                supertrendStatus.textContent = text;
            }
        } catch (err) {
            console.error('Supertrend radar error', err);
            if (supertrendStatus) {
                supertrendStatus.textContent = 'Failed to run radar. Try again shortly.';
            }
        } finally {
            runSupertrendBtn.disabled = false;
        }
    }

    runSupertrendBtn?.addEventListener('click', fetchSupertrendRadar);

    const runZigzagBtn = document.getElementById('runZigzagBtn');
    const zigzagStatus = document.getElementById('zigzagStatus');
    const zigzagTableBody = document.getElementById('zigzag-table-body');
    const zigzagLastRun = document.getElementById('zigzagLastRun');
    const zigzagTickersInput = document.getElementById('zigzagTickersInput');
    const zigzagDeviationInput = document.getElementById('zigzagDeviation');
    const zigzagBackstepInput = document.getElementById('zigzagBackstep');

    function renderZigzagRows(rows) {
        if (!zigzagTableBody) return;
        if (!rows.length) {
            zigzagTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-3">
                        No ZigZag swings triggered at the moment.
                    </td>
                </tr>
            `;
            return;
        }
        zigzagTableBody.innerHTML = '';
        rows.forEach(row => {
            const dir = row.direction || (row.ai_direction || '');
            const isBuy = (dir || '').toLowerCase().startsWith('buy');
            const dirBadge = isBuy
                ? '<span class="badge bg-success-subtle text-success">Buy</span>'
                : '<span class="badge bg-danger-subtle text-danger">Sell</span>';
            const pivotPrice = row.pivot_price ? `$${Number(row.pivot_price).toFixed(2)}` : '‚Äî';
            const vwapVal = typeof row.anchored_vwap === 'number'
                ? `$${row.anchored_vwap.toFixed(2)}`
                : '‚Äî';
            const vwapDelta = typeof row.distance_from_vwap_pct === 'number'
                ? `${row.distance_from_vwap_pct >= 0 ? '+' : ''}${row.distance_from_vwap_pct.toFixed(2)}%`
                : '';
            const vwapCell = vwapDelta ? `${vwapVal}<div class="small text-muted">${vwapDelta}</div>` : vwapVal;
            const entry = typeof row.ai_entry === 'number'
                ? `$${row.ai_entry.toFixed(2)}`
                : pivotPrice;
            const stop = typeof row.ai_stop === 'number'
                ? `$${row.ai_stop.toFixed(2)}`
                : (row.prior_pivot_price ? `$${Number(row.prior_pivot_price).toFixed(2)}` : '‚Äî');
            const target = typeof row.ai_target === 'number'
                ? `$${row.ai_target.toFixed(2)}`
                : '‚Äî';
            const catalyst = row.ai_catalyst || row.ai_notes || 'No AI commentary available.';
            const confidence = row.ai_confidence ? `${row.ai_confidence}/5` : '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="ticker-chip">${row.ticker || ''}</span></td>
                <td>${dirBadge}<div class="small text-muted">${row.pivot_time || ''}</div></td>
                <td>${pivotPrice}</td>
                <td>${vwapCell}</td>
                <td>${entry}</td>
                <td>${stop}</td>
                <td>${target}</td>
                <td><div class="small">${catalyst}</div></td>
                <td>${confidence}</td>
            `;
            zigzagTableBody.appendChild(tr);
        });
    }

    async function fetchZigzagRadar() {
        if (!runZigzagBtn) return;
        runZigzagBtn.disabled = true;
        if (zigzagStatus) zigzagStatus.textContent = 'Running ZigZag radar‚Ä¶';
        try {
            const resp = await fetch('/api/zigzag/radar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tickers: zigzagTickersInput?.value || '',
                    deviation: zigzagDeviationInput?.value || undefined,
                    backstep: zigzagBackstepInput?.value || undefined
                })
            });
            const result = await resp.json();
            if (!result.success) {
                if (zigzagStatus) zigzagStatus.textContent = result.error || 'ZigZag radar failed.';
                return;
            }
            const signals = (result.data && result.data.signals) || [];
            renderZigzagRows(signals);
            const meta = (result.data && result.data.meta) || {};
            if (zigzagLastRun) {
                zigzagLastRun.textContent = 'Last run: ' + new Date().toLocaleTimeString();
            }
            if (zigzagStatus) {
                let text = meta.generated_at ? `Generated at ${meta.generated_at}` : 'ZigZag radar complete.';
                if (meta.settings) {
                    text += ` ‚Ä¢ Deviation ${meta.settings.deviation}% | Backstep ${meta.settings.backstep} bars`;
                }
                if (Array.isArray(meta.tickers)) {
                    text += ` ‚Ä¢ Tickers: ${meta.tickers.join(', ')}`;
                }
                if (meta.warnings && meta.warnings.length) {
                    text += ' ‚Ä¢ ' + meta.warnings.join(' | ');
                }
                zigzagStatus.textContent = text;
            }
        } catch (err) {
            console.error('ZigZag radar error', err);
            if (zigzagStatus) zigzagStatus.textContent = 'Failed to run ZigZag radar. Try again.';
        } finally {
            runZigzagBtn.disabled = false;
        }
    }

    runZigzagBtn?.addEventListener('click', fetchZigzagRadar);

    const runDaytradeBtn = document.getElementById('runDaytradeBtn');
    const daytradeStatus = document.getElementById('daytradeStatus');
    const daytradeTableBody = document.getElementById('daytrade-table-body');
    const daytradeLastRun = document.getElementById('daytradeLastRun');
    const daytradeTickersInput = document.getElementById('daytradeTickersInput');
    const daytradeIntervalSelect = document.getElementById('daytradeInterval');
    const daytradeAtrPeriodInput = document.getElementById('daytradeAtrPeriod');
    const daytradeAtrMultInput = document.getElementById('daytradeAtrMult');
    const daytradeDeviationInput = document.getElementById('daytradeDeviation');
    const daytradeBackstepInput = document.getElementById('daytradeBackstep');

    function renderDaytradeRows(rows) {
        if (!daytradeTableBody) return;
        if (!rows.length) {
            daytradeTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-3">
                        No intraday signals at the moment. Try a different interval or parameters.
                    </td>
                </tr>
            `;
            return;
        }
        daytradeTableBody.innerHTML = '';
        rows.forEach(row => {
            const price = typeof row.price === 'number' ? `$${row.price.toFixed(2)}` : '‚Äî';
            const sessionVwap = typeof row.session_vwap === 'number'
                ? `$${row.session_vwap.toFixed(2)}`
                : '‚Äî';
            const sessionDelta = typeof row.session_vwap_delta_pct === 'number'
                ? `${row.session_vwap_delta_pct >= 0 ? '+' : ''}${row.session_vwap_delta_pct.toFixed(2)}%`
                : '';
            const sessionCell = sessionDelta
                ? `${sessionVwap}<div class="small text-muted">${sessionDelta}</div>`
                : sessionVwap;
            const st = row.supertrend || {};
            const stTrend = st.trend || 'n/a';
            const stBadgeClass = (stTrend || '').toLowerCase().includes('down')
                ? 'badge bg-danger-subtle text-danger'
                : 'badge bg-success-subtle text-success';
            const stBadge = `<span class="${stBadgeClass}">${stTrend}</span>`;
            const stNotes = st.buy_signal ? '<div class="small text-success">Fresh flip</div>' : '';
            const zz = row.zigzag || {};
            const zzDir = zz.direction || 'n/a';
            const zzBadgeClass = (zzDir || '').toLowerCase().includes('sell')
                ? 'badge bg-danger-subtle text-danger'
                : 'badge bg-success-subtle text-success';
            const zzBadge = `<span class="${zzBadgeClass}">${zzDir}</span>`;
            const notes = [
                stNotes,
                zz.change_from_pivot ? `Œî from pivot ${zz.change_from_pivot_pct || ''}%` : '',
                row.session_start ? `Session start ${row.session_start}` : ''
            ].filter(Boolean).join('<br>') || '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="ticker-chip">${row.ticker || ''}</span></td>
                <td>${price}</td>
                <td>${stBadge}</td>
                <td>${zzBadge}</td>
                <td>${sessionCell}</td>
                <td class="small">${notes}</td>
            `;
            daytradeTableBody.appendChild(tr);
        });
    }

    async function fetchDaytradeRadar() {
        if (!runDaytradeBtn) return;
        runDaytradeBtn.disabled = true;
        if (daytradeStatus) daytradeStatus.textContent = 'Running day-trade radar‚Ä¶';
        try {
            const resp = await fetch('/api/daytrade/radar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tickers: daytradeTickersInput?.value || '',
                    interval: daytradeIntervalSelect?.value || '15m',
                    atr_period: daytradeAtrPeriodInput?.value || undefined,
                    atr_multiplier: daytradeAtrMultInput?.value || undefined,
                    deviation: daytradeDeviationInput?.value || undefined,
                    backstep: daytradeBackstepInput?.value || undefined
                })
            });
            const result = await resp.json();
            if (!result.success) {
                if (daytradeStatus) daytradeStatus.textContent = result.error || 'Day-trade radar failed.';
                return;
            }
            const signals = (result.data && result.data.signals) || [];
            renderDaytradeRows(signals);
            const meta = (result.data && result.data.meta) || {};
            if (daytradeLastRun) daytradeLastRun.textContent = 'Last run: ' + new Date().toLocaleTimeString();
            if (daytradeStatus) {
                let text = `Interval ${meta.interval || '15m'}`;
                if (meta.settings) {
                    text += ` ‚Ä¢ ATR ${meta.settings.atr_period}/${meta.settings.atr_multiplier}`;
                    text += ` ‚Ä¢ ZigZag ${meta.settings.zigzag_deviation}%/${meta.settings.zigzag_backstep} bars`;
                }
                if (Array.isArray(meta.tickers)) {
                    text += ` ‚Ä¢ Tickers: ${meta.tickers.join(', ')}`;
                }
                if (meta.warnings && meta.warnings.length) {
                    text += ' ‚Ä¢ ' + meta.warnings.join(' | ');
                }
                daytradeStatus.textContent = text;
            }
        } catch (err) {
            console.error('Daytrade radar error', err);
            if (daytradeStatus) daytradeStatus.textContent = 'Failed to run day-trade radar. Try again.';
        } finally {
            runDaytradeBtn.disabled = false;
        }
    }

    runDaytradeBtn?.addEventListener('click', fetchDaytradeRadar);

    // ------------- TradingView relay tab logic -------------
    const tvTab = document.getElementById('tv-tab');
    const tvRefreshBtn = document.getElementById('tvRefreshBtn');
    const tvDetailRefreshBtn = document.getElementById('tvDetailRefreshBtn');
    const tvStreamsBody = document.getElementById('tvStreamsBody');
    const tvSignalCard = document.getElementById('tvSignalCard');
    const tvChartContainer = document.getElementById('tvChartContainer');
    const tvRefreshChartBtn = document.getElementById('tvRefreshChartBtn');
    const tvStreamsStatus = document.getElementById('tvStreamsStatus');

    let tvStreams = [];
    let tvStreamsLoading = false;
    let tvSignalLoading = false;
    let tvActiveStream = null;
    let tvActiveStreamKey = '';

    function getTvStreamKey(symbol, timeframe) {
        return `${(symbol || '').toUpperCase()}::${(timeframe || '').trim()}`;
    }

    function parseTvTimestamp(value) {
        if (value === null || value === undefined || value === '') return null;
        if (value instanceof Date) return Number.isNaN(value.getTime()) ? null : value;
        const numeric = Number(value);
        if (Number.isFinite(numeric)) {
            const ms = numeric > 1e12 ? numeric : numeric * 1000;
            const dateObj = new Date(ms);
            return Number.isNaN(dateObj.getTime()) ? null : dateObj;
        }
        const dateObj = new Date(value);
        return Number.isNaN(dateObj.getTime()) ? null : dateObj;
    }

    function formatTvTimestampFull(value) {
        const date = parseTvTimestamp(value);
        return date ? date.toLocaleString() : '‚Äî';
    }

    function formatTvTimestampShort(value) {
        const date = parseTvTimestamp(value);
        return date ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '‚Äî';
    }

    function formatTvPrice(value) {
        const num = Number(value);
        return Number.isFinite(num) ? `$${num.toFixed(2)}` : '‚Äî';
    }

    function formatTvNumber(value, digits = 2) {
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(digits) : '‚Äî';
    }

    function formatIndicatorValue(value) {
        if (value === null || value === undefined) return '‚Äî';
        if (typeof value === 'number') {
            if (Number.isInteger(value)) return value.toString();
            return value.toFixed(Math.abs(value) >= 1 ? 2 : 4);
        }
        if (typeof value === 'boolean') {
            return value ? 'true' : 'false';
        }
        if (Array.isArray(value)) {
            return value.map(item => formatIndicatorValue(item)).join(', ');
        }
        if (typeof value === 'object') {
            return Object.entries(value)
                .map(([k, v]) => `${k}: ${formatIndicatorValue(v)}`)
                .join('; ');
        }
        return String(value);
    }

    function setTvStreamsStatus(message) {
        if (tvStreamsStatus) {
            tvStreamsStatus.textContent = message;
        }
    }

    function setTvSignalPlaceholder(message, showSpinner = false) {
        if (!tvSignalCard) return;
        tvSignalCard.innerHTML = `
            <div class="card-body text-center py-4">
                ${showSpinner ? `
                    <div class="spinner-border text-info mb-3" role="status" style="width: 2rem; height: 2rem;">
                        <span class="visually-hidden">Loading‚Ä¶</span>
                    </div>
                ` : ''}
                <p class="text-muted mb-0">${message}</p>
            </div>
        `;
    }

    function renderTradingviewStreams() {
        if (!tvStreamsBody) return;
        if (!tvStreams.length) {
            tvStreamsBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-3">
                        Waiting for TradingView webhook data.
                    </td>
                </tr>
            `;
            return;
        }
        tvStreamsBody.innerHTML = '';
        tvStreams.forEach(stream => {
            const key = getTvStreamKey(stream.symbol, stream.timeframe);
            const tr = document.createElement('tr');
            tr.dataset.key = key;
            if (key === tvActiveStreamKey) {
                tr.classList.add('table-active');
            }
            const updatedAt = stream.last_bar_time || stream.latest_signal_time;
            const updatedLabel = formatTvTimestampShort(updatedAt);
            const updatedFull = formatTvTimestampFull(updatedAt);
            const price = formatTvPrice(stream.last_price);
            const barsVal = Number(stream.bar_count);
            const bars = Number.isFinite(barsVal) ? barsVal : '‚Äî';
            const signalLabel = (stream.latest_signal || '').toUpperCase() || '‚Äî';
            const rrVal = stream.latest_rr;
            const confVal = stream.latest_confidence;
            const rrText = rrVal != null && rrVal !== '' ? Number(rrVal).toFixed(1) + 'x' : '‚Äî';
            const confText = Number.isFinite(confVal) ? `${Number(confVal).toFixed(0)}%` : '‚Äî';
            const badgeClass = signalLabel === 'BUY'
                ? 'bg-success-subtle text-success'
                : signalLabel === 'SELL'
                    ? 'bg-danger-subtle text-danger'
                    : 'bg-secondary-subtle text-dark';
            const highlight = signalLabel !== 'HOLD' || (Number.isFinite(confVal) && confVal >= 60);
            if (highlight) {
                tr.classList.add('table-warning');
            }
            tr.innerHTML = `
                <td>
                    <span class="ticker-chip">${(stream.symbol || '').toUpperCase()}</span>
                    <div class="small text-muted">${stream.timeframe || ''}</div>
                </td>
                <td>${price}</td>
                <td>${bars}</td>
                <td><span class="badge ${badgeClass}">${signalLabel}</span></td>
                <td>${rrText}</td>
                <td>${confText}</td>
                <td class="small text-muted" title="${updatedFull}">${updatedLabel}</td>
            `;
            tr.addEventListener('click', () => {
                selectTradingviewStream(stream);
            });
            tvStreamsBody.appendChild(tr);
        });
    }

    function updateTvSelectionState(streamExists) {
        if (streamExists) {
            tvDetailRefreshBtn?.removeAttribute('disabled');
            return;
        }
        tvActiveStream = null;
        tvActiveStreamKey = '';
        if (tvDetailRefreshBtn) tvDetailRefreshBtn.setAttribute('disabled', 'disabled');
        setTvSignalPlaceholder('Select a stream to load the latest AI packet.');
    }

    async function fetchTradingviewStreams() {
        if (tvStreamsLoading) return;
        tvStreamsLoading = true;
        setTvStreamsStatus('Loading streams‚Ä¶');
        try {
            const resp = await fetch('/api/tradingview/signals');
            const result = await resp.json();
            if (!result.success) {
                setTvStreamsStatus(result.error || 'Unable to load streams.');
                return;
            }
            const streams = Array.isArray(result.data && result.data.streams)
                ? result.data.streams
                : [];
            const meta = (result.data && result.data.meta) || {};
            tvStreams = streams.map(item => ({
                ...item,
                symbol: (item.symbol || '').toUpperCase(),
                key: getTvStreamKey(item.symbol, item.timeframe)
            }));
            const stillActive = tvActiveStreamKey && tvStreams.some(s => s.key === tvActiveStreamKey);
            if (stillActive) {
                const match = tvStreams.find(s => s.key === tvActiveStreamKey);
                tvActiveStream = match ? { symbol: match.symbol, timeframe: match.timeframe } : tvActiveStream;
            } else {
                updateTvSelectionState(false);
            }
            renderTradingviewStreams();
            const streamText = streams.length ? `${streams.length} stream${streams.length === 1 ? '' : 's'}` : 'No streams';
            const modelText = meta.model ? ` ‚Ä¢ Model ${meta.model}` : '';
            setTvStreamsStatus(`${streamText}${modelText}`);
        } catch (err) {
            console.error('TradingView streams error', err);
            setTvStreamsStatus('Failed to load streams.');
        } finally {
            tvStreamsLoading = false;
        }
    }

    function selectTradingviewStream(stream) {
        if (!stream) return;
        tvActiveStreamKey = getTvStreamKey(stream.symbol, stream.timeframe);
        tvActiveStream = {
            symbol: (stream.symbol || '').toUpperCase(),
            timeframe: stream.timeframe || ''
        };
        if (tvDetailRefreshBtn) tvDetailRefreshBtn.removeAttribute('disabled');
        renderTradingviewStreams();
        fetchTradingviewSignalDetail(true);
    }

    async function fetchTradingviewSignalDetail(scrollIntoView = false) {
        if (!tvActiveStream || tvSignalLoading) return;
        tvSignalLoading = true;
        setTvSignalPlaceholder('Loading Perplexity signal‚Ä¶', true);
        try {
            const params = new URLSearchParams({
                symbol: tvActiveStream.symbol,
                tf: tvActiveStream.timeframe
            });
            const resp = await fetch(`/api/tradingview/signals?${params.toString()}`);
            const result = await resp.json();
            if (!result.success) {
                setTvSignalPlaceholder(result.error || 'Unable to load signal.');
                return;
            }
            renderTradingviewSignalDetail(result.data || {});
            if (scrollIntoView) {
                tvSignalCard?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } catch (err) {
            console.error('TradingView signal error', err);
            setTvSignalPlaceholder('Failed to load AI signal.');
        } finally {
            tvSignalLoading = false;
        }
    }

    function renderTradingviewSignalDetail(payload) {
        if (!tvSignalCard) return;
        const signal = payload.latest_signal || {};
        const action = (signal.signal || 'HOLD').toUpperCase();
        const isHold = action === 'HOLD';
        const entry = isHold ? '‚Äî' : formatTvPrice(signal.entry);
        const stop = isHold ? '‚Äî' : formatTvPrice(signal.stop);
        const target = isHold ? '‚Äî' : formatTvPrice(signal.target);
        const riskReward = isHold ? '‚Äî' : formatTvNumber(signal.risk_reward);
        const confidenceVal = Number(signal.confidence);
        const confidenceText = Number.isFinite(confidenceVal) ? `${confidenceVal}/100` : '‚Äî';
        const confidencePct = Number.isFinite(confidenceVal) ? Number(confidenceVal).toFixed(0) + '%' : '‚Äî';
        const positionSize = signal.position_size_pct !== undefined && signal.position_size_pct !== null
            ? `${formatTvNumber(signal.position_size_pct, 1)}%`
            : '‚Äî';
        const holdingWindow = signal.holding_window || '‚Äî';
        const volatilityNotes = signal.volatility_notes || '';
        const bars = Array.isArray(payload.bars) ? payload.bars : [];
        const barCountVal = Number(payload.bar_count);
        const barCount = Number.isFinite(barCountVal) ? barCountVal : bars.length;
        const barsUsedVal = Number(signal.bars_used);
        const barsUsed = Number.isFinite(barsUsedVal) ? barsUsedVal : bars.length;
        const lastBar = bars.length ? bars[bars.length - 1] : null;
        const firstBar = bars.length ? bars[0] : null;
        const lastClose = lastBar ? formatTvPrice(lastBar.close) : '‚Äî';
        const lastTimeIso = (lastBar && (lastBar.time_iso || lastBar.time)) || null;
        const firstTimeIso = (firstBar && (firstBar.time_iso || firstBar.time)) || null;
        const firstDate = parseTvTimestamp(firstTimeIso);
        const lastDate = parseTvTimestamp(lastTimeIso);
        const windowMinutes = (firstDate && lastDate)
            ? Math.max(0, Math.round((lastDate - firstDate) / 60000))
            : null;
        const contextList = Array.isArray(signal.context) ? signal.context.slice(0, 3) : [];
        const contextItems = contextList.length
            ? contextList.map(item => `<li>${item}</li>`).join('')
            : '<li class="text-muted">No context bullets provided.</li>';
        const invalidationItemsRaw = Array.isArray(signal.invalidations) ? signal.invalidations.slice(0, 3) : [];
        const invalidationItems = invalidationItemsRaw.length
            ? invalidationItemsRaw.map(item => `<li>${item}</li>`).join('')
            : '<li class="text-muted">No invalidations provided.</li>';
        const meta = payload.meta || {};
        const badgeClass = action === 'BUY'
            ? 'badge bg-success-subtle text-success'
            : action === 'SELL'
                ? 'badge bg-danger-subtle text-danger'
                : 'badge bg-secondary-subtle text-dark';
        const contextSnapshot = payload.context || {};
        const indicatorSections = [];

        function addSection(title, summaryLines, rawLines) {
            const summaryHtml = summaryLines.length
                ? summaryLines.map(line => `<li>${line}</li>`).join('')
                : '<li class="text-muted">No summary available.</li>';
            const rawHtml = rawLines.length
                ? `<div class="small text-muted mt-2">${rawLines.join(' ‚Ä¢ ')}</div>`
                : '';
            indicatorSections.push(`
                <div class="col-12 col-md-6">
                    <h6 class="mb-2">${title}</h6>
                    <ul class="small mb-1">${summaryHtml}</ul>
                    ${rawHtml}
                </div>
            `);
        }

        // Trend section
        const trend = contextSnapshot.trend || {};
        if (Object.keys(trend).length) {
            const fast = Number(trend.ema_fast);
            const mid = Number(trend.ema_mid);
            const slow = Number(trend.ema_slow);
            const lastCloseNum = lastBar ? Number(lastBar.close) : null;
            const stackBear = Number.isFinite(fast) && Number.isFinite(mid) && Number.isFinite(slow) && fast < mid && mid < slow;
            const stackBull = Number.isFinite(fast) && Number.isFinite(mid) && Number.isFinite(slow) && fast > mid && mid > slow;
            const regime = (trend.trend_regime || '').toString();
            const summary = [];
            if (stackBear) summary.push('EMAs stacked bearish (fast < mid < slow)');
            else if (stackBull) summary.push('EMAs stacked bullish (fast > mid > slow)');
            if (lastCloseNum !== null && Number.isFinite(fast) && Number.isFinite(mid) && Number.isFinite(slow)) {
                const belowAll = lastCloseNum < Math.min(fast, mid, slow);
                const aboveAll = lastCloseNum > Math.max(fast, mid, slow);
                if (belowAll) summary.push('Price below all EMAs');
                else if (aboveAll) summary.push('Price above all EMAs');
            }
            if (regime) summary.push(`Regime: ${regime}`);
            const slope = (Number.isFinite(slow) && Number.isFinite(fast)) ? (slow - fast) : null;
            if (Number.isFinite(slope)) summary.push(`Slope spread: ${slope.toFixed(1)} pts`);
            addSection(
                'Trend',
                summary,
                [
                    Number.isFinite(fast) ? `EMA fast: ${fast.toFixed(2)}` : null,
                    Number.isFinite(mid) ? `EMA mid: ${mid.toFixed(2)}` : null,
                    Number.isFinite(slow) ? `EMA slow: ${slow.toFixed(2)}` : null
                ].filter(Boolean)
            );
        }

        // Momentum section
        const momentum = contextSnapshot.momentum || {};
        if (Object.keys(momentum).length) {
            const macd = Number(momentum.macd);
            const macdSig = Number(momentum.macd_signal);
            const macdHist = Number(momentum.macd_hist);
            const rsi = Number(momentum.rsi_14);
            const summary = [];
            if (Number.isFinite(macd) && Number.isFinite(macdHist)) {
                const histTone = macdHist > 0 ? 'rising' : 'falling';
                summary.push(`MACD ${macd.toFixed(1)} with histogram ${macdHist.toFixed(1)} (${histTone})`);
            }
            if (Number.isFinite(rsi)) summary.push(`RSI ${rsi.toFixed(1)} ‚Üí ${rsi < 45 ? 'bearish tilt' : rsi > 55 ? 'bullish tilt' : 'neutral'}`);
            addSection(
                'Momentum',
                summary,
                [
                    Number.isFinite(macd) ? `MACD: ${macd.toFixed(2)}` : null,
                    Number.isFinite(macdSig) ? `Signal: ${macdSig.toFixed(2)}` : null,
                    Number.isFinite(macdHist) ? `Hist: ${macdHist.toFixed(2)}` : null,
                    Number.isFinite(rsi) ? `RSI(14): ${rsi.toFixed(2)}` : null
                ].filter(Boolean)
            );
        }

        // Volatility section
        const volatility = contextSnapshot.volatility || {};
        if (Object.keys(volatility).length) {
            const atr = Number(volatility.atr_14);
            const atrPct = Number(volatility.atr_percent_of_price);
            const summary = [];
            if (Number.isFinite(atr) || Number.isFinite(atrPct)) {
                summary.push(`ATR(14): ${Number.isFinite(atr) ? atr.toFixed(1) : '‚Äî'} (${Number.isFinite(atrPct) ? (atrPct * 100).toFixed(2) + '% of price' : '‚Äî'})`);
            }
            addSection(
                'Volatility',
                summary,
                [
                    Number.isFinite(atr) ? `ATR14: ${atr.toFixed(2)}` : null,
                    Number.isFinite(atrPct) ? `ATR%: ${(atrPct * 100).toFixed(3)}%` : null,
                ].filter(Boolean)
            );
        }

        // Volume section
        const volumeInfo = contextSnapshot.volume_info || {};
        if (Object.keys(volumeInfo).length) {
            const rvol = Number(volumeInfo.relative_volume);
            const volSpike = volumeInfo.vol_spike_flag;
            const summary = [];
            if (Number.isFinite(rvol)) summary.push(`RVOL ${rvol.toFixed(2)}√ó ${rvol >= 1 ? '(elevated)' : '(below avg)'}`);
            if (volSpike !== undefined) summary.push(volSpike ? 'Volume spike detected' : 'No volume spike');
            addSection(
                'Volume',
                summary,
                [
                    Number.isFinite(rvol) ? `RVOL: ${rvol.toFixed(4)}` : null,
                    volSpike !== undefined ? `Volume spike: ${volSpike}` : null,
                ].filter(Boolean)
            );
        }

        // Session section
        const sessionInfo = contextSnapshot.session || {};
        if (Object.keys(sessionInfo).length) {
            const dow = sessionInfo.day_of_week;
            const sessionType = sessionInfo.session_type;
            const timeOfDay = sessionInfo.time_of_day;
            const summary = [];
            const dowNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            if (typeof dow === 'number' && dow >= 0 && dow < 7) summary.push(dowNames[dow]);
            if (sessionType) summary.push(`${sessionType} session`);
            if (timeOfDay) {
                const t = new Date(Number(timeOfDay));
                summary.push(`Local time about ${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')}`);
            }
            addSection(
                'Session',
                summary,
                [
                    sessionType ? `session_type: ${sessionType}` : null,
                    dow !== undefined ? `day_of_week: ${dow}` : null,
                    timeOfDay ? `time_of_day: ${timeOfDay}` : null,
                ].filter(Boolean)
            );
        }

        // Risk settings
        const risk = contextSnapshot.risk_settings || {};
        if (Object.keys(risk).length) {
            const riskPct = risk.account_risk_percent;
            const minRR = risk.min_rr_ratio;
            const summary = [];
            if (riskPct !== undefined) summary.push(`Account risk: ${riskPct}%`);
            if (minRR !== undefined) summary.push(`Min RR: ${minRR}√ó`);
            addSection(
                'Risk Settings',
                summary,
                [
                    riskPct !== undefined ? `account_risk_percent: ${riskPct}` : null,
                    minRR !== undefined ? `min_rr_ratio: ${minRR}` : null,
                ].filter(Boolean)
            );
        }

        const contextMeta = contextSnapshot.meta || {};
        const contextMetaLabel = contextMeta.bar_time
            ? `Snapshot: ${formatTvTimestampFull(contextMeta.bar_time)}`
            : contextMeta.received_at
                ? `Updated: ${formatTvTimestampFull(contextMeta.received_at)}`
                : '';

        tvSignalCard.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">${(payload.symbol || '').toUpperCase()} ‚Ä¢ ${payload.timeframe || ''}</h5>
                    <small class="text-muted">Generated ${formatTvTimestampFull(signal.generated_at) || '-'}</small>
                </div>
                <div class="text-end">
                    <span class="${badgeClass} px-3 py-2 text-uppercase">${action}</span>
                    <div class="small text-muted">Confidence: ${confidencePct}</div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6 border-end border-secondary-subtle">
                        <h6 class="mb-2">Trade Levels</h6>
                        <p class="mb-1 fs-6"><strong>Entry:</strong> ${entry}</p>
                        <p class="mb-1 fs-6"><strong>Target:</strong> ${target}</p>
                        <p class="mb-1 fs-6"><strong>Stop:</strong> ${stop}</p>
                        <p class="mb-1 fs-6"><strong>Risk / Reward:</strong> ${riskReward}</p>
                        <p class="mb-1 fs-6"><strong>Position size:</strong> ${positionSize}</p>
                        <p class="mb-1 fs-6"><strong>Holding window:</strong> ${holdingWindow}</p>
                        ${volatilityNotes ? `<p class="mb-0 small text-muted">${volatilityNotes}</p>` : ''}
                    </div>
                    <div class="col-12 col-md-6">
                        <h6 class="mb-2">Context</h6>
                        <ul class="mb-3 fs-6">
                            ${contextItems}
                        </ul>
                        <h6 class="mb-2">Invalidations</h6>
                        <ul class="mb-0 fs-6">
                            ${invalidationItems}
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="row g-3 small">
                    <div class="col-12 col-md-6">
                        <h6 class="mb-2">Bars Snapshot</h6>
                        <p class="mb-1">Bars cached: ${barCount || '‚Äî'}</p>
                        <p class="mb-1">Bars used by AI: ${barsUsed || '‚Äî'}</p>
                        <p class="mb-1">Window: ${windowMinutes !== null ? windowMinutes + ' min' : '‚Äî'}</p>
                        <p class="mb-0">Last close: ${lastClose} (${formatTvTimestampShort(lastTimeIso)})</p>
                    </div>
                    <div class="col-12 col-md-6">
                        <h6 class="mb-2">Model Meta</h6>
                        <p class="mb-1">Model: ${meta.model || '‚Äî'}</p>
                        <p class="mb-1">Prompt window: ${meta.prompt_bar_limit || '‚Äî'} bars ‚Ä¢ Min bars ${meta.min_bars || '‚Äî'}</p>
                        <p class="mb-1">Cooldown remaining: ${typeof meta.cooldown_remaining === 'number' ? meta.cooldown_remaining.toFixed(1) + 's' : '‚Äî'}</p>
                        <p class="mb-0">Signal inflight: ${meta.signal_inflight ? 'Yes' : 'No'}</p>
                    </div>
                </div>
                ${indicatorSections.length ? `
                    <hr>
                    <div class="row g-3 small">
                        ${indicatorSections.join('')}
                    </div>
                ` : ''}
                ${contextMetaLabel ? `<p class="small text-muted mt-3 mb-0">${contextMetaLabel}</p>` : ''}
            </div>
        `;

        // Update chart with bars if available
        if (bars.length && tvChartContainer) {
            renderTvChart(bars, signal);
        }
    }

    // Lightweight chart via Plotly (if available)
    async function renderTvChart(bars, signal) {
        if (typeof Plotly === 'undefined') {
            tvChartContainer.innerHTML = '<p class="text-muted small mb-0">Plotly not loaded.</p>';
            return;
        }
        const times = bars.map(b => new Date(b.time_iso || b.time * 1000));
        const opens = bars.map(b => b.open);
        const highs = bars.map(b => b.high);
        const lows = bars.map(b => b.low);
        const closes = bars.map(b => b.close);
        const volumes = bars.map(b => b.volume || 0);

        const candleTrace = {
            x: times,
            open: opens,
            high: highs,
            low: lows,
            close: closes,
            type: 'candlestick',
            name: 'Price',
            increasing: { line: { color: '#16a34a' } },
            decreasing: { line: { color: '#dc3545' } },
            customdata: bars.map((b, idx) => ({
                vol: volumes[idx],
                vol_up: b.vol_up ?? null,
                vol_down: b.vol_down ?? null
            })),
            hovertemplate: [
                'Time: %{x|%Y-%m-%d %H:%M}<br>',
                'Open: %{open:.2f}<br>',
                'High: %{high:.2f}<br>',
                'Low: %{low:.2f}<br>',
                'Close: %{close:.2f}<br>',
                'Volume: %{customdata.vol:.0f}<br>',
                'Buy Vol: %{customdata.vol_up:.0f}<br>',
                'Sell Vol: %{customdata.vol_down:.0f}<extra></extra>'
            ].join('')
        };
        const volumeColors = volumes.map((v, idx) => (closes[idx] >= opens[idx]) ? 'rgba(22,163,74,0.4)' : 'rgba(220,53,69,0.4)');
        const volumeTrace = {
            x: times,
            y: volumes,
            type: 'bar',
            yaxis: 'y2',
            marker: { color: volumeColors },
            name: 'Volume',
            hovertemplate: 'Time: %{x|%Y-%m-%d %H:%M}<br>Volume: %{y:.0f}<extra></extra>'
        };
        const lastTime = times[times.length - 1];
        const decisionMarker = {
            x: [lastTime],
            y: [closes[closes.length - 1]],
            mode: 'markers+text',
            text: [signal.signal ? signal.signal.toUpperCase() : ''],
            textposition: 'top center',
            marker: {
                size: 12,
                color: signal.signal === 'buy' ? '#16a34a' : signal.signal === 'sell' ? '#dc3545' : '#6c757d'
            },
            name: 'Decision'
        };
        const levelMarkers = [];
        if (signal.entry != null) {
            levelMarkers.push({
                x: [lastTime],
                y: [signal.entry],
                mode: 'markers+text',
                text: ['Entry'],
                textposition: 'middle right',
                marker: { size: 10, color: '#0d6efd' },
                name: 'Entry'
            });
        }
        if (signal.stop != null) {
            levelMarkers.push({
                x: [lastTime],
                y: [signal.stop],
                mode: 'markers+text',
                text: ['Stop'],
                textposition: 'middle right',
                marker: { size: 10, color: '#dc3545' },
                name: 'Stop'
            });
        }
        if (signal.target != null) {
            levelMarkers.push({
                x: [lastTime],
                y: [signal.target],
                mode: 'markers+text',
                text: ['Target'],
                textposition: 'middle right',
                marker: { size: 10, color: '#198754' },
                name: 'Target'
            });
        }
        const shapes = [];
        if (signal.entry != null) {
            shapes.push({
                type: 'line', x0: times[0], x1: times[times.length - 1], y0: signal.entry, y1: signal.entry,
                line: { color: '#0d6efd', dash: 'dot' }, yref: 'y', xref: 'x'
            });
        }
        if (signal.stop != null) {
            shapes.push({
                type: 'line', x0: times[0], x1: times[times.length - 1], y0: signal.stop, y1: signal.stop,
                line: { color: '#dc3545', dash: 'dot' }, yref: 'y', xref: 'x'
            });
        }
        if (signal.target != null) {
            shapes.push({
                type: 'line', x0: times[0], x1: times[times.length - 1], y0: signal.target, y1: signal.target,
                line: { color: '#198754', dash: 'dot' }, yref: 'y', xref: 'x'
            });
        }

        const layout = {
            margin: { l: 40, r: 40, t: 10, b: 30 },
            xaxis: { rangeslider: { visible: false } },
            yaxis: { title: 'Price' },
            yaxis2: {
                title: 'Volume',
                overlaying: 'y',
                side: 'right',
                showgrid: false,
                rangemode: 'tozero'
            },
            shapes,
            showlegend: false,
            paper_bgcolor: '#0b0f19',
            plot_bgcolor: '#0b0f19',
            font: { color: '#d1d5db' }
        };
        Plotly.newPlot(tvChartContainer, [candleTrace, volumeTrace, decisionMarker, ...levelMarkers], layout, { responsive: true });
    }

    tvRefreshChartBtn?.addEventListener('click', () => {
        if (tvActiveStream) fetchTradingviewSignalDetail(false);
    });

    tvRefreshBtn?.addEventListener('click', fetchTradingviewStreams);
    tvDetailRefreshBtn?.addEventListener('click', () => fetchTradingviewSignalDetail(false));

    tvTab?.addEventListener('shown.bs.tab', () => {
        if (!tvStreams.length) {
            fetchTradingviewStreams();
        }
    });
    if (tvTab?.classList.contains('active')) {
        fetchTradingviewStreams();
    }

    // ------------- Live Breakouts (compact card) -------------
    const liveBreakoutsBody = document.getElementById('liveBreakoutsBody');
    const liveBreakoutsToday = document.getElementById('liveBreakoutsToday');
    const liveBreakouts3d = document.getElementById('liveBreakouts3d');
    let liveBreakoutsWindow = '1d';
    let liveBreakoutsRows = [];

    function renderLiveBreakouts() {
        if (!liveBreakoutsBody) return;
        liveBreakoutsBody.innerHTML = '';
        if (!Array.isArray(liveBreakoutsRows) || !liveBreakoutsRows.length) {
            liveBreakoutsBody.innerHTML = `
                <tr><td colspan="8" class="text-center text-muted py-3">No live breakouts yet.</td></tr>
            `;
            return;
        }
        liveBreakoutsRows.forEach(item => {
            const sig = item.signal || {};
            const badgeClass = sig.signal === 'BUY'
                ? 'badge bg-success-subtle text-success'
                : sig.signal === 'SELL'
                    ? 'badge bg-danger-subtle text-danger'
                    : 'badge bg-secondary-subtle text-dark';
            const confText = Number.isFinite(sig.confidence) ? `${Number(sig.confidence).toFixed(0)}%` : '‚Äî';
            const rvolText = item.relative_volume != null ? Number(item.relative_volume).toFixed(2) : '‚Äî';
            const triggerText = item.trigger_price != null ? formatTvPrice(item.trigger_price) : '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="small text-muted">${formatTvTimestampShort(item.bar_time)}</td>
                <td>${(item.symbol || '').toUpperCase()}</td>
                <td>${item.timeframe || ''}</td>
                <td class="text-uppercase">${item.event || ''}</td>
                <td>${triggerText}</td>
                <td>${rvolText}</td>
                <td><span class="${badgeClass}">${(sig.signal || '‚Äî').toUpperCase()}</span></td>
                <td>${confText}</td>
            `;
            liveBreakoutsBody.appendChild(tr);
        });
    }

    async function fetchLiveBreakouts() {
        if (!liveBreakoutsBody) return;
        liveBreakoutsBody.innerHTML = `
            <tr><td colspan="8" class="text-center text-muted py-3">Loading‚Ä¶</td></tr>
        `;
        try {
            const resp = await fetch(`/api/breakouts/live?window=${encodeURIComponent(liveBreakoutsWindow)}&limit=50`);
            const payload = await resp.json();
            if (!payload.success) {
                liveBreakoutsBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-3">${payload.error || 'Failed to load.'}</td></tr>`;
                return;
            }
            liveBreakoutsRows = payload.data || [];
            renderLiveBreakouts();
        } catch (err) {
            console.error('live breakouts error', err);
            liveBreakoutsBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-3">Error loading breakouts.</td></tr>`;
        }
    }

    liveBreakoutsToday?.addEventListener('click', () => {
        liveBreakoutsWindow = '1d';
        liveBreakoutsToday.classList.add('active');
        liveBreakouts3d?.classList.remove('active');
        fetchLiveBreakouts();
    });
    liveBreakouts3d?.addEventListener('click', () => {
        liveBreakoutsWindow = '3d';
        liveBreakouts3d.classList.add('active');
        liveBreakoutsToday?.classList.remove('active');
        fetchLiveBreakouts();
    });

    if (liveBreakoutsBody) {
        fetchLiveBreakouts();
    }

    // ------------- AI Signal history -------------
    const aiHistoryBody = document.getElementById('aiHistoryBody');
    const aiHistoryRefreshBtn = document.getElementById('aiHistoryRefreshBtn');
    const aiHistorySearch = document.getElementById('aiHistorySearch');
    const aiHistoryMode = document.getElementById('aiHistoryMode');
    const aiHistoryAnalysis = document.getElementById('aiHistoryAnalysis');
    const aiHistoryPrev = document.getElementById('aiHistoryPrev');
    const aiHistoryNext = document.getElementById('aiHistoryNext');
    const aiHistoryPage = document.getElementById('aiHistoryPage');
    const aiHistoryPageSize = document.getElementById('aiHistoryPageSize');
    const aiHistoryStatus = document.getElementById('aiHistoryStatus');

    let aiHistoryRows = [];
    let aiHistoryFiltered = [];
    let aiHistorySort = { key: 'created_at', direction: 'desc' };
    let aiHistoryPageIndex = 0;
    let aiHistoryPageSizeVal = 20;

    function updateAiHistoryStatus(text) {
        if (aiHistoryStatus) aiHistoryStatus.textContent = text;
    }

    function applyAiHistoryFilters() {
        aiHistoryPageIndex = 0;
        const search = (aiHistorySearch?.value || '').trim().toLowerCase();
        const modeFilter = (aiHistoryMode?.value || '').trim().toLowerCase();
        const analysisFilter = (aiHistoryAnalysis?.value || '').trim().toLowerCase();

        aiHistoryFiltered = aiHistoryRows.filter(row => {
            if (modeFilter && (row.mode || '').toLowerCase() !== modeFilter) return false;
            if (analysisFilter && (row.analysis_mode || '').toLowerCase() !== analysisFilter) return false;
            if (search) {
                const hay = [
                    row.symbol, row.timeframe, row.mode, row.analysis_mode,
                    row.signal, row.reason_short, row.model
                ].map(x => (x || '').toString().toLowerCase()).join(' ');
                if (!hay.includes(search)) return false;
            }
            return true;
        });

        aiHistoryFiltered.sort((a, b) => {
            const dir = aiHistorySort.direction === 'asc' ? 1 : -1;
            if (aiHistorySort.key === 'created_at') {
                const da = new Date(a.created_at || 0).getTime();
                const db = new Date(b.created_at || 0).getTime();
                return (da - db) * dir;
            }
            if (aiHistorySort.key === 'symbol') {
                return ((a.symbol || '').localeCompare(b.symbol || '')) * dir;
            }
            if (aiHistorySort.key === 'confidence') {
                return ((a.confidence || 0) - (b.confidence || 0)) * dir;
            }
            return 0;
        });
        renderAiHistoryPage();
    }

    function renderAiHistoryPage() {
        if (!aiHistoryBody) return;
        aiHistoryBody.innerHTML = '';
        const pageSize = aiHistoryPageSizeVal;
        const total = aiHistoryFiltered.length;
        if (!total) {
            aiHistoryBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-3">No signals yet.</td></tr>';
            return;
        }
        const start = aiHistoryPageIndex * pageSize;
        const end = Math.min(start + pageSize, total);
        const slice = aiHistoryFiltered.slice(start, end);
        slice.forEach(sig => {
            const tr = document.createElement('tr');
            const cells = [
                formatEST(sig.created_at),
                sig.symbol || '',
                sig.timeframe || '',
                sig.mode || '',
                sig.analysis_mode || '',
                sig.signal || '',
                sig.entry != null ? Number(sig.entry).toFixed(2) : '-',
                sig.stop != null ? Number(sig.stop).toFixed(2) : '-',
                sig.target != null ? Number(sig.target).toFixed(2) : '-',
                sig.rr_ratio != null ? Number(sig.rr_ratio).toFixed(2) : '-',
                sig.confidence != null ? `${sig.confidence}%` : '-',
                sig.model || ''
            ];
            cells.forEach(text => {
                const td = document.createElement('td');
                td.textContent = text;
                tr.appendChild(td);
            });
            aiHistoryBody.appendChild(tr);
        });
        if (aiHistoryPage) {
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            aiHistoryPage.textContent = `Page ${aiHistoryPageIndex + 1} / ${totalPages}`;
        }
    }

    async function fetchAiHistory() {
        if (!aiHistoryBody) return;
        aiHistoryBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-3">Loading‚Ä¶</td></tr>';
        updateAiHistoryStatus('Loading...');
        try {
            const resp = await fetch('/signals/recent?limit=200');
            if (!resp.ok) {
                aiHistoryBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-3">Failed to load.</td></tr>';
                updateAiHistoryStatus('Error');
                return;
            }
            aiHistoryRows = await resp.json();
            updateAiHistoryStatus(`Loaded ${aiHistoryRows.length}`);
            applyAiHistoryFilters();
        } catch (err) {
            console.error('ai history error', err);
            aiHistoryBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-3">Error loading.</td></tr>';
            updateAiHistoryStatus('Error');
        }
    }

    aiHistoryRefreshBtn?.addEventListener('click', () => fetchAiHistory());
    aiHistorySearch?.addEventListener('input', () => applyAiHistoryFilters());
    aiHistoryMode?.addEventListener('change', () => applyAiHistoryFilters());
    aiHistoryAnalysis?.addEventListener('change', () => applyAiHistoryFilters());
    aiHistoryPrev?.addEventListener('click', () => {
        if (aiHistoryPageIndex > 0) {
            aiHistoryPageIndex -= 1;
            renderAiHistoryPage();
        }
    });
    aiHistoryNext?.addEventListener('click', () => {
        const totalPages = Math.ceil(aiHistoryFiltered.length / aiHistoryPageSizeVal);
        if (aiHistoryPageIndex < totalPages - 1) {
            aiHistoryPageIndex += 1;
            renderAiHistoryPage();
        }
    });
    aiHistoryPageSize?.addEventListener('change', (e) => {
        aiHistoryPageSizeVal = parseInt(e.target.value, 10) || 20;
        aiHistoryPageIndex = 0;
        renderAiHistoryPage();
    });

    // ------------- History tab logic -------------
    const historyTab = document.getElementById('history-tab');
    const historySubtabScanner = document.getElementById('history-scanner-tab');
    const historySubtabBreakout = document.getElementById('history-breakout-tab');
    const historySubtabAI = document.getElementById('history-ai-tab');
    const historySearchInput = document.getElementById('historySearch');
    const historyProfileFilter = document.getElementById('historyProfileFilter');
    const historyTierFilter = document.getElementById('historyTierFilter');
    const historyResetFiltersBtn = document.getElementById('historyResetFilters');
    const historyResultsCount = document.getElementById('historyResultsCount');
    const historySortableHeaders = document.querySelectorAll('[data-history-sort]');
    const historyAnalysisBody = document.getElementById('history-analysis-body');
    const historyAnalysisCard = document.getElementById('history-analysis-card');
    const historyLiveQuotesToggle = document.getElementById('historyLiveQuotes');
    const historyTableBody = document.getElementById('history-table-body');
    const historyScrollSentinel = document.getElementById('historyScrollSentinel');
    const HISTORY_PAGE_SIZE = 20;
    const HISTORY_QUOTE_TTL_MS = 60000;
    const HISTORY_MAX_QUOTE_BATCH = 20;
    let historyRowsRaw = [];
    const historyRowLookup = new Map();
    const historyQuoteCache = new Map();
    let historyFilteredRows = [];
    let historyVisibleRows = [];
    let historyRenderedCount = 0;
    let historyLoadingMore = false;
    let historyExhausted = false;
    let historyQuoteInflight = false;
    const historyFilters = { search: '', profile: '', tier: '' };
    const historySort = { key: 'current_change_pct', direction: 'desc' };
    const historyAscDefaultSortKeys = new Set(['ticker', 'last_profile', 'last_tier', 'first_date', 'last_date']);
    let activeHistoryTicker = '';
    let historyLiveQuotesEnabled = true;

    async function fetchHistorySummary() {
        if (historyTableBody) {
            historyTableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-muted py-3">Loading history‚Ä¶</td>
                </tr>
            `;
        }
        updateHistoryScrollHint('Loading history‚Ä¶');
        historyRowsRaw = [];
        historyFilteredRows = [];
        historyVisibleRows = [];
        historyRenderedCount = 0;
        historyRowLookup.clear();
        historyQuoteCache.clear();

        try {
            const resp = await fetch(`/api/history/summary?live_quotes=${historyLiveQuotesEnabled ? '1' : '0'}`);
            const result = await resp.json();
            if (!result.success) {
                renderHistoryLoadError();
                return;
            }
            historyRowsRaw = Array.isArray(result.data) ? result.data : [];
            historyRowLookup.clear();
            historyRowsRaw.forEach(row => {
                if (!row) return;
                const tickerKey = (row.ticker || '').toString().trim().toUpperCase();
                if (!tickerKey) return;
                row.ticker = tickerKey;
                historyRowLookup.set(tickerKey, row);
                row.current_price = null;
                row.current_change_pct = null;
            });
            historyQuoteCache.clear();
            if (typeof result.meta?.live_quotes === 'boolean' && historyLiveQuotesToggle) {
                historyLiveQuotesToggle.checked = result.meta.live_quotes;
                historyLiveQuotesEnabled = result.meta.live_quotes;
            }
            applyHistoryFilters();
        } catch (err) {
            console.error('History summary error', err);
            renderHistoryLoadError();
        }
    }

    function renderHistoryLoadError() {
        if (historyTableBody) {
            historyTableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-muted py-3">Error loading history.</td>
                </tr>
            `;
        }
        updateHistoryScrollHint('Unable to load history.');
        historyRowsRaw = [];
        historyFilteredRows = [];
        historyVisibleRows = [];
        historyRenderedCount = 0;
        historyExhausted = true;
        historyLoadingMore = false;
        updateHistoryCount(0);
        updateSortIndicators();
    }

    function applyHistoryFilters() {
        if (!historyRowsRaw.length) {
            historyFilteredRows = [];
            historyVisibleRows = [];
            historyRenderedCount = 0;
            historyExhausted = true;
            renderHistoryTable([]);
            updateHistoryCount(0);
            updateSortIndicators();
            updateHistoryScrollHint('No history yet.');
            return;
        }

        let rows = historyRowsRaw.slice();
        if (historyFilters.search) {
            rows = rows.filter(row => {
                const haystack = [
                    row.ticker || '',
                    row.last_profile || '',
                    row.last_tier || ''
                ].join(' ').toLowerCase();
                return haystack.includes(historyFilters.search);
            });
        }
        if (historyFilters.profile) {
            rows = rows.filter(row =>
                normalizeProfileValue(row.last_profile_key || row.last_profile) === historyFilters.profile
            );
        }
        if (historyFilters.tier) {
            rows = rows.filter(row =>
                (row.last_tier || '').toLowerCase() === historyFilters.tier
            );
        }

        rows = sortHistoryRows(rows);
        historyFilteredRows = rows;
        resetHistoryPagination();
        updateSortIndicators();
    }

    function sortHistoryRows(rows) {
        const multiplier = historySort.direction === 'asc' ? 1 : -1;
        const key = historySort.key;
        return rows.sort((a, b) => {
            const valA = getSortValue(a, key);
            const valB = getSortValue(b, key);
            if (valA === valB) return 0;
            return valA > valB ? multiplier : -multiplier;
        });
    }

    function resetHistoryPagination() {
        historyVisibleRows = [];
        historyRenderedCount = 0;
        historyExhausted = false;
        renderNextHistoryChunk(true);
    }

    function renderNextHistoryChunk(force = false) {
        if (historyLoadingMore) return;
        if (!historyFilteredRows.length) {
            renderHistoryTable([]);
            updateHistoryCount(0);
            updateHistoryScrollHint(historyRowsRaw.length ? 'Refine your filters.' : 'No history yet.');
            historyExhausted = true;
            return;
        }
        if (!force && historyExhausted) return;

        if (!force && historyRenderedCount >= historyFilteredRows.length) {
            historyExhausted = true;
            updateHistoryScrollHint('Reached end of history.');
            return;
        }

        historyLoadingMore = true;
        const startIndex = force ? 0 : historyRenderedCount;
        const chunk = historyFilteredRows.slice(startIndex, startIndex + HISTORY_PAGE_SIZE);
        if (force) {
            historyVisibleRows = [];
            historyRenderedCount = 0;
        }
        if (!chunk.length) {
            historyLoadingMore = false;
            historyExhausted = true;
            updateHistoryScrollHint('Reached end of history.');
            return;
        }

        historyVisibleRows = historyVisibleRows.concat(chunk);
        historyRenderedCount += chunk.length;
        renderHistoryTable(historyVisibleRows);
        updateHistoryCount(historyVisibleRows.length);
        queueHistoryQuoteFetch(force, chunk);
        historyLoadingMore = false;
        historyExhausted = historyRenderedCount >= historyFilteredRows.length;
        updateHistoryScrollHint(historyExhausted ? 'Reached end of history.' : 'Scroll to load more history.');
    }

    function getSortValue(row, key) {
        switch (key) {
            case 'alerts':
                return getNumericValue(row.alerts);
            case 'last_entry':
                return getNumericValue(row.last_entry);
            case 'last_ai_target_price':
                return getNumericValue(row.last_ai_target_price);
            case 'last_ai_potential_gain_pct':
                return getNumericValue(row.last_ai_potential_gain_pct);
            case 'current_price':
                return getNumericValue(row.current_price ?? row.last_scan_price);
            case 'current_change_pct':
                return getNumericValue(row.current_change_pct ?? row.last_known_change_pct);
            case 'first_date':
                return getDateValue(row.first_date);
            case 'last_date':
                return getDateValue(row.last_date);
            case 'last_profile':
            case 'last_tier':
            case 'ticker':
            default:
                return ((row && row[key]) || '').toString().toLowerCase();
        }
    }

    function getNumericValue(val) {
        if (typeof val === 'number') return val;
        if (typeof val === 'string') {
            const parsed = parseFloat(val.replace(/[^0-9.-]/g, ''));
            return Number.isNaN(parsed) ? 0 : parsed;
        }
        return 0;
    }

    function getDateValue(val) {
        if (!val) return 0;
        const stamp = Date.parse(val);
        return Number.isNaN(stamp) ? 0 : stamp;
    }

    function coerceNumber(val) {
        if (val === null || val === undefined) return null;
        if (typeof val === 'number') {
            return Number.isFinite(val) ? val : null;
        }
        const parsed = parseFloat(val);
        return Number.isNaN(parsed) ? null : parsed;
    }

    function updateHistoryScrollHint(message) {
        if (!historyScrollSentinel) return;
        historyScrollSentinel.textContent = message;
    }

    function normalizeProfileValue(val) {
        if (!val) return '';
        return val.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
    }

    function highlightHistoryRow(ticker) {
        const rows = document.querySelectorAll('#history-table-body tr.history-table-row');
        rows.forEach(row => {
            if (!ticker) {
                row.classList.remove('active');
                return;
            }
            if (row.dataset.historyTicker === ticker) {
                row.classList.add('active');
            } else {
                row.classList.remove('active');
            }
        });
    }

    function formatCurrency(val) {
        if (val === null || val === undefined || Number.isNaN(val)) return '-';
        const num = typeof val === 'number' ? val : parseFloat(val);
        if (Number.isNaN(num)) return '-';
        return '$' + num.toFixed(2);
    }

    function formatNumber(val) {
        if (val === null || val === undefined || Number.isNaN(val)) return '-';
        const num = typeof val === 'number' ? val : parseFloat(val);
        if (Number.isNaN(num)) return '-';
        return num.toLocaleString();
    }

    function formatPercent(val) {
        if (val === null || val === undefined || Number.isNaN(val)) return '-';
        const num = typeof val === 'number' ? val : parseFloat(val);
        if (Number.isNaN(num)) return '-';
        return (num >= 0 ? '+' : '') + num.toFixed(2) + '%';
    }

    function setHistoryAnalysisLoading(ticker) {
        if (!historyAnalysisBody) return;
        historyAnalysisBody.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0">${ticker}</h5>
                    <small class="text-muted">Requesting full analysis‚Ä¶</small>
                </div>
                <div class="spinner-border text-info" role="status" style="width: 1.6rem; height: 1.6rem;"></div>
            </div>
        `;
        historyAnalysisCard?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderListMarkup(items, emptyCopy = 'No data.') {
        if (!Array.isArray(items) || !items.length) {
            return `<li class="text-muted">${emptyCopy}</li>`;
        }
        return items
            .map(item => `<li>${item}</li>`)
            .join('');
    }

    function ensureArray(val) {
        if (Array.isArray(val)) return val;
        if (val === undefined || val === null || val === '') return [];
        return [val];
    }

    async function loadHistoryDeepDive(ticker) {
        if (!ticker) return;
        activeHistoryTicker = ticker;
        highlightHistoryRow(ticker);
        setHistoryAnalysisLoading(ticker);

        try {
            const resp = await fetch('/api/history/deep-dive', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker })
            });
            const result = await resp.json();
            if (!result.success) {
                historyAnalysisBody.innerHTML = `
                    <p class="text-danger small mb-0">
                        Unable to load AI analysis: ${result.error || 'Unknown error'}.
                    </p>
                `;
                return;
            }
            renderHistoryDeepDive(result.data || {});
        } catch (err) {
            console.error('History deep dive error', err);
            if (historyAnalysisBody) {
                historyAnalysisBody.innerHTML = `
                    <p class="text-danger small mb-0">Network error requesting analysis.</p>
                `;
            }
        }
    }

    function renderMomentumCards(momentumItems) {
        if (!Array.isArray(momentumItems) || !momentumItems.length) {
            return '<p class="text-muted small mb-0">No momentum signals highlighted.</p>';
        }
        return `
            <div class="row g-2">
                ${momentumItems.map(item => `
                    <div class="col-12 col-md-6">
                        <div class="border rounded-3 p-2 h-100">
                            <div class="small text-muted">${item.indicator || 'Indicator'}</div>
                            <div class="fw-semibold">${item.reading || 'n/a'}</div>
                            <div class="small text-${(item.bias || '').toLowerCase() === 'bullish' ? 'success' : (item.bias || '').toLowerCase() === 'bearish' ? 'danger' : 'muted'}">
                                ${item.bias || ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderHistoryDeepDive(payload) {
        if (!historyAnalysisBody) return;
        const ticker = payload.ticker || activeHistoryTicker || '';
        const snapshot = payload.snapshot || {};
        const analysis = payload.analysis || {};
        const stance = (analysis.stance || 'neutral').toLowerCase();
        const stanceClass = stance === 'bullish'
            ? 'badge-stance-bullish'
            : stance === 'bearish'
                ? 'badge-stance-bearish'
                : 'badge-stance-neutral';

        const levels = analysis.levels || {};
        const volumeNotes = analysis.volume || {};
        const actionPlan = analysis.action_plan || {};
        const entries = ensureArray(actionPlan.entries);
        const targets = ensureArray(actionPlan.targets);
        const stops = ensureArray(actionPlan.stops);

        historyAnalysisBody.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0">${ticker}</h5>
                    <span class="badge ${stanceClass} text-uppercase small">${analysis.stance || 'NEUTRAL'}</span>
                </div>
                <div class="text-end small text-muted">
                    Current: ${formatCurrency(snapshot.current)}<br>
                    Change: ${formatPercent(snapshot.change_pct)}
                </div>
            </div>

            <p class="small mb-3">${analysis.summary || 'No AI summary returned.'}</p>

            <div class="row g-3 mb-3">
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Open</div>
                    <div class="fw-semibold">${formatCurrency(snapshot.open)}</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">High / Low</div>
                    <div class="fw-semibold">${formatCurrency(snapshot.high)} / ${formatCurrency(snapshot.low)}</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">10d / 30d Avg Vol</div>
                    <div class="fw-semibold">
                        ${formatNumber(snapshot.avg_volume_10d)} / ${formatNumber(snapshot.avg_volume_30d)}
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Market Cap</div>
                    <div class="fw-semibold">${formatNumber(snapshot.market_cap)}</div>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Catalysts</h6>
                <ul class="small mb-0">
                    ${renderListMarkup(analysis.catalysts, 'No catalysts highlighted.')}
                </ul>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12 col-lg-6">
                    <h6 class="mb-1">Support Levels</h6>
                    <ul class="small mb-2">
                        ${renderListMarkup(levels.support_zones, 'No support zones noted.')}
                    </ul>
                    <p class="small mb-0"><strong>Immediate:</strong> ${levels.immediate_support || 'n/a'}</p>
                </div>
                <div class="col-12 col-lg-6">
                    <h6 class="mb-1">Resistance Levels</h6>
                    <ul class="small mb-2">
                        ${renderListMarkup(levels.resistance_zones, 'No resistance zones noted.')}
                    </ul>
                    <p class="small mb-0"><strong>Immediate:</strong> ${levels.immediate_resistance || 'n/a'}</p>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Momentum & Indicators</h6>
                ${renderMomentumCards(analysis.momentum)}
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Volume Context</h6>
                <p class="small mb-1">${volumeNotes.today_vs_avg || 'No volume comparison.'}</p>
                <p class="small text-muted mb-0">${volumeNotes.notes || ''}</p>
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Action Plan</h6>
                <p class="small mb-1"><strong>Bias:</strong> ${actionPlan.bias || 'n/a'}</p>
                <p class="small mb-1"><strong>Entries:</strong> ${entries.join(', ') || 'n/a'}</p>
                <p class="small mb-1"><strong>Targets:</strong> ${targets.join(', ') || 'n/a'}</p>
                <p class="small mb-0"><strong>Stops:</strong> ${stops.join(', ') || 'n/a'}</p>
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Future View</h6>
                <p class="small mb-0">${analysis.future_view || 'No forward-looking commentary.'}</p>
            </div>

            <div class="mb-3">
                <h6 class="mb-1">Risk Notes</h6>
                <p class="small mb-0">${analysis.risk_notes || 'Risks not provided.'}</p>
            </div>

            <p class="text-muted small mb-0">${analysis.disclaimer || 'This is not personalized financial advice.'}</p>
        `;
        historyAnalysisCard?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    function renderHistoryTable(rows) {
        if (!historyTableBody) return;
        if (!rows.length) {
            activeHistoryTicker = '';
            const message = historyRowsRaw.length
                ? 'No matches for the current filters.'
                : 'No alerts recorded yet. Run the scanner to build history.';
            historyTableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-muted py-3">
                        ${message}
                    </td>
                </tr>
            `;
            updateHistoryScrollHint(historyRowsRaw.length ? 'Refine your filters.' : 'No history yet.');
            return;
        }

        historyTableBody.innerHTML = '';
        rows.forEach(r => {
            const ticker = r.ticker || '';
            const alerts = r.alerts || 0;
            const lastProfile = r.last_profile || '';
            const lastModelVariant = (r.last_model_variant || '').toString().toLowerCase();
            const lastModelRaw = r.last_model || '';
            const modelLabel = lastModelVariant
                ? (MODEL_LABELS[lastModelVariant] || lastModelRaw || lastModelVariant)
                : (lastModelRaw || '');
            const profileCell = modelLabel
                ? `${lastProfile}<div class="text-muted small">${modelLabel}</div>`
                : lastProfile;
            const lastTier = r.last_tier || '';
            const lastEntryNum = coerceNumber(r.last_entry);
            const lastEntry = lastEntryNum === null ? '-' : lastEntryNum.toFixed(2);
            const lastAiEntryNum = coerceNumber(r.last_ai_entry);
            const aiTargetVal = r.last_ai_target_price;
            const aiGainVal = r.last_ai_potential_gain_pct;
            const currentPriceVal = coerceNumber(r.current_price);
            const fallbackPriceVal = coerceNumber(r.last_scan_price);
            const priceForDisplay = currentPriceVal ?? fallbackPriceVal;
            const pctVal = coerceNumber(r.current_change_pct);
            const fallbackPctVal = coerceNumber(r.last_known_change_pct);
            const pctForDisplay = pctVal ?? fallbackPctVal;
            const aiTarget = (typeof aiTargetVal === 'number')
                ? aiTargetVal.toFixed(2)
                : (aiTargetVal || '-');
            const aiGain = (typeof aiGainVal === 'number')
                ? aiGainVal.toFixed(2) + '%'
                : (typeof aiGainVal === 'string' && aiGainVal.trim().length ? aiGainVal : '-');
            const firstDate = r.first_date || '';
            const lastDate = r.last_date || '';

            const priceCell = priceForDisplay === null
                ? '-'
                : '$' + priceForDisplay.toFixed(2);
            const pctCell = pctForDisplay === null
                ? '-'
                : `${pctForDisplay >= 0 ? '+' : ''}${pctForDisplay.toFixed(2)}%`;
            const entryPrimary = lastEntry === '-' ? '-' : '$' + lastEntry;
            const entrySecondary = lastAiEntryNum === null
                ? ''
                : `<div class="text-muted small">AI $${lastAiEntryNum.toFixed(2)}</div>`;

            const tr = document.createElement('tr');
            tr.classList.add('history-table-row');
            tr.dataset.historyTicker = ticker;
            tr.innerHTML = `
                <td><span class="ticker-chip">${ticker}</span></td>
                <td>${alerts}</td>
                <td>${profileCell}</td>
                <td>${lastTier}</td>
                <td>${entryPrimary}${entrySecondary}</td>
                <td>${aiTarget === '-' ? '-' : '$' + aiTarget}</td>
                <td>${aiGain}</td>
                <td>${priceCell}</td>
                <td>${pctCell}</td>
                <td>${firstDate}</td>
                <td>${lastDate}</td>
            `;
            tr.addEventListener('click', () => {
                loadHistoryDeepDive(ticker);
            });
            if (activeHistoryTicker && ticker === activeHistoryTicker) {
                tr.classList.add('active');
            }
            historyTableBody.appendChild(tr);
        });
        highlightHistoryRow(activeHistoryTicker);
    }

    function clearHistoryQuoteState() {
        historyQuoteCache.clear();
        historyRowsRaw.forEach(row => {
            row.current_price = null;
            row.current_change_pct = null;
        });
    }

    function queueHistoryQuoteFetch(force = false, preferredRows = null) {
        if (!historyLiveQuotesEnabled || !historyVisibleRows.length || historyQuoteInflight) return;

        const now = Date.now();
        const tickers = [];
        const seen = new Set();
        const primary = Array.isArray(preferredRows) && preferredRows.length ? preferredRows : historyVisibleRows;
        const secondary = primary === historyVisibleRows ? [] : historyVisibleRows;

        const collectTickers = (rows) => {
            rows.forEach(row => {
                const ticker = row.ticker;
                if (!ticker || seen.has(ticker)) return;
                const cached = historyQuoteCache.get(ticker);
                if (!force && cached && now - cached.fetchedAt < HISTORY_QUOTE_TTL_MS) {
                    return;
                }
                seen.add(ticker);
                tickers.push(ticker);
            });
        };

        collectTickers(primary);
        if (tickers.length < HISTORY_MAX_QUOTE_BATCH && secondary.length) {
            collectTickers(secondary);
        }

        if (!tickers.length) return;
        fetchHistoryQuotes(tickers.slice(0, HISTORY_MAX_QUOTE_BATCH));
    }

    async function fetchHistoryQuotes(tickers) {
        if (!tickers.length) return;
        historyQuoteInflight = true;
        try {
            const resp = await fetch('/api/history/live-quotes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tickers })
            });
            const result = await resp.json();
            if (!result.success) return;

            const now = Date.now();
            for (const item of (result.data || [])) {
                const ticker = (item.ticker || '').toString().trim().toUpperCase();
                if (!ticker) continue;
                const priceVal = coerceNumber(item.current_price);
                historyQuoteCache.set(ticker, { price: priceVal, fetchedAt: now });
                const row = historyRowLookup.get(ticker);
                if (!row) continue;
                row.current_price = priceVal;
                let entryVal = coerceNumber(row.last_entry);
                if (entryVal === null) entryVal = coerceNumber(row.last_scan_price);
                if (entryVal === null) entryVal = coerceNumber(row.last_ai_entry);
                if (priceVal !== null && entryVal !== null && entryVal !== 0) {
                    const pct = ((priceVal - entryVal) / entryVal) * 100;
                    row.current_change_pct = Number(pct.toFixed(2));
                } else {
                    row.current_change_pct = null;
                }
            }
            renderHistoryTable(historyVisibleRows);
        } catch (err) {
            console.error('History live quotes error', err);
        } finally {
            historyQuoteInflight = false;
        }
    }

    function setupHistoryScrollObserver() {
        if (!historyScrollSentinel || !('IntersectionObserver' in window)) return;
        const observer = new IntersectionObserver(entries => {
            if (!entries.some(entry => entry.isIntersecting)) return;
            if (historyLoadingMore || historyExhausted || !historyFilteredRows.length) return;
            renderNextHistoryChunk();
        }, { root: null, threshold: 0.1 });
        observer.observe(historyScrollSentinel);
    }

    function updateHistoryCount(visibleCount) {
        if (!historyResultsCount) return;
        const total = historyFilteredRows.length || historyRowsRaw.length;
        if (!total) {
            historyResultsCount.textContent = 'No history yet';
            return;
        }
        const safeVisible = Math.min(visibleCount, total);
        historyResultsCount.textContent = `Showing ${safeVisible} / ${total}`;
    }

    function updateSortIndicators() {
        historySortableHeaders.forEach(header => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            if (header.dataset.historySort === historySort.key) {
                header.classList.add(
                    historySort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc'
                );
            }
        });
    }

    function resetHistoryFilters() {
        historyFilters.search = '';
        historyFilters.profile = '';
        historyFilters.tier = '';
        if (historySearchInput) historySearchInput.value = '';
        if (historyProfileFilter) historyProfileFilter.value = '';
        if (historyTierFilter) historyTierFilter.value = '';
        applyHistoryFilters();
    }

    setupHistoryScrollObserver();

    historySearchInput?.addEventListener('input', (event) => {
        historyFilters.search = event.target.value.trim().toLowerCase();
        applyHistoryFilters();
    });

    historyProfileFilter?.addEventListener('change', (event) => {
        historyFilters.profile = event.target.value ? event.target.value.toLowerCase() : '';
        applyHistoryFilters();
    });

    historyTierFilter?.addEventListener('change', (event) => {
        historyFilters.tier = event.target.value ? event.target.value.toLowerCase() : '';
        applyHistoryFilters();
    });

    historyLiveQuotesToggle?.addEventListener('change', () => {
        historyLiveQuotesEnabled = historyLiveQuotesToggle.checked;
        if (!historyLiveQuotesEnabled) {
            clearHistoryQuoteState();
            renderHistoryTable(historyVisibleRows);
            return;
        }
        queueHistoryQuoteFetch(true);
    });

    historyResetFiltersBtn?.addEventListener('click', () => {
        resetHistoryFilters();
    });

    historySortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.historySort;
            if (!key) return;
            if (historySort.key === key) {
                historySort.direction = historySort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                historySort.key = key;
                historySort.direction = historyAscDefaultSortKeys.has(key) ? 'asc' : 'desc';
            }
            applyHistoryFilters();
        });
    });

    historyTab?.addEventListener('shown.bs.tab', () => {
        fetchHistorySummary();
    });
    if (historyTab?.classList.contains('active')) {
        fetchHistorySummary();
    }

    historySubtabBreakout?.addEventListener('shown.bs.tab', () => {
        fetchBreakoutEvents();
    });
    historySubtabAI?.addEventListener('shown.bs.tab', () => {
        fetchAiHistory();
    });

    // ------------- Breakout history tab -------------
    const breakoutHistoryTab = document.getElementById('breakout-history-tab');
    const breakoutEventsBody = document.getElementById('breakoutEventsBody');
    const breakoutRefreshBtn = document.getElementById('breakoutRefreshBtn');
    const breakoutStatus = document.getElementById('breakoutStatus');
    let breakoutEvents = [];

    function setBreakoutStatus(text, isError = false) {
        if (!breakoutStatus) return;
        breakoutStatus.textContent = text;
        breakoutStatus.className = `text-${isError ? 'danger' : 'muted'} small`;
    }

    function renderBreakoutTable() {
        if (!breakoutEventsBody) return;
        breakoutEventsBody.innerHTML = '';
        if (!Array.isArray(breakoutEvents) || !breakoutEvents.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 12;
            td.className = 'text-center text-muted py-3';
            td.textContent = 'No breakout events yet.';
            tr.appendChild(td);
            breakoutEventsBody.appendChild(tr);
            return;
        }
        breakoutEvents.forEach(ev => {
            const tr = document.createElement('tr');
            const sig = ev.signal || {};
            const cells = [
                formatEST(ev.bar_time),
                ev.symbol || '',
                ev.timeframe || '',
                ev.event || '',
                formatNumber(ev.trigger_price),
                formatNumber(ev.close),
                ev.relative_volume != null ? ev.relative_volume.toFixed(2) : '',
                ev.structure || '',
                sig.signal || '',
                sig.entry != null ? Number(sig.entry).toFixed(2) : '',
                sig.stop != null ? Number(sig.stop).toFixed(2) : '',
                sig.target != null ? Number(sig.target).toFixed(2) : ''
            ];
            cells.forEach(text => {
                const td = document.createElement('td');
                td.textContent = text || '-';
                tr.appendChild(td);
            });
            breakoutEventsBody.appendChild(tr);
        });
    }

    async function fetchBreakoutEvents() {
        setBreakoutStatus('Loading...');
        try {
            const resp = await fetch('/api/breakouts/events?limit=100');
            if (!resp.ok) {
                setBreakoutStatus('Failed to load', true);
                return;
            }
            const payload = await resp.json();
            breakoutEvents = payload?.data || [];
            setBreakoutStatus(`Loaded ${breakoutEvents.length}`);
            renderBreakoutTable();
        } catch (err) {
            console.error('breakout history error', err);
            setBreakoutStatus('Error', true);
        }
    }

    breakoutRefreshBtn?.addEventListener('click', () => fetchBreakoutEvents());
    breakoutHistoryTab?.addEventListener('shown.bs.tab', () => {
        if (!breakoutEvents.length) {
            fetchBreakoutEvents();
        }
    });
    if (breakoutHistoryTab?.classList.contains('active')) {
        fetchBreakoutEvents();
    }

    // ------------- Persist active tab across reloads -------------
    const tabLinks = document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]');
    tabLinks.forEach(btn => {
        btn.addEventListener('shown.bs.tab', (event) => {
            const target = event.target?.getAttribute('data-bs-target');
            if (target) {
                localStorage.setItem('activeTabId', target);
            }
        });
    });
    const savedTabId = localStorage.getItem('activeTabId');
    if (savedTabId) {
        const trigger = document.querySelector(`#mainTabs button[data-bs-target="${savedTabId}"]`);
        if (trigger) {
            const tab = new bootstrap.Tab(trigger);
            tab.show();
        }
    }

    // ------------- AI Signals tab logic -------------
    const aiSignalForm = document.getElementById('aiSignalForm');
    const runSignalBtn = document.getElementById('runSignalBtn');
    const noSignalCard = document.getElementById('noSignalCard');
    const latestSignalCard = document.getElementById('latestSignalCard');
    const refreshSignalsBtn = document.getElementById('refreshSignalsBtn');
    const signalsTableBody = document.getElementById('signalsTableBody');
    const technicalSnapshotBtn = document.getElementById('technicalSnapshotBtn');
    const technicalSnapshotBody = document.getElementById('technicalSnapshotBody');

    function setLatestSignalCard(sig) {
        if (!sig || !sig.signal) {
            noSignalCard.style.display = 'block';
            latestSignalCard.style.display = 'none';
            return;
        }
        noSignalCard.style.display = 'none';
        latestSignalCard.style.display = 'block';

        document.getElementById('latestSignalTitle').textContent = `${sig.symbol || ''} ‚Ä¢ ${sig.timeframe || ''}`;
        document.getElementById('latestSignalModeBadge').textContent = `${sig.mode || ''} ‚Ä¢ ${sig.analysis_mode || ''}`;

        const strengthBadge = document.getElementById('latestSignalStrengthBadge');
        strengthBadge.textContent = sig.signal || '';
        strengthBadge.className = 'badge';
        if (sig.signal === 'strong_buy') strengthBadge.classList.add('bg-success');
        else if (sig.signal === 'buy') strengthBadge.classList.add('bg-primary');
        else if (sig.signal === 'hold') strengthBadge.classList.add('bg-secondary');
        else if (sig.signal === 'sell') strengthBadge.classList.add('bg-warning');
        else if (sig.signal === 'strong_sell') strengthBadge.classList.add('bg-danger');
        else strengthBadge.classList.add('bg-light', 'text-dark');

        document.getElementById('latestSignalConfidence').textContent = `Confidence: ${sig.confidence ?? 0}%`;
        document.getElementById('latestSignalEntry').textContent = sig.entry != null ? Number(sig.entry).toFixed(2) : '-';
        document.getElementById('latestSignalStop').textContent = sig.stop != null ? Number(sig.stop).toFixed(2) : '-';
        document.getElementById('latestSignalTarget').textContent = sig.target != null ? Number(sig.target).toFixed(2) : '-';
        document.getElementById('latestSignalRR').textContent = sig.rr_ratio != null ? Number(sig.rr_ratio).toFixed(2) : '-';
        document.getElementById('latestSignalHorizon').textContent = sig.time_horizon || '-';
        document.getElementById('latestSignalReason').textContent = sig.reason_short || '';
        document.getElementById('latestSignalUpdatedAt').textContent = formatEST(sig.created_at);
    }

    async function fetchLatestSignal() {
        const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
        const mode = document.querySelector("input[name='modeRadio']:checked")?.value || 'day';
        const analysis_mode = document.querySelector("input[name='analysisRadio']:checked")?.value || 'technical';
        if (!symbol) return;
        const params = new URLSearchParams({ symbol, mode, analysis_mode });
        const resp = await fetch(`/signals/latest?${params.toString()}`);
        if (!resp.ok) {
            setLatestSignalCard(null);
            return;
        }
        const payload = await resp.json();
        setLatestSignalCard(payload?.data);
    }

    async function fetchRecentSignals() {
        try {
            const resp = await fetch('/signals/recent?limit=50');
            if (!resp.ok) return;
            const rows = await resp.json();
            renderSignalsTable(rows);
        } catch (err) {
            console.error('recent signals error', err);
        }
    }

    function renderSignalsTable(rows) {
        signalsTableBody.innerHTML = '';
        if (!Array.isArray(rows) || !rows.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 10;
            td.className = 'text-center text-muted small py-3';
            td.textContent = 'No signals yet.';
            tr.appendChild(td);
            signalsTableBody.appendChild(tr);
            return;
        }
        rows.forEach(sig => {
            const tr = document.createElement('tr');
            const cells = [
                formatEST(sig.created_at),
                sig.symbol || '',
                sig.mode || '',
                sig.analysis_mode || '',
                sig.signal || '',
                sig.entry != null ? Number(sig.entry).toFixed(2) : '-',
                sig.stop != null ? Number(sig.stop).toFixed(2) : '-',
                sig.target != null ? Number(sig.target).toFixed(2) : '-',
                sig.rr_ratio != null ? Number(sig.rr_ratio).toFixed(2) : '-',
                sig.confidence != null ? `${sig.confidence}%` : '-',
            ];
            cells.forEach(text => {
                const td = document.createElement('td');
                td.textContent = text;
                tr.appendChild(td);
            });
            signalsTableBody.appendChild(tr);
        });
    }

    async function runSignalRequest() {
        const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
        const timeframe = document.getElementById('timeframeInput').value;
        const mode = document.querySelector("input[name='modeRadio']:checked")?.value || 'day';
        const analysis_mode = document.querySelector("input[name='analysisRadio']:checked")?.value || 'technical';
        if (!symbol) return;
        runSignalBtn.disabled = true;
        runSignalBtn.textContent = 'Running...';
        try {
            const resp = await fetch('/signals/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol, timeframe, mode, analysis_mode })
            });
            if (!resp.ok) {
                alert('Error: Unable to run AI signal.');
                return;
            }
            const payload = await resp.json();
            setLatestSignalCard(payload?.data);
            await fetchRecentSignals();
        } catch (err) {
            console.error('run signal error', err);
            alert('Error calling /signals/run');
        } finally {
            runSignalBtn.disabled = false;
            runSignalBtn.textContent = 'Run AI Signal';
        }
    }

    aiSignalForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        runSignalRequest();
    });

    refreshSignalsBtn?.addEventListener('click', () => {
        fetchRecentSignals();
        fetchLatestSignal();
    });

    const aiSignalsTab = document.getElementById('ai-signals-tab');
    aiSignalsTab?.addEventListener('shown.bs.tab', () => {
        fetchRecentSignals();
        fetchLatestSignal();
    });

    async function loadTechnicalSnapshot() {
        if (!technicalSnapshotBody) return;
        technicalSnapshotBody.innerHTML = '<p class="small text-muted mb-0">Loading...</p>';
        try {
            const resp = await fetch('/technical/latest');
            if (!resp.ok) {
                technicalSnapshotBody.innerHTML = '<p class="text-danger small mb-0">Failed to load snapshot.</p>';
                return;
            }
            const payload = await resp.json();
            const data = payload?.data;
            if (!data) {
                technicalSnapshotBody.innerHTML = '<p class="small text-muted mb-0">No persisted technical payload yet.</p>';
                return;
            }
            const ctx = data.payload || {};
            const summary = `
                <div class="small text-muted mb-2">Received: ${formatEST(data.received_at) || '-'} | Bar: ${formatEST(data.bar_time) || '-'}</div>
                <div><strong>${data.symbol || ''} ‚Ä¢ ${data.timeframe || ''}</strong></div>
                <div class="small mt-2">
                    <div>Trend: ${ctx.trend ? JSON.stringify(ctx.trend) : '-'}</div>
                    <div>Momentum: ${ctx.momentum ? JSON.stringify(ctx.momentum) : '-'}</div>
                    <div>Volatility: ${ctx.volatility ? JSON.stringify(ctx.volatility) : '-'}</div>
                    <div>Volume: ${ctx.volume_info ? JSON.stringify(ctx.volume_info) : '-'}</div>
                    <div>Session: ${ctx.session ? JSON.stringify(ctx.session) : '-'}</div>
                    <div>Risk: ${ctx.risk_settings ? JSON.stringify(ctx.risk_settings) : '-'}</div>
                </div>
            `;
            technicalSnapshotBody.innerHTML = summary;
        } catch (err) {
            console.error('technical snapshot error', err);
            technicalSnapshotBody.innerHTML = '<p class="text-danger small mb-0">Error loading snapshot.</p>';
        }
    }

    technicalSnapshotBtn?.addEventListener('click', () => loadTechnicalSnapshot());

    function formatEST(isoString) {
        if (!isoString) return '';
        try {
            const dt = new Date(isoString);
            return new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(dt);
        } catch (err) {
            return isoString;
        }
    }

    // No auto load for scanner/news; you trigger them manually with buttons.
</script>
</body>
</html>
